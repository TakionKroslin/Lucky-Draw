<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>别紧张</title>
    <link rel="icon" href="https://pic1.imgdb.cn/item/693d67f925ec9c13612be403.jpg" type="image/jpeg">
    
    <style>
        /* --- 全局样式 --- */
        body {
            margin: 0;
            padding: 0;
            /* 增强的浅墨绿色渐变背景（自上而下），更明显的底色以衬托半透明组件 */
            background: linear-gradient(180deg, #ffffff 0%, rgba(29, 116, 77, 0.863) 100%);
            background-size: 200% 200%;
            animation: subtleFlow 20s linear infinite;
            color: var(--text-main);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Helvetica Neue", Helvetica, Arial, sans-serif;
            height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-between; 
            overflow: hidden;
            perspective: 1000px;
        }

        :root {
            --glass-alpha: 0.50;
            --glass-blur: 6px;
            --radius-pill: 100px;
            --radius-card: 40px;
            --radius-panel: 24px;
            --dur-fast: 0.2s;
            --dur-mid: 0.3s;
            --dur-slow: 0.45s;
            --ease-smooth: cubic-bezier(0.22, 1, 0.36, 1);
            --text-main: #111;
            --text-muted: #666;
            --border-soft: rgba(0,0,0,0.06);
            --shadow-soft: 0 6px 14px rgba(0,0,0,0.08);
            --shadow-card: 0 12px 26px rgba(0,0,0,0.08);
            --avatar-size: 200px;
            --ui-bg: rgba(255,255,255,var(--glass-alpha));
            --ui-border: rgba(255,255,255,0.62);
            --ui-shadow: 0 14px 30px rgba(7, 30, 20, 0.18);
            --ui-glow: 0 0 28px rgba(128, 236, 196, 0.24);
        }

        html, body, body * {
            user-select: none;
            -webkit-user-select: none;
            cursor: default;
        }
        button, a, .filter-option, #btn-filter, #fp-launch, .avatar-container {
            cursor: pointer;
        }

        /* 背景柔和光斑（由 JS 定期调整 transform，产生随机平滑漂浮） */
        .bg-dots { position: fixed; inset: 0; z-index: 0; pointer-events: none; overflow: hidden; }
        .bg-dot { position: absolute; border-radius: 50%; filter: blur(36px); mix-blend-mode: screen; opacity: 0.9; transition: transform 10s cubic-bezier(0.22,0.7,0.3,1); }
        .bg-dot.a { width: 300px; height: 300px; left: -14%; top: 6%;
            background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.32) 0%, rgba(0,140,80,0.36) 28%, rgba(0,110,65,0.22) 45%, transparent 62%);
            filter: blur(36px);
            box-shadow: 0 0 160px rgba(0,140,80,0.46);
            mix-blend-mode: screen;
        }
        .bg-dot.b { width: 380px; height: 380px; left: 6%; top: 58%;
            background: radial-gradient(circle at 40% 40%, rgba(255,255,255,0.28) 0%, rgba(0,120,70,0.30) 30%, rgba(0,95,60,0.18) 48%, transparent 66%);
            filter: blur(34px);
            box-shadow: 0 0 140px rgba(0,120,70,0.40);
            mix-blend-mode: screen;
        }
        .bg-dot.c { width: 280px; height: 280px; right: -8%; top: 26%;
            background: radial-gradient(circle at 25% 35%, rgba(255,255,255,0.30) 0%, rgba(0,130,75,0.32) 30%, rgba(0,100,60,0.20) 48%, transparent 66%);
            filter: blur(34px);
            box-shadow: 0 0 150px rgba(0,130,75,0.42);
            mix-blend-mode: screen;
        }

        /* 通用低调 hover glow（以鼠标为中心的柔和光晕） */
        .glass-hover-target { position: relative; --mx:50%; --my:50%; }
        .glass-hover-target::before {
            content: '';
            position: absolute; left: 0; top: 0; right: 0; bottom: 0; pointer-events: none; border-radius: inherit;
            background: radial-gradient(circle at var(--mx,50%) var(--my,50%), rgba(255,255,255,0.80) 0%, rgba(200,255,220,0.20) 16%, rgba(60,220,140,0.10) 30%, transparent 60%);
            opacity: 0; transition: opacity 120ms ease, transform 120ms ease; mix-blend-mode: screen;
            filter: blur(12px) saturate(1.15) contrast(1.08);
        }
        .glass-hover-target:hover::before { opacity: 1; }

        @keyframes subtleFlow {
            0% { background-position: 0% 0%; }
            50% { background-position: 100% 100%; }
            100% { background-position: 0% 0%; }
        }

        .main-content {
            flex-grow: 1; 
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 100%;
            position: relative;
            z-index: 10;
        }

        /* --- 过滤器样式 --- */
        .filter-container {
            position: relative;
            z-index: 1000;
            margin-bottom: 20px;
            display: flex; 
        }
        .filter-container.compact-hidden { display: none !important; }

        #btn-filter {
            background-color: rgba(255, 255, 255, var(--glass-alpha));
            color: #000;
            border: 1px solid rgba(255, 255, 255, var(--glass-alpha));
            padding: 10px 24px;
            min-width: 120px;
            font-size: 15px;
            border-radius: var(--radius-pill);
            cursor: pointer;
            transition: all var(--dur-fast) ease;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        #btn-filter:hover {
            background-color: rgba(230, 230, 230, var(--glass-alpha));
            box-shadow: 0 4px 10px rgba(0,0,0,0.06);
            transform: translateY(-1px);
        }

        #btn-filter.active {
            color: #fff;
            border-color: rgba(76,175,80,0.18);
            box-shadow: 0 10px 28px rgba(76,175,80,0.06);
        }
        #btn-filter.active::before {
            /* active 时给 ::before 一个更暖的高光并保持可见 */
            background: radial-gradient(circle at var(--mx,50%) var(--my,50%), rgba(255,255,255,0.48) 0%, rgba(160,255,180,0.16) 20%, rgba(70,230,140,0.08) 38%, transparent 60%);
            opacity: 1;
            filter: blur(4px) saturate(1.08);
            mix-blend-mode: screen;
            box-shadow: 0 6px 30px rgba(50,200,120,0.12) inset;
        }

        .filter-menu {
            position: absolute;
            top: calc(100% + 10px); 
            left: 50%;
            transform: translateX(-50%) translateY(-10px);
            background: rgba(255,255,255,var(--glass-alpha));
            border: 1px solid rgba(0,0,0,0.04);
            border-radius: 16px;
            box-shadow: 0 6px 18px rgba(0,0,0,0.06);
            padding: 6px;
            min-width: 140px;
            opacity: 0;
            visibility: hidden;
            transition: all 0.25s cubic-bezier(0.2, 0.8, 0.2, 1);
        }

        .filter-menu.open {
            opacity: 1;
            visibility: visible;
            transform: translateX(-50%) translateY(0);
        }
        .filter-menu.in-panel {
            position: static;
            top: auto;
            left: auto;
            transform: none !important;
            opacity: 1 !important;
            visibility: visible !important;
            display: grid;
            gap: 8px;
            width: 100%;
            border-radius: 14px;
            background: transparent;
            border: none;
            box-shadow: none;
            pointer-events: auto;
            padding: 0;
            margin-top: 4px;
        }
        .filter-menu.in-panel .filter-separator {
            margin: 4px 0 2px;
            background-color: rgba(255,255,255,0.45);
        }
        .filter-menu.in-panel .filter-option {
            border: 1px solid rgba(255,255,255,0.6);
            border-radius: 12px;
            background: var(--ui-bg);
            box-shadow: var(--ui-shadow);
        }
        .filter-menu.in-panel .filter-option.selected {
            color: #fff !important;
            box-shadow: var(--ui-shadow), 0 0 18px rgba(104, 236, 180, 0.3);
        }
        .filter-menu.in-panel .filter-option.base-option.selected {
            background-color: rgba(27, 96, 66, 0.86) !important;
        }
        .filter-menu.in-panel .filter-option.bonus-skill.selected {
            background-color: rgba(239, 142, 24, 0.88) !important;
        }
        .filter-menu.in-panel .filter-option.bonus-teacher.selected {
            background-color: rgba(61, 136, 232, 0.88) !important;
        }
        .filter-menu.in-panel .filter-option.instant-option.selected {
            background-color: rgba(220, 73, 73, 0.9) !important;
        }
        .filter-menu.in-panel .filter-option.simple-mode-option.selected {
            background-color: rgba(63, 167, 91, 0.9) !important;
        }

        .filter-option {
            padding: 10px 16px;
            cursor: pointer;
            font-size: 14px;
            color: #333;
            border-radius: 10px;
            text-align: center;
            transition: background-color 0.2s;
            margin-bottom: 2px;
        }

        .filter-option:last-child { margin-bottom: 0; }
        .filter-option:hover { background-color: #f5f5f5; }

        .filter-option.base-option.selected {
            background-color: #000;
            color: #fff;
            font-weight: 600;
        }
        
        .filter-option.bonus-option { color: #333; font-weight: normal; }
        .filter-option.bonus-option:hover { background-color: #f5f5f5; }
        
        .filter-option.bonus-skill.selected {
            background-color: #ff9800; 
            color: #fff;
            font-weight: 600;
        }

        .filter-option.bonus-teacher.selected {
            background-color: #2196f3; 
            color: #fff;
            font-weight: 600;
        }

        .filter-separator {
            height: 1px;
            background-color: #eee;
            margin: 6px 0;
        }

        .filter-option.instant-option {
            color: #d32f2f; 
            font-weight: 600;
        }
        .filter-option.instant-option:hover { background-color: #ffebee; }
        .filter-option.instant-option.selected {
            background-color: #d32f2f;
            color: #fff;
        }

        /* --- 头像区域 --- */
        .top-section {
            height: 220px;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 20px;
        }

        /* 头像容器基础（统一半透明毛玻璃风格，初始为隐藏态，由 `.show` 控制显示） */
        .avatar-container {
            width: var(--avatar-size);
            height: var(--avatar-size);
            border-radius: var(--radius-card);
            overflow: hidden;
            border: 1px solid var(--ui-border);
            background: var(--ui-bg);
            backdrop-filter: blur(var(--glass-blur));
            -webkit-backdrop-filter: blur(var(--glass-blur));
            box-shadow: 0 20px 38px rgba(8, 32, 22, 0.22), inset 0 1px 0 rgba(255,255,255,0.55);
            position: relative;
            user-select: none;
            -webkit-user-select: none;

            /* 初始为收缩/隐藏状态，`.show` 会切换为可见 */
            opacity: 0;
            transform: scale(0) rotate(-45deg);
            transition: transform var(--dur-slow) var(--ease-smooth), opacity var(--dur-slow) ease;
            cursor: pointer;
        }
        .avatar-container::before {
            content: '';
            position: absolute;
            inset: -2px;
            border-radius: inherit;
            pointer-events: none;
            z-index: 2;
            background: radial-gradient(140% 100% at 50% -10%, rgba(255,255,255,0.55) 0%, rgba(255,255,255,0) 58%);
            mix-blend-mode: screen;
            opacity: 0.75;
        }
        
        

        /* --- 学生专属边框 (CSS变量控制颜色) --- */
        .avatar-container.student-border {
            border: none;
            box-shadow: 0 20px 45px rgba(0,0,0,0.16), 0 0 0 1px rgba(255,255,255,0.12) inset;
            background: linear-gradient(160deg, rgba(255,255,255,0.18), rgba(255,255,255,0.03));
            border-radius: var(--radius-card);
            backdrop-filter: blur(5px) saturate(1.15);
            -webkit-backdrop-filter: blur(5px) saturate(1.15);
        }
        .avatar-container.student-border::after {
            content: none;
        }
        .avatar-container.student-border.glow {
            box-shadow:
                0 22px 44px rgba(9, 31, 22, 0.22),
                0 0 26px var(--glow, rgba(54, 201, 136, 0.28)),
                0 0 56px rgba(54, 201, 136, 0.22);
        }
        .avatar-container.teacher-aura {
            box-shadow: 0 22px 44px rgba(9, 31, 22, 0.22), 0 0 28px rgba(89, 168, 255, 0.34), 0 0 62px rgba(89, 168, 255, 0.2);
        }
        .avatar-container.skill-aura {
            box-shadow: 0 22px 44px rgba(9, 31, 22, 0.22), 0 0 30px rgba(255, 190, 79, 0.34), 0 0 60px rgba(255, 145, 30, 0.22);
        }

        /* 正常显示状态 */
        .avatar-container.show {
            opacity: 1;
            transform: scale(1) rotate(0deg);
        }

        /* Hover 光效 */
        .avatar-container:not(.is-tilted):not(.no-hover-effect):hover {
            transform: translateY(-3px) scale(1.015);
            box-shadow: 0 26px 48px rgba(5, 28, 20, 0.26), 0 0 24px rgba(122, 236, 190, 0.24);
        }
        
        .avatar-container.hide-img .avatar-img {
            display: none;
        }

        /* 通用半透明玻璃质感（保留原色调，只作半透明叠加） */
        .glass-surface {
            background: rgba(255,255,255,var(--glass-alpha));
            border: 1px solid rgba(255,255,255,0.18);
            backdrop-filter: blur(var(--glass-blur));
            -webkit-backdrop-filter: blur(var(--glass-blur));
            box-shadow: 0 8px 18px rgba(0,0,0,0.05);
        }

        /* 将页面常用组件设为玻璃质感，但保留其颜色声明（选中颜色会覆盖背景） */
        button.action-btn, #btn-filter, .filter-menu, .filter-option, #btn-reveal, .footer, .avatar-container {
            /* 不强制覆盖颜色，只提供半透明底与模糊效果 */
            background-clip: padding-box;
        }

        /* 为常用块提供轻量级玻璃底（通过 rgba 覆盖原有纯色以实现毛玻璃） */
        button.action-btn {
            background: rgba(0,0,0,var(--glass-alpha));
            border: 1px solid rgba(255,255,255,0.12);
            color: #fff;
            backdrop-filter: blur(var(--glass-blur));
            -webkit-backdrop-filter: blur(var(--glass-blur));
        }

        #btn-filter {
            background: rgba(255,255,255,var(--glass-alpha));
            border: 1px solid var(--border-soft);
            backdrop-filter: blur(var(--glass-blur));
            -webkit-backdrop-filter: blur(var(--glass-blur));
        }

        .filter-menu {
            background: rgba(255,255,255,var(--glass-alpha));
            border: 1px solid var(--border-soft);
            backdrop-filter: blur(var(--glass-blur));
            -webkit-backdrop-filter: blur(var(--glass-blur));
        }

        .filter-option {
            background: transparent; /* 保留颜色声明，hover/selected 会覆盖 */
        }

        /* 使不同选中配色为半透明以展现玻璃感 */
        .filter-option.base-option.selected {
            background-color: rgba(0,0,0,var(--glass-alpha));
            border: 1px solid rgba(255,255,255,var(--glass-alpha));
            backdrop-filter: blur(var(--glass-blur));
            -webkit-backdrop-filter: blur(var(--glass-blur));
        }
        .filter-option.bonus-skill.selected {
            background-color: rgba(255,152,0,var(--glass-alpha));
            border: 1px solid rgba(255,255,255,var(--glass-alpha));
            backdrop-filter: blur(var(--glass-blur));
            -webkit-backdrop-filter: blur(var(--glass-blur));
        }
        .filter-option.bonus-teacher.selected {
            background-color: rgba(33,150,243,var(--glass-alpha));
            border: 1px solid rgba(255,255,255,var(--glass-alpha));
            backdrop-filter: blur(var(--glass-blur));
            -webkit-backdrop-filter: blur(var(--glass-blur));
        }
        .filter-option.instant-option.selected {
            background-color: rgba(211,47,47,0.38);
            border: 1px solid rgba(255,255,255,0.06);
            backdrop-filter: blur(var(--glass-blur));
            -webkit-backdrop-filter: blur(var(--glass-blur));
        }
        .filter-option.simple-mode-option.selected {
            background-color: rgba(76,175,80,0.38);
            border: 1px solid rgba(255,255,255,0.06);
            backdrop-filter: blur(var(--glass-blur));
            -webkit-backdrop-filter: blur(var(--glass-blur));
        }

        /* 悬停使用更轻的半透明覆盖，保持原始配色暗示 */
        .filter-option:hover { background-color: rgba(255,255,255,0.06); }
        .filter-option.instant-option:hover { background-color: rgba(255,235,238,0.12); }
        .filter-option.simple-mode-option:hover { background-color: rgba(165,214,167,0.12); }

        /* （avatar-container 基础样式已在上方统一定义） */

        #btn-reveal {
            background: rgba(255,255,255,var(--glass-alpha));
            border: 1px solid rgba(0,0,0,0.08);
            backdrop-filter: blur(var(--glass-blur));
            -webkit-backdrop-filter: blur(var(--glass-blur));
            color: #000;
        }

        /* --- 技能/老师文字优化 --- */
        .non-person-name {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 4;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center; 
            font-size: 32px; 
            font-weight: 800;
            color: #fff;
            text-shadow: 0 2px 10px rgba(0,0,0,0.3);
            line-height: 1.3;
            padding: 20px; 
            box-sizing: border-box; 
            word-break: break-word; 
        }
        
        .skill-item .non-person-name { background-color: #ff9800; }
        .teacher-item .non-person-name { background-color: #2196f3; }
        
        /* --- 动画特效 (重制版) --- */
        
        /* 1. 普通抽中动画 */
        .avatar-container.card-animate {
            transition: none;
            opacity: 1 !important;
            animation: card-flip 1.05s cubic-bezier(0.2, 0.95, 0.26, 1.15) forwards;
        }
        @keyframes card-flip {
            0% { transform: perspective(1200px) rotateY(-118deg) translateY(30px) scale(0.56); opacity: 0; filter: blur(3px); }
            62% { transform: perspective(1200px) rotateY(24deg) translateY(-6px) scale(1.08); opacity: 1; filter: blur(0); box-shadow: 0 0 18px rgba(146, 236, 202, 0.32); }
            100% { transform: perspective(1200px) rotateY(0deg) translateY(0) scale(1); opacity: 1; }
        }

        /* 2. Legend 动画 */
        .anim-legend {
            transition: none;
            opacity: 1 !important;
            animation: legend-entry 1.12s cubic-bezier(0.16, 1, 0.3, 1) forwards;
            border-color: #ffd98a !important;
            border-width: 5px !important;
        }
        @keyframes legend-entry {
            0% { transform: scale(0.35) rotate(-12deg); opacity: 0; filter: brightness(1.5) saturate(1.3); }
            45% { transform: scale(1.14) rotate(3deg); opacity: 1; box-shadow: 0 0 26px rgba(255,215,122,0.9), 0 0 80px rgba(255,178,44,0.52); }
            75% { transform: scale(0.96) rotate(-1deg); }
            100% { transform: scale(1) rotate(0deg); filter: brightness(1.08); box-shadow: 0 0 22px rgba(255,204,102,0.72), 0 20px 48px rgba(0,0,0,0.18); }
        }

        /* 3. Epic 动画 */
        .anim-epic {
            transition: none;
            opacity: 1 !important;
            animation: epic-entry 1.0s cubic-bezier(0.22, 1, 0.36, 1) forwards;
            border-color: #7e7bff !important;
        }
        @keyframes epic-entry {
            0% { transform: scale(0.42) translateY(30px) rotate(-8deg); opacity: 0; }
            55% { transform: scale(1.1) translateY(-6px) rotate(1deg); opacity: 1; box-shadow: 0 0 28px rgba(117,125,255,0.74), 0 0 70px rgba(130,83,255,0.4); }
            100% { transform: scale(1) translateY(0) rotate(0deg); box-shadow: 0 0 20px rgba(117,125,255,0.58), 0 16px 34px rgba(0,0,0,0.16); }
        }

        /* 4. Rare 动画 */
        .anim-rare {
            transition: none;
            opacity: 1 !important;
            animation: rare-entry 0.92s cubic-bezier(0.2, 0.84, 0.28, 1.25) forwards;
            border-color: #5cc3ff !important;
        }
        @keyframes rare-entry {
            0% { transform: scale(0.58) translateY(16px); opacity: 0; }
            60% { transform: scale(1.08) translateY(-2px); opacity: 1; box-shadow: 0 0 20px rgba(98,193,255,0.74), 0 0 42px rgba(64,165,255,0.4); }
            100% { transform: scale(1) translateY(0); opacity: 1; box-shadow: 0 0 13px rgba(98,193,255,0.6), 0 14px 28px rgba(0,0,0,0.14); }
        }

        .anim-teacher-legend { opacity: 1 !important; animation: teacher-legend 1.52s cubic-bezier(0.2, 1, 0.24, 1) forwards; }
        .anim-teacher-epic { opacity: 1 !important; animation: teacher-epic 1.26s cubic-bezier(0.2, 0.92, 0.28, 1.15) forwards; }
        .anim-teacher-rare { opacity: 1 !important; animation: teacher-rare 0.84s cubic-bezier(0.2, 0.9, 0.28, 1.1) forwards; }
        .anim-skill-legend { opacity: 1 !important; animation: skill-legend 1.48s cubic-bezier(0.2, 1, 0.24, 1) forwards; }
        .anim-skill-epic { opacity: 1 !important; animation: skill-epic 1.22s cubic-bezier(0.2, 0.92, 0.28, 1.15) forwards; }
        .anim-skill-rare { opacity: 1 !important; animation: skill-rare 0.82s cubic-bezier(0.2, 0.9, 0.28, 1.1) forwards; }
        .avatar-container.rarity-legend {
            box-shadow: 0 0 34px rgba(255, 203, 94, 0.88), 0 0 88px rgba(255, 142, 44, 0.42), 0 22px 42px rgba(0,0,0,0.22);
        }
        .avatar-container.rarity-epic {
            box-shadow: 0 0 28px rgba(125, 152, 255, 0.76), 0 0 72px rgba(126, 101, 255, 0.34), 0 18px 38px rgba(0,0,0,0.2);
        }
        .avatar-container.rarity-rare {
            box-shadow: 0 0 20px rgba(94, 198, 255, 0.72), 0 0 44px rgba(95, 174, 255, 0.28), 0 16px 30px rgba(0,0,0,0.18);
        }

        @keyframes teacher-legend {
            0% { transform: perspective(1200px) rotateY(-280deg) rotateX(24deg) scale(0.24) translateY(58px); opacity: 0; filter: brightness(2.4) saturate(1.9); }
            26% { transform: perspective(1200px) rotateY(140deg) rotateX(-10deg) scale(1.36) translateY(-10px); opacity: 1; box-shadow: 0 0 72px rgba(110,192,255,1), 0 0 150px rgba(66,136,255,0.74); }
            54% { transform: perspective(1200px) rotateY(-55deg) rotateX(8deg) scale(0.88) translateY(5px); box-shadow: 0 0 34px rgba(92,170,255,0.86), 0 0 104px rgba(66,136,255,0.56); }
            78% { transform: perspective(1200px) rotateY(20deg) rotateX(-2deg) scale(1.08) translateY(-2px); }
            100% { transform: perspective(1200px) rotateY(0deg) rotateX(0deg) scale(1) translateY(0); box-shadow: 0 0 26px rgba(80,170,255,0.66), 0 20px 40px rgba(0,0,0,0.18); filter: brightness(1.08) saturate(1.18); }
        }
        @keyframes teacher-epic {
            0% { transform: perspective(1100px) rotateY(-200deg) scale(0.3) translateY(42px); opacity: 0; filter: brightness(1.9) saturate(1.55); }
            34% { transform: perspective(1100px) rotateY(95deg) scale(1.28) translateY(-8px); opacity: 1; box-shadow: 0 0 50px rgba(132,156,255,0.9), 0 0 112px rgba(98,108,255,0.5); }
            66% { transform: perspective(1100px) rotateY(-26deg) scale(0.92) translateY(2px); }
            100% { transform: perspective(1100px) rotateY(0deg) scale(1) translateY(0); box-shadow: 0 0 20px rgba(104,155,255,0.58), 0 16px 33px rgba(0,0,0,0.16); filter: brightness(1.04) saturate(1.1); }
        }
        @keyframes teacher-rare {
            0% { transform: perspective(1000px) rotateY(-120deg) scale(0.45) translateY(20px); opacity: 0; filter: brightness(1.6) saturate(1.3); }
            52% { transform: perspective(1000px) rotateY(40deg) scale(1.12) translateY(-3px); opacity: 1; box-shadow: 0 0 24px rgba(113,193,255,0.72), 0 0 52px rgba(90,160,255,0.32); }
            100% { transform: perspective(1000px) rotateY(0deg) scale(1) translateY(0); box-shadow: 0 0 10px rgba(113,193,255,0.5), 0 12px 24px rgba(0,0,0,0.13); filter: brightness(1.02) saturate(1.06); }
        }
        @keyframes skill-legend {
            0% { transform: perspective(1200px) rotateY(-320deg) rotateX(30deg) scale(0.2) translateY(64px); opacity: 0; filter: brightness(2.6) saturate(2); }
            24% { transform: perspective(1200px) rotateY(170deg) rotateX(-12deg) scale(1.42) translateY(-12px); opacity: 1; box-shadow: 0 0 86px rgba(255,206,102,1), 0 0 170px rgba(255,136,36,0.78); }
            52% { transform: perspective(1200px) rotateY(-70deg) rotateX(10deg) scale(0.9) translateY(6px); box-shadow: 0 0 40px rgba(255,186,84,0.9), 0 0 116px rgba(255,136,36,0.58); }
            78% { transform: perspective(1200px) rotateY(24deg) rotateX(-2deg) scale(1.1) translateY(-2px); }
            100% { transform: perspective(1200px) rotateY(0deg) rotateX(0deg) scale(1) translateY(0); box-shadow: 0 0 26px rgba(255,186,84,0.7), 0 20px 40px rgba(0,0,0,0.18); filter: brightness(1.12) saturate(1.2); }
        }
        @keyframes skill-epic {
            0% { transform: perspective(1100px) rotateY(-220deg) scale(0.3) translateY(46px); opacity: 0; filter: brightness(2) saturate(1.65); }
            34% { transform: perspective(1100px) rotateY(105deg) scale(1.32) translateY(-8px); opacity: 1; box-shadow: 0 0 56px rgba(255,175,82,0.92), 0 0 126px rgba(255,118,36,0.58); }
            66% { transform: perspective(1100px) rotateY(-30deg) scale(0.92) translateY(2px); }
            100% { transform: perspective(1100px) rotateY(0deg) scale(1) translateY(0); box-shadow: 0 0 18px rgba(255,170,72,0.6), 0 15px 30px rgba(0,0,0,0.15); filter: brightness(1.05) saturate(1.12); }
        }
        @keyframes skill-rare {
            0% { transform: perspective(1000px) rotateY(-130deg) scale(0.44) translateY(22px); opacity: 0; filter: brightness(1.7) saturate(1.35); }
            52% { transform: perspective(1000px) rotateY(44deg) scale(1.14) translateY(-3px); opacity: 1; box-shadow: 0 0 22px rgba(255,188,95,0.68), 0 0 52px rgba(255,141,54,0.32); }
            100% { transform: perspective(1000px) rotateY(0deg) scale(1) translateY(0); box-shadow: 0 0 9px rgba(255,188,95,0.44), 0 10px 22px rgba(0,0,0,0.12); filter: brightness(1.02) saturate(1.08); }
        }

        /* --- 歪斜/掉钉动画（点击头像触发） --- */
        /* --- 修复代码开始：头像歪头动画 (QQ弹弹 & 掉落) --- */

        /* 状态标记：当有这个类时，禁用默认的 CSS transition，完全由 animation 接管，防止冲突 */
        .is-tilted {
            transition: none !important;
        }

        /* 动作 1: 左歪 (Q弹效果 - 使用贝塞尔曲线模拟弹簧) */
        .tilt-left-anim {
            animation: tilt-bounce-left 0.6s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
        }
        @keyframes tilt-bounce-left {
            0% { transform: rotate(0); }
            40% { transform: rotate(-25deg); } /* 稍微歪过头一点 */
            100% { transform: rotate(-15deg) translateY(10px); } /* 回弹到最终位置 */
        }

        /* 动作 2: 右歪 (Q弹效果) */
        .tilt-right-anim {
            animation: tilt-bounce-right 0.6s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
        }
        @keyframes tilt-bounce-right {
            0% { transform: rotate(0); }
            40% { transform: rotate(25deg); }
            100% { transform: rotate(15deg) translateY(10px); }
        }

        /* 动作 3: 震动 + 掉落 (物理重力感) */
        .tilt-drop-anim {
            animation: tilt-shock-drop 0.8s ease-out forwards;
        }
        @keyframes tilt-shock-drop {
            0% { transform: translate(0, 0) rotate(0); }
            10% { transform: translate(-5px, 0) rotate(-2deg); } /* 震动前摇 */
            20% { transform: translate(5px, 0) rotate(2deg); }
            30% { transform: translate(0, -15px) scale(1.05); } /* 向上抛起 */
            60% { transform: translate(0, 40px) rotate(10deg); } /* 重力下落 */
            80% { transform: translate(0, 35px) rotate(8deg); } /* 落地反弹 */
            100% { transform: translate(0, 40px) rotate(10deg); } /* 静止 */
        }

        /* 恢复动画 (丝滑回正) */
        .tilt-recover-anim {
            animation: tilt-back-smooth 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }
        @keyframes tilt-back-smooth {
            to { transform: rotate(0) translate(0, 0) scale(1); }
        }

        /* --- 修复代码结束 --- */
        /* 临时关闭动画/过渡，避免在恢复时重放抽卡动画 */
        .avatar-container.no-anim {
            animation: none !important;
            transition: none !important;
        }

        /* 收缩并渐出（吸入）——用于开始新一轮抽取时平滑隐藏上一个头像 */
        .avatar-container.shrink-hide {
            transition: transform 0.26s cubic-bezier(0.3, 0.9, 0.35, 1), opacity 0.24s ease;
            transform: scale(0.35) translateY(10px) !important;
            opacity: 0 !important;
        }

        .avatar-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
            transition: opacity var(--dur-mid) ease;
            backface-visibility: hidden;
            -webkit-backface-visibility: hidden;
            transform: translateZ(0);
            filter: saturate(1.05) contrast(1.03);
        }
        .avatar-container.avatar-loading .avatar-img { opacity: 0; }
        .avatar-container.avatar-ready .avatar-img { opacity: 1; }
        .avatar-container.avatar-fallback .avatar-img { opacity: 1; }

        /* 图片与 student-border 的内边框对齐 */
        .avatar-container.student-border .avatar-img {
            border-radius: calc(var(--radius-card) - 4px);
        }
        
        /* --- 中间：名字显示 --- */
        .middle-section {
            margin-bottom: 40px;
            text-align: center;
            height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #name-display {
            font-size: 48px;
            font-weight: 800;
            letter-spacing: 1px;
            padding: 10px 40px;
            border-radius: var(--radius-panel);
            /* 半透明玻璃感背景 */
            background: rgba(250,250,250,var(--glass-alpha));
            border: 1px solid rgba(255,255,255,0.6);
            backdrop-filter: blur(var(--glass-blur));
            -webkit-backdrop-filter: blur(var(--glass-blur));
            min-width: 320px;
            overflow: hidden;
            position: relative;
            color: var(--text-main);
            box-shadow: 0 6px 16px rgba(20,20,20,0.04);
        }

        @keyframes slideOutUp {
            0% { transform: translateY(0); opacity: 1; }
            100% { transform: translateY(-100%); opacity: 0; }
        }
        @keyframes slideInUp {
            0% { transform: translateY(100%); opacity: 0; }
            100% { transform: translateY(0); opacity: 1; }
        }
        .slide-out-up { animation: slideOutUp 0.2s ease-in forwards; }
        .slide-in-up { animation: slideInUp 0.3s ease-out forwards; }

        /* --- 底部按钮区域 --- */
        .bottom-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 16px;
        }

        button.action-btn {
            /* 轻透明毛玻璃主按钮信面（更透明、无重黑边） */
            background: rgba(255,255,255,var(--glass-alpha));
            color: #111;
            border: 1px solid var(--border-soft);
            padding: 16px 48px; 
            font-size: 18px;
            font-weight: 700;
            border-radius: var(--radius-pill);
            cursor: pointer;
            transition: all 0.22s cubic-bezier(0.25, 0.8, 0.25, 1);
            outline: none;
            box-shadow: var(--ui-shadow);
            backdrop-filter: blur(var(--glass-blur));
            -webkit-backdrop-filter: blur(var(--glass-blur));
        }

        button.action-btn:hover {
            background-color: rgba(255,255,255,calc(var(--glass-alpha) + 0.05));
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0,0,0,0.09);
        }

        button.action-btn:active { transform: translateY(0); }
        button.action-btn:disabled {
            background-color: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* 显示原名按钮（使用毛玻璃统一样式） */
        #btn-reveal {
            background: rgba(255,255,255,var(--glass-alpha));
            color: #000;
            border: 1px solid var(--border-soft);
            opacity: 0;
            visibility: hidden;
            transform: translateY(15px);
            transition: all 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            padding: 14px 40px;
            border-radius: var(--radius-pill);
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0,0,0,0.06);
            backdrop-filter: blur(var(--glass-blur));
            -webkit-backdrop-filter: blur(var(--glass-blur));
        }

        #btn-reveal:hover { background-color: rgba(255,255,255,calc(var(--glass-alpha) + 0.05)); }
        .reveal-show {
            opacity: 1 !important;
            visibility: visible !important;
            transform: translateY(0) !important;
        }
        .reveal-hidden {
            opacity: 0 !important;
            visibility: hidden !important;
            pointer-events: none;
        }
        
        /* --- Footer --- */
        .footer {
            width: 100%;
            padding: 12px 0;
            background: var(--ui-bg);
            border: 1px solid rgba(0,0,0,0.04);
            border-top: none;
            text-align: center;
            font-size: 13px;
            color: var(--text-muted);
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 12px;
            backdrop-filter: blur(var(--glass-blur));
            -webkit-backdrop-filter: blur(var(--glass-blur));
            box-shadow: var(--ui-shadow);
        }
        .footer-separator { color: #ddd; font-size: 14px; }
        .footer-github a {
            color: #888;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            transition: color 0.3s;
        }
        .footer-github a:hover { color: #000; }
        .github-icon { width: 18px; height: 18px; fill: currentColor; display: block; }

        /* --- 新增样式 --- */

        /* 简易模式按钮样式 (深灰色，与红色区分) */
        .filter-option.simple-mode-option {
            color: #333;
            font-weight: 600;
        }
        .filter-option.simple-mode-option:hover { background-color: #a5d6a7; }
        .filter-option.simple-mode-option.selected {
            background-color: #4caf50;
            color: #fff;
        }

        /* 简易模式下隐藏头像区域的样式 */
        .top-section {
            /* 加上 transition 实现平滑消失/出现 */
            transition: opacity 0.3s ease, height 0.3s ease, margin 0.3s ease;
        }
        .top-section.hidden-mode {
            opacity: 0;
            height: 0;
            margin-bottom: 0;
            pointer-events: none;
        }

        /* Toast 提示框样式 */
        #toast-msg {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.8);
            color: #fff;
            padding: 12px 24px;
            border-radius: var(--radius-pill);
            font-size: 14px;
            font-weight: 500;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
            pointer-events: none; 
        }
        #toast-msg.show {
            opacity: 1;
            visibility: visible;
        }

        .fp-launch {
            position: fixed !important;
            right: 18px !important;
            bottom: 18px !important;
            z-index: 99999 !important;
            padding: 11px 18px;
            border-radius: var(--radius-pill);
            border: 1px solid var(--ui-border);
            background: var(--ui-bg);
            backdrop-filter: blur(var(--glass-blur));
            color: var(--text-main);
            font-size: 13px;
            font-weight: 700;
            letter-spacing: .08em;
            box-shadow: var(--ui-shadow), var(--ui-glow);
            cursor: pointer;
            transition: transform var(--dur-fast) var(--ease-smooth), box-shadow var(--dur-fast) var(--ease-smooth), background-color var(--dur-fast) var(--ease-smooth);
            isolation: isolate;
        }
        .fp-launch:hover {
            transform: translateY(-2px);
            background: rgba(255, 255, 255, 0.68);
            box-shadow: 0 14px 30px rgba(18, 54, 38, 0.26);
        }
        .fp-launch::after {
            content: '';
            position: absolute;
            inset: -10px;
            border-radius: inherit;
            background: radial-gradient(circle at 50% 50%, rgba(140, 255, 202, 0.36), rgba(140, 255, 202, 0) 65%);
            opacity: 0;
            transform: scale(0.8);
            pointer-events: none;
        }
        .fp-launch.is-open::after {
            animation: fp-launch-pulse 0.9s ease-out;
        }
        @keyframes fp-launch-pulse {
            0% { opacity: 0; transform: scale(0.8); }
            35% { opacity: 1; }
            100% { opacity: 0; transform: scale(1.25); }
        }

        .fp-status {
            position: fixed !important;
            left: 18px !important;
            top: 14px !important;
            z-index: 99998 !important;
            padding: 8px 14px;
            border-radius: var(--radius-pill);
            border: 1px solid var(--ui-border);
            background: var(--ui-bg);
            backdrop-filter: blur(var(--glass-blur));
            color: #1f3a2c;
            font-size: 12px;
            font-weight: 600;
            box-shadow: var(--ui-shadow);
            transition: opacity var(--dur-mid) ease, transform var(--dur-mid) ease;
        }
        .fp-status[data-level="ok"] { color: #1f7a48; }
        .fp-status[data-level="warn"] { color: #9a5b09; }

        .fp-mask {
            position: fixed;
            inset: 0;
            z-index: 99996;
            background: rgba(4, 20, 14, 0.25);
            backdrop-filter: blur(2px);
            opacity: 0;
            pointer-events: none;
            transition: opacity var(--dur-mid) ease;
        }
        .fp-mask.open {
            opacity: 1;
            pointer-events: auto;
        }

        .fp-panel {
            position: fixed !important;
            right: 18px !important;
            bottom: 72px !important;
            width: min(270px, calc(100vw - 32px));
            z-index: 99997 !important;
            border-radius: var(--radius-panel);
            border: 1px solid var(--ui-border);
            background: var(--ui-bg);
            backdrop-filter: blur(calc(var(--glass-blur) + 2px));
            box-shadow: var(--ui-shadow), var(--ui-glow);
            transform: translate3d(18px, 18px, 0) scale(0.24);
            transform-origin: 100% 100%;
            opacity: 0;
            pointer-events: none;
            transition: none;
            overflow: hidden;
        }
        .fp-panel.open {
            animation: fp-panel-pop-in 520ms cubic-bezier(0.22, 1.2, 0.24, 1) forwards;
            pointer-events: auto;
        }
        .fp-panel.closing {
            animation: fp-panel-pop-out 340ms cubic-bezier(0.55, 0, 0.75, 0.1) forwards;
            pointer-events: none;
        }
        @keyframes fp-panel-pop-in {
            0% {
                opacity: 0;
                transform: translate3d(18px, 18px, 0) scale(0.24);
                filter: blur(4px);
            }
            72% {
                opacity: 1;
                transform: translate3d(0, -2px, 0) scale(1.05);
                filter: blur(0);
            }
            100% {
                opacity: 1;
                transform: translate3d(0, 0, 0) scale(1);
            }
        }
        @keyframes fp-panel-pop-out {
            0% {
                opacity: 1;
                transform: translate3d(0, 0, 0) scale(1);
                filter: blur(0);
            }
            100% {
                opacity: 0;
                transform: translate3d(18px, 18px, 0) scale(0.2);
                filter: blur(3px);
            }
        }
        .fp-head {
            display: flex;
            align-items: center;
            justify-content: flex-start;
            padding: 14px 16px 10px 16px;
            border-bottom: 1px solid rgba(255,255,255,0.5);
        }
        .fp-head h3 {
            margin: 0;
            font-size: 15px;
            font-weight: 800;
            color: #183327;
            letter-spacing: .03em;
        }
        .fp-body { padding: 10px 12px 12px 12px; }
        .fp-controls-slot { margin-top: 2px; }
        .fp-block {
            border-radius: 16px;
            border: 1px solid rgba(255,255,255,0.62);
            background: var(--ui-bg);
            padding: 10px;
            box-shadow: var(--ui-shadow), inset 0 1px 0 rgba(255,255,255,0.35);
            margin-bottom: 8px;
        }
        .fp-title {
            font-size: 13px;
            font-weight: 800;
            color: #173326;
            margin-bottom: 6px;
        }
        .fp-desc {
            font-size: 12px;
            line-height: 1.5;
            color: #2a4a3a;
            margin-bottom: 10px;
        }
        .fp-action {
            width: 100%;
            padding: 10px 12px;
            border-radius: 12px;
            border: 1px solid rgba(255,255,255,0.72);
            background: linear-gradient(135deg, rgba(27,128,81,0.8), rgba(21,90,59,0.9));
            color: #fff;
            font-size: 13px;
            font-weight: 700;
            cursor: pointer;
            box-shadow: 0 8px 18px rgba(12, 70, 43, 0.22);
        }
        .fp-action:disabled {
            opacity: .6;
            cursor: not-allowed;
        }

        @media (max-width: 768px) {
            .fp-launch { right: 12px !important; bottom: 12px !important; }
            .fp-status { left: 12px !important; top: 10px !important; max-width: calc(100vw - 24px); }
            .fp-panel { right: 12px !important; bottom: 64px !important; width: calc(100vw - 32px); }
        }

    </style>
</head>
<body>
    <button id="fp-launch" class="fp-launch" title="打开功能面板">功能</button>
    <div id="fp-status" class="fp-status" aria-live="polite">头像预加载：准备中...</div>
    <div id="fp-mask" class="fp-mask" aria-hidden="true"></div>
    <aside id="fp-panel" class="fp-panel" aria-hidden="true">
        <div class="fp-head">
            <h3>功能面板</h3>
        </div>
        <div class="fp-body">
            <section class="fp-block">
                <div class="fp-title">抽取设置</div>
                <div id="fp-current-filter" class="fp-desc">当前：所有人</div>
                <div id="fp-controls-slot" class="fp-controls-slot"></div>
            </section>
            <section class="fp-block">
                <div class="fp-title">头像缓存</div>
                <div id="fp-preload-status" class="fp-desc">正在检测头像缓存状态...</div>
                <button id="fp-preload-retry" class="fp-action">重新预加载头像</button>
            </section>
        </div>
    </aside>

    <div class="bg-dots" aria-hidden="true">
        <div class="bg-dot a"></div>
        <div class="bg-dot b"></div>
        <div class="bg-dot c"></div>
    </div>

    <div class="main-content">
        <div class="filter-container">
            <div id="btn-filter" title="点击选择抽取范围">
                <span id="filter-text">所有人</span>
                <span style="font-size: 10px; opacity: 0.5;">▼</span>
            </div>
            <div class="filter-menu" id="filter-menu">
                <div class="filter-option base-option selected" data-type="group" data-value="所有人">所有人</div>
                <div class="filter-option base-option" data-type="group" data-value="生物">生物</div>
                <div class="filter-option base-option" data-type="group" data-value="政治">政治</div>
                
                <div class="filter-separator"></div>
                
                <div class="filter-option bonus-option bonus-skill" data-type="bonus" data-value="技能">技能</div>
                <div class="filter-option bonus-option bonus-teacher" data-type="bonus" data-value="老师">老师</div>

                <div class="filter-separator"></div>
                <div class="filter-option instant-option" id="btn-instant-mode">⚡ 直接抽取</div>
                <div class="filter-option simple-mode-option" id="btn-simple-mode">🕶️ 简易模式</div>
            </div>
        </div>
        
        <div class="top-section" id="top-section">
            <div class="avatar-container" id="avatar-box" title="点击切换显示真名/网名">
                <div class="non-person-name" id="non-person-name-display" style="display: none;"></div>
                <img src="" alt="Avatar" class="avatar-img" id="avatar-img">
            </div>
        </div>

        <div class="middle-section">
            <div id="name-display">别紧张</div> 
        </div>

        <div class="bottom-section">
            <button id="btn-main" class="action-btn">开始滚动</button>
        </div>
    </div>

    <div id="toast-msg">简易模式不显示头像和网名，采用直接抽取</div>
    
    <div class="footer">
        <span>Copyright © Takion Kroslin 2026</span>
        <span class="footer-separator">|</span>
        <span class="footer-github">
            <a href="https://github.com/TakionKroslin/Lucky-Draw" target="_blank" title="访问 GitHub 仓库">
                <svg class="github-icon" viewBox="0 0 16 16" version="1.1" aria-hidden="true">
                    <path fill-rule="evenodd" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2h.02c0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"></path>
                </svg>
            </a>
        </span>
    </div>

    <script>
        /*
         * 文件总体说明：
         * - 本脚本负责“幸运抽取”页面的所有前端逻辑，包括数据、样式控制、抽签流程、动画触发和事件绑定。
         * - 请注意：本次仅添加注释，不对任何可执行代码做修改，确保行为与原来完全一致。
         *
         * 主要模块划分：
         * 1) 数据配置区域（参与抽取的学生/技能/老师等静态数据）
         * 2) 变量定义（从 DOM 获取引用，定义运行时状态变量）
         * 3) 核心功能函数（过滤、洗牌、滚动、渲染、动画控制等）
         * 4) 事件绑定与页面初始化（按钮、键盘、过滤器等交互绑定）
         */

        // --- 1. 数据配置区域 ---
        const database = [
            { nickname: "青行归", realname: "艾炜杰", avatarUrl: "https://pic1.imgdb.cn/item/6932846ad1e741a32bf1b9da.jpg", subject: "政治 "},
            { nickname: "Tiamo", realname: "艾文博", avatarUrl: "https://pic1.imgdb.cn/item/6932846ad1e741a32bf1b9dc.jpg", subject: "生物"},
            { nickname: "blue IHrNm", realname: "曹瑾瑜", avatarUrl: "https://pic1.imgdb.cn/item/6932846ad1e741a32bf1b9db.jpg", subject: "政治"},
            { nickname: "陳风", realname: "陈林霄", avatarUrl: "https://pic1.imgdb.cn/item/6932846ad1e741a32bf1b9dd.jpg", subject: "生物"},
            { nickname: "田田小影子", realname: "陈荍影", avatarUrl: "https://pic1.imgdb.cn/item/6932846ad1e741a32bf1b9d9.jpg", subject: "政治"},
            { nickname: "CzX", realname: "陈在芯", avatarUrl: "https://pic1.imgdb.cn/item/69328473d1e741a32bf1b9eb.jpg", subject: "生物"},
            { nickname: "🤐", realname: "程恩泽", avatarUrl: "https://pic1.imgdb.cn/item/69328473d1e741a32bf1b9ec.jpg", subject: "生物"},
            { nickname: "Il sole.", realname: "邓淼", avatarUrl: "https://pic1.imgdb.cn/item/69328473d1e741a32bf1b9ed.jpg", subject: "生物"},
            { nickname: "pit pony", realname: "邓萧晓", avatarUrl: "https://pic1.imgdb.cn/item/69328473d1e741a32bf1b9ee.jpg", subject: "生物"},
            { nickname: "白狗黑", realname: "冯麒霏", avatarUrl: "https://pic1.imgdb.cn/item/69328435d1e741a32bf1b991.jpg", subject: "政治"},
            { nickname: "高冷人士没有微信", realname: "高涵予", avatarUrl: "https://api.dicebear.com/7.x/identicon/svg?seed=Felix", subject: "生物"},
            { nickname: "泱泱清潭", realname: "高一淳", avatarUrl: "https://pic1.imgdb.cn/item/69328477d1e741a32bf1b9f6.jpg", subject: "生物"},
            { nickname: "萝卜丝比尔", realname: "辜孙雨辰", avatarUrl: "https://pic1.imgdb.cn/item/69328477d1e741a32bf1b9f9.jpg", subject: "政治"},
            { nickname: "欧皇知底", realname: "何奕嘉", avatarUrl: "https://pic1.imgdb.cn/item/69328436d1e741a32bf1b993.jpg", subject: "生物"},
            { nickname: "千", realname: "韩铭杰", avatarUrl: "https://pic1.imgdb.cn/item/69328477d1e741a32bf1b9f7.jpg", subject: "生物"},
            { nickname: "步法鹅", realname: "衡星玙", avatarUrl: "https://pic1.imgdb.cn/item/69328477d1e741a32bf1b9f5.jpg", subject: "生物"},
            { nickname: "PhuDgue", realname: "胡铸", avatarUrl: "https://pic1.imgdb.cn/item/6932847ed1e741a32bf1ba05.jpg", subject: "生物"},
            { nickname: "黄小妹", realname: "黄彦洁", avatarUrl: "https://pic1.imgdb.cn/item/6932847ed1e741a32bf1ba02.jpg", subject: "生物"},
            { nickname: "无恙.", realname: "李安然", avatarUrl: "https://pic1.imgdb.cn/item/694fe8e5161224305eb30b3e.jpg", subject: "生物"},
            { nickname: "Touma Kazusa", realname: "李柯锦", avatarUrl: "https://pic1.imgdb.cn/item/6932847ed1e741a32bf1ba03.jpg", subject: "生物"},
            { nickname: "Camilla", realname: "李林蔚", avatarUrl: "https://pic1.imgdb.cn/item/6932847ed1e741a32bf1ba04.jpg", subject: "生物"},
            { nickname: "Eschatology", realname: "廖家嘉", avatarUrl: "https://pic1.imgdb.cn/item/69328489d1e741a32bf1ba10.jpg", subject: "生物"},
            { nickname: "有悠", realname: "廖轩浩", avatarUrl: "https://pic1.imgdb.cn/item/69328489d1e741a32bf1ba12.jpg", subject: "政治"},
            { nickname: "刘轩", realname: "刘轩", avatarUrl: "https://pic1.imgdb.cn/item/69328435d1e741a32bf1b98d.jpg", subject: "政治"},
            { nickname: "轩🏃🏀", realname: "吕子轩", avatarUrl: "https://pic1.imgdb.cn/item/69328435d1e741a32bf1b992.jpg", subject: "生物"},
            { nickname: "揽星河", realname: "马星灿", avatarUrl: "https://pic1.imgdb.cn/item/69328489d1e741a32bf1ba11.jpg", subject: "生物"},
            { nickname: "小天才杏宝", realname: "彭渝中", avatarUrl: "https://pic1.imgdb.cn/item/6932848fd1e741a32bf1ba1a.jpg", subject: "政治"},
            { nickname: "我又不是苦力", realname: "唐菱蔚", avatarUrl: "https://pic1.imgdb.cn/item/693286fdd1e741a32bf1bd63.jpg", subject: "生物"},
            { nickname: "小王在此刻", realname: "王爱阳", avatarUrl: "https://pic1.imgdb.cn/item/6932848fd1e741a32bf1ba1b.jpg", subject: "政治"},
            { nickname: "涵", realname: "王乙涵", avatarUrl: "https://pic1.imgdb.cn/item/6932848fd1e741a32bf1ba19.jpg", subject: "生物"},
            { nickname: "一北极光", realname: "王懿", avatarUrl: "https://pic1.imgdb.cn/item/6932848fd1e741a32bf1ba1c.jpg", subject: "生物"},
            { nickname: "q7l12", realname: "王颖萱", avatarUrl: "https://pic1.imgdb.cn/item/6932848fd1e741a32bf1ba1d.jpg", subject: "生物"},
            { nickname: "Hello", realname: "王赞杰", avatarUrl: "https://pic1.imgdb.cn/item/69328494d1e741a32bf1ba23.jpg", subject: "生物"},
            { nickname: "Takion Kroslin", realname: "韦景皓", avatarUrl: "https://pic1.imgdb.cn/item/69328494d1e741a32bf1ba21.jpg", subject: "生物"},
            { nickname: "Anonymous", realname: "魏熙芮", avatarUrl: "https://pic1.imgdb.cn/item/69328494d1e741a32bf1ba25.jpg", subject: "生物"},
            { nickname: "文三", realname: "文思睿", avatarUrl: "https://pic1.imgdb.cn/item/69328494d1e741a32bf1ba22.jpg", subject: "生物"},
            { nickname: "WCSDM", realname: "吴向玉", avatarUrl: "https://pic1.imgdb.cn/item/69328435d1e741a32bf1b98f.jpg", subject: "生物"},
            { nickname: "西瓜刨冰", realname: "鲜卓彤", avatarUrl: "https://pic1.imgdb.cn/item/69328499d1e741a32bf1ba29.jpg", subject: "政治"},
            { nickname: "惟楚有才", realname: "徐楚烦", avatarUrl: "https://pic1.imgdb.cn/item/69328499d1e741a32bf1ba2b.jpg", subject: "生物"},
            { nickname: "续叙序", realname: "徐子恒", avatarUrl: "https://pic1.imgdb.cn/item/69328499d1e741a32bf1ba2c.jpg", subject: "政治"},
            { nickname: "旋转℃的时光", realname: "杨成宇", avatarUrl: "https://pic1.imgdb.cn/item/69328499d1e741a32bf1ba2a.jpg", subject: "生物"},
            { nickname: "Nernst", realname: "杨若雷", avatarUrl: "https://pic1.imgdb.cn/item/69328499d1e741a32bf1ba2d.jpg", subject: "生物"},
            { nickname: "鼠了", realname: "杨宣浩", avatarUrl: "https://pic1.imgdb.cn/item/6932849cd1e741a32bf1ba31.jpg", subject: "政治"},
            { nickname: "雏鸣", realname: "杨懿", avatarUrl: "https://pic1.imgdb.cn/item/6932849cd1e741a32bf1ba34.jpg", subject: "生物"},
            { nickname: "Ray", realname: "张淙睿", avatarUrl: "https://pic1.imgdb.cn/item/6932849cd1e741a32bf1ba32.jpg", subject: "生物"},
            { nickname: "丝血反虾闰土的猹", realname: "张梓轩", avatarUrl: "https://pic1.imgdb.cn/item/6932849cd1e741a32bf1ba35.jpg", subject: "生物"},
            { nickname: "AQ", realname: "赵潜", avatarUrl: "https://pic1.imgdb.cn/item/6932849cd1e741a32bf1ba33.jpg", subject: "政治"},
            { nickname: "(＞＜)", realname: "赵秋玉", avatarUrl: "https://pic1.imgdb.cn/item/693284a1d1e741a32bf1ba3a.jpg", subject: "生物"},
            { nickname: "Zfang", realname: "郑放", avatarUrl: "https://pic1.imgdb.cn/item/693284a1d1e741a32bf1ba3c.jpg", subject: "生物"},
            { nickname: "Emmanuel", realname: "周柯运", avatarUrl: "https://pic1.imgdb.cn/item/69328435d1e741a32bf1b98e.jpg", subject: "生物"},
            { nickname: "y", realname: "邹天杰", avatarUrl: "https://pic1.imgdb.cn/item/693284a1d1e741a32bf1ba3b.jpg", subject: "生物"},
            { nickname: "LZZN", realname: "刘知易", avatarUrl: "https://pic1.imgdb.cn/item/693d6d7ffe7cfeca3822ee6f.jpg", subject: "生物"},

        ];
        
        const SKILLS = [
            { type: "skill", nickname: "万箭齐发", realname: "万箭齐发", avatarUrl: "", hasAvatar: false, isSpecial: true, rarity: 'legend', className: 'skill-item' },
            { type: "skill", nickname: "铁索连环", realname: "铁索连环", avatarUrl: "", hasAvatar: false, isSpecial: true, rarity: 'epic', className: 'skill-item' },
            { type: "skill", nickname: "借刀杀人", realname: "借刀杀人", avatarUrl: "", hasAvatar: false, isSpecial: true, rarity: 'epic', className: 'skill-item' },
            { type: "skill", nickname: "桃园结义", realname: "桃园结义", avatarUrl: "", hasAvatar: false, isSpecial: true, rarity: 'rare', className: 'skill-item' },
            { type: "skill", nickname: "火爆辣椒", realname: "火爆辣椒", avatarUrl: "", hasAvatar: false, isSpecial: true, rarity: 'rare', className: 'skill-item' },
            { type: "skill", nickname: "下个双倍", realname: "下个双倍", avatarUrl: "", hasAvatar: false, isSpecial: true, rarity: 'legend', className: 'skill-item' },
        ];
        
        const TEACHERS = [
            { type: "teacher", nickname: "90后金浪", realname: "金浪", avatarUrl: "https://pic1.imgdb.cn/item/6946ad3c29a616e528622640.png", hasAvatar: true, isSpecial: true, rarity: 'legend', className: 'teacher-item' },
            { type: "teacher", nickname: "风清扬", realname: "刘川", avatarUrl: "https://pic1.imgdb.cn/item/694fea95161224305eb30b63.jpg", hasAvatar: true, isSpecial: true, rarity: 'epic', className: 'teacher-item' },
            { type: "teacher", nickname: "刘超", realname: "刘超", avatarUrl: "", hasAvatar: false, isSpecial: true, rarity: 'epic', className: 'teacher-item' },
            { type: "teacher", nickname: "王盼", realname: "王盼", avatarUrl: "", hasAvatar: false, isSpecial: true, rarity: 'rare', className: 'teacher-item' },
            { type: "teacher", nickname: "覃勤", realname: "覃勤", avatarUrl: "", hasAvatar: false, isSpecial: true, rarity: 'rare', className: 'teacher-item' },
            { type: "teacher", nickname: "韦建军", realname: "韦建军", avatarUrl: "", hasAvatar: false, isSpecial: true, rarity: 'rare', className: 'teacher-item' },
            { type: "teacher", nickname: "王俊东", realname: "王俊东", avatarUrl: "", hasAvatar: false, isSpecial: true, rarity: 'rare', className: 'teacher-item' },
        ];

        const startPhrases = [
            "让我看看谁在紧张",
            "是谁的小鹿在乱撞",
            "深呼吸，头晕是正常的",
            "别躲了，我都看到你了",
            "此时一名幸运观众汗流浃背",
            "命运的齿轮开始转动",
            "只是抽个查，别慌",
            "眼神别飘，看着我",
            "准备好你的表演了吗",
            "让我康康是谁这么幸运",

            "气氛突然变得不太友好",
            "这一刻，总有人在装镇定",
            "心跳声有点大了",
            "有人已经开始后悔来上这节课了",
            "别急，还没轮到你（也可能是）",
            "有人的手心开始出汗了",

            "此时一位同学正在疯狂祈祷",
            "有人已经在脑内演练答案了",
            "后排集体屏住了呼吸",
            "这不是随机，这是命",
            "全班最不想被点到的人，正在被点到",
            "别看手机了，说的就是你",

            "命运正在缓慢加载",
            "选择权，交给随机数",
            "这一秒，概率开始显灵",
            "命运的光标停下来了",
            "一切都不是巧合",
            "抽取中，请保持肃静",

            "CPU 已经开始过热",
            "大脑：未响应",
            "灵魂已离线",
            "正在检测谁最慌",
            "本系统不接受装死",
            "已锁定一名人类目标",

            "这是一次完全公平的随机事件",
            "请对算法保持尊重",
            "数据不会偏心",
            "理论上，这不该是你",
            "概率论正在看着你",
            "本次抽取不含私人恩怨"
        ];

        
        // --- 2. 变量定义 ---
        // 说明：此处为运行时使用的 DOM 引用与状态变量。
        // - DOM 引用（例如 nameDisplay、avatarBox 等）用于在函数中读写界面元素。
        // - 状态变量（例如 isRolling、isRealNameShowing 等）记录当前抽签流程与动画状态，
        //   可避免在动画未完成时重复触发冲突的行为。
        const nameDisplay = document.getElementById('name-display');
        const btnMain = document.getElementById('btn-main');
        const avatarBox = document.getElementById('avatar-box');
        const avatarImg = document.getElementById('avatar-img');
        const nonPersonNameDisplay = document.getElementById('non-person-name-display');
        const btnFilter = document.getElementById('btn-filter');
        const filterText = document.getElementById('filter-text');
        const filterMenu = document.getElementById('filter-menu');
        const btnInstantMode = document.getElementById('btn-instant-mode');
        
        // ⬇️ 新增变量：简易模式、提示、顶部区域控制
        const btnSimpleMode = document.getElementById('btn-simple-mode');
        const toastMsg = document.getElementById('toast-msg');
        const topSection = document.getElementById('top-section');
        const btnReveal = document.getElementById('btn-reveal');
        const filterContainer = document.querySelector('.filter-container');
        const fpLaunch = document.getElementById('fp-launch');
        const fpPanel = document.getElementById('fp-panel');
        const fpMask = document.getElementById('fp-mask');
        const fpStatus = document.getElementById('fp-status');
        const fpPreloadStatus = document.getElementById('fp-preload-status');
        const fpPreloadRetry = document.getElementById('fp-preload-retry');
        const fpControlsSlot = document.getElementById('fp-controls-slot');
        const fpCurrentFilter = document.getElementById('fp-current-filter');
        let isSimpleMode = false;

        const baseOptions = document.querySelectorAll('.filter-option.base-option');
        const bonusOptions = document.querySelectorAll('.filter-option.bonus-option');

        let isRolling = false;
        let timer = null;
        let selectedUser = null; 
        let isRealNameShowing = false; 
        
        let currentGroup = '所有人'; 
        let activeBonuses = [];      
        let isInstantMode = false;

        let filteredDatabase = []; 
        let shuffleIndex = 0; 
        let shuffledList = []; 
        
        let nextSelectedUser = null;

        // Helper to read unified glass alpha from CSS
        function getGlassAlpha() {
            const v = getComputedStyle(document.documentElement).getPropertyValue('--glass-alpha');
            const parsed = parseFloat(v);
            return isNaN(parsed) ? 0.68 : parsed;
        }

        const AVATAR_LOAD_TIMEOUT_MS = 7000;
        const AVATAR_FALLBACK_BG = '#e6f4ec';
        const AVATAR_FALLBACK_FG = '#2d6a4f';
        let avatarLoadToken = 0;
        const AVATAR_PRELOAD_TIMEOUT_MS = 5500;
        let avatarPreloadDone = false;
        let featurePanelCloseTimer = null;
        // WebAudio 抽取音效状态：首次用户点击后解锁，按稀有度播放不同旋律。
        let drawAudioCtx = null;
        const DRAW_SFX_ENABLED = true;

        function ensureDrawAudioContext() {
            if (!DRAW_SFX_ENABLED) return null;
            const AC = window.AudioContext || window.webkitAudioContext;
            if (!AC) return null;
            if (!drawAudioCtx) drawAudioCtx = new AC();
            return drawAudioCtx;
        }

        function unlockDrawAudioContext() {
            const ctx = ensureDrawAudioContext();
            if (!ctx) return;
            if (ctx.state === 'suspended') ctx.resume().catch(() => {});
        }

        function playTone(ctx, cfg) {
            // 单个音符发生器：振荡器 + 低通滤波 + 包络。
            const osc = ctx.createOscillator();
            const gain = ctx.createGain();
            const filter = ctx.createBiquadFilter();
            osc.type = cfg.wave || 'triangle';
            osc.frequency.setValueAtTime(cfg.freq, cfg.start);
            osc.frequency.exponentialRampToValueAtTime(Math.max(40, cfg.freq * (cfg.slide || 1)), cfg.start + cfg.dur);
            filter.type = 'lowpass';
            filter.frequency.setValueAtTime(cfg.cutoff || 2600, cfg.start);
            gain.gain.setValueAtTime(0.0001, cfg.start);
            gain.gain.exponentialRampToValueAtTime(cfg.gain || 0.09, cfg.start + 0.02);
            gain.gain.exponentialRampToValueAtTime(0.0001, cfg.start + cfg.dur);
            osc.connect(filter);
            filter.connect(gain);
            gain.connect(ctx.destination);
            osc.start(cfg.start);
            osc.stop(cfg.start + cfg.dur + 0.03);
        }

        function playSpecialSfx(role, rarity) {
            const ctx = ensureDrawAudioContext();
            if (!ctx) return;
            if (ctx.state === 'suspended') ctx.resume().catch(() => {});
            const now = ctx.currentTime + 0.015;

            const teacherWave = 'triangle';
            const skillWave = 'sawtooth';
            const wave = role === 'teacher' ? teacherWave : skillWave;
            const base = role === 'teacher' ? 196 : 220;

            let seq = [];
            let step = 0.09;
            let gain = 0.08;
            let dur = 0.22;
            let cutoff = 2600;

            // legend > epic > rare：音符数、时长和响度依次递减。
            if (rarity === 'legend') {
                seq = [0, 7, 12, 19, 24, 31];
                step = 0.085;
                gain = 0.12;
                dur = 0.3;
                cutoff = 3200;
            } else if (rarity === 'epic') {
                seq = [0, 7, 12, 16, 12];
                step = 0.1;
                gain = 0.095;
                dur = 0.24;
                cutoff = 2800;
            } else {
                seq = [0, 5, 9];
                step = 0.12;
                gain = 0.07;
                dur = 0.2;
                cutoff = 2400;
            }

            seq.forEach((semi, idx) => {
                const freq = base * Math.pow(2, semi / 12);
                playTone(ctx, {
                    start: now + idx * step,
                    freq,
                    dur,
                    wave,
                    gain,
                    cutoff,
                    slide: rarity === 'legend' ? 1.06 : 1.02
                });
            });
        }

        function escapeSvgText(input) {
            return String(input || '')
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
        }

        function createAvatarFallbackDataUrl(name) {
            const label = String(name || '?').trim().slice(0, 2) || '?';
            const safeLabel = escapeSvgText(label);
            const svg = `<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"512\" height=\"512\" viewBox=\"0 0 512 512\"><rect width=\"512\" height=\"512\" rx=\"96\" fill=\"${AVATAR_FALLBACK_BG}\"/><text x=\"50%\" y=\"52%\" dominant-baseline=\"middle\" text-anchor=\"middle\" font-family=\"-apple-system,BlinkMacSystemFont,'Segoe UI','PingFang SC','Microsoft YaHei',sans-serif\" font-size=\"200\" fill=\"${AVATAR_FALLBACK_FG}\" font-weight=\"700\">${safeLabel}</text></svg>`;
            return `data:image/svg+xml;charset=UTF-8,${encodeURIComponent(svg)}`;
        }

        function setPreloadStatus(text, level) {
            if (fpStatus) {
                fpStatus.textContent = text;
                if (level) fpStatus.dataset.level = level;
            }
            if (fpPreloadStatus) fpPreloadStatus.textContent = text;
        }

        function preloadAvatarUrl(url) {
            const normalized = String(url || '').trim();
            if (!normalized) return Promise.resolve({ ok: false, reason: 'empty' });
            return new Promise((resolve) => {
                const img = new Image();
                let settled = false;
                const finish = (ok, reason) => {
                    if (settled) return;
                    settled = true;
                    clearTimeout(timeout);
                    resolve({ ok, reason });
                };
                const timeout = setTimeout(() => finish(false, 'timeout'), AVATAR_PRELOAD_TIMEOUT_MS);
                img.onload = () => finish(true, 'loaded');
                img.onerror = () => finish(false, 'error');
                img.referrerPolicy = 'no-referrer';
                img.decoding = 'async';
                img.src = normalized;
            });
        }

        async function preloadAllAvatars() {
            if (fpPreloadRetry) fpPreloadRetry.disabled = true;
            setPreloadStatus('头像预加载：进行中...', 'warn');
            const avatarUrls = [...new Set(
                database
                    .concat(TEACHERS)
                    .filter(item => String(item.avatarUrl || '').trim())
                    .map(item => String(item.avatarUrl || '').trim())
            )];
            if (avatarUrls.length === 0) {
                avatarPreloadDone = true;
                setPreloadStatus('头像预加载：无可用头像地址', 'warn');
                if (fpPreloadRetry) fpPreloadRetry.disabled = false;
                return;
            }

            const results = await Promise.all(avatarUrls.map(preloadAvatarUrl));
            const okCount = results.filter(r => r.ok).length;
            const failCount = results.length - okCount;
            avatarPreloadDone = true;
            if (failCount === 0) {
                setPreloadStatus(`头像预加载：完成 ${okCount}/${results.length}`, 'ok');
            } else {
                setPreloadStatus(`头像预加载：成功 ${okCount}/${results.length}，失败 ${failCount}`, 'warn');
            }
            if (fpPreloadRetry) fpPreloadRetry.disabled = false;
        }

        function isFeaturePanelOpen() {
            return !!fpPanel && fpPanel.classList.contains('open') && !fpPanel.classList.contains('closing');
        }

        function setFeaturePanelOpen(nextOpen) {
            if (!fpPanel || !fpMask) return;
            if (featurePanelCloseTimer) {
                clearTimeout(featurePanelCloseTimer);
                featurePanelCloseTimer = null;
            }
            // 打开/关闭分支分离，避免快速点击造成状态竞争。
            if (nextOpen) {
                fpPanel.classList.remove('closing');
                fpPanel.classList.add('open');
                fpMask.classList.add('open');
                if (fpLaunch) fpLaunch.classList.add('is-open');
                fpPanel.setAttribute('aria-hidden', 'false');
                fpMask.setAttribute('aria-hidden', 'false');
                return;
            }

            if (!fpPanel.classList.contains('open') && !fpPanel.classList.contains('closing')) return;
            fpPanel.classList.remove('open');
            fpPanel.classList.add('closing');
            fpMask.classList.remove('open');
            if (fpLaunch) fpLaunch.classList.remove('is-open');
            fpMask.setAttribute('aria-hidden', 'true');
            featurePanelCloseTimer = setTimeout(() => {
                fpPanel.classList.remove('closing');
                fpPanel.setAttribute('aria-hidden', 'true');
            }, 280);
        }

        function clearAvatarAnimClasses() {
            avatarBox.classList.remove(
                'card-animate',
                'special-draw-effect',
                'anim-legend',
                'anim-epic',
                'anim-rare',
                'anim-teacher-legend',
                'anim-teacher-epic',
                'anim-teacher-rare',
                'anim-skill-legend',
                'anim-skill-epic',
                'anim-skill-rare',
                'rarity-legend',
                'rarity-epic',
                'rarity-rare',
                'tilt-left-anim',
                'tilt-right-anim',
                'tilt-drop-anim',
                'tilt-recover-anim'
            );
        }

        function loadAvatarWithFallback(url, label) {
            const loadToken = ++avatarLoadToken;
            const fallbackSrc = createAvatarFallbackDataUrl(label);
            const normalizedUrl = String(url || '').trim();

            avatarBox.classList.remove('avatar-ready', 'avatar-fallback');
            avatarBox.classList.add('avatar-loading');
            avatarImg.style.display = 'none';
            avatarImg.referrerPolicy = 'no-referrer';
            avatarImg.decoding = 'async';

            let finished = false;
            let timeoutId = null;
            const clean = () => {
                avatarImg.onload = null;
                avatarImg.onerror = null;
                if (timeoutId) {
                    clearTimeout(timeoutId);
                    timeoutId = null;
                }
            };

            const toReady = () => {
                if (finished || loadToken !== avatarLoadToken) return;
                finished = true;
                clean();
                avatarBox.classList.remove('avatar-loading', 'avatar-fallback');
                avatarBox.classList.add('avatar-ready');
                avatarImg.style.display = 'block';
            };

            const toFallback = () => {
                if (finished || loadToken !== avatarLoadToken) return;
                finished = true;
                clean();
                avatarBox.classList.remove('avatar-loading', 'avatar-ready');
                avatarBox.classList.add('avatar-fallback');
                avatarImg.style.display = 'block';
                avatarImg.src = fallbackSrc;
            };

            avatarImg.onload = toReady;
            avatarImg.onerror = toFallback;

            if (!normalizedUrl) {
                toFallback();
                return;
            }

            timeoutId = setTimeout(toFallback, AVATAR_LOAD_TIMEOUT_MS);
            avatarImg.src = normalizedUrl;
        }

        // --- 3. 核心功能函数 ---
        // 说明：这里包含程序的主要逻辑函数，按功能可以分为：
        // - 辅助/工具函数（如颜色生成、获取下一个项目等）
        // - 抽签控制流（开始/停止/处理即时抽取/准备下一轮等）
        // - 渲染与动画触发（更新头像、播放入场/歪头/恢复动画、切换姓名显示等）
        // - 事件响应（点击、键盘、过滤器交互等绑定在文件末尾）

        // 辅助函数：为学生头像生成随机渐变色
        function setStudentColors() {
            // 定义几组好看的渐变配色
            const gradients = [
                ['#42a5f5', '#7e57c2'], // 蓝紫
                ['#ff7043', '#ffca28'], // 橙黄
                ['#26a69a', '#66bb6a'], // 青绿
                ['#ec407a', '#ab47bc'], // 粉紫
                ['#5c6bc0', '#29b6f6']  // 靛蓝
            ];
            const rand = gradients[Math.floor(Math.random() * gradients.length)];
            avatarBox.style.setProperty('--c1', rand[0]);
            avatarBox.style.setProperty('--c2', rand[1]);
            avatarBox.style.setProperty('--glow', rand[0] + '33'); // 20%透明度
        }

        // 缓存过滤结果以提高性能
        const filterCache = new Map();
        
        function getFilterCacheKey() {
            const bonusesKey = activeBonuses.slice().sort().join(',');
            return `${currentGroup}|${bonusesKey}`;
        }
        
        function filterAndShuffleDatabase() {
            const cacheKey = getFilterCacheKey();
            
            // 尝试从缓存获取已过滤的列表
            if (filterCache.has(cacheKey)) {
                const cached = filterCache.get(cacheKey);
                filteredDatabase = cached.filteredDatabase;
                shuffledList = [...cached.shuffledList]; // 创建副本以避免污染缓存
                shuffleIndex = 0;
                btnMain.disabled = false;
                return true;
            }
            
            let studentList;
            if (currentGroup === '所有人') {
                studentList = database;
            } else {
                // 使用filter创建新数组
                studentList = database.filter(user => user.subject === currentGroup);
            }

            let specialItems = [];
            if (activeBonuses.includes('技能')) {
                // 使用展开运算符替代concat以提高性能
                specialItems = [...specialItems, ...SKILLS];
            }
            if (activeBonuses.includes('老师')) {
                specialItems = [...specialItems, ...TEACHERS];
            }
            
            if (studentList.length === 0 && specialItems.length > 0) {
                 filteredDatabase = specialItems;
            } else if (studentList.length > 0) {
                // 预分配数组大小以提高性能
                filteredDatabase = new Array(studentList.length + specialItems.length);
                for (let i = 0; i < studentList.length; i++) {
                    filteredDatabase[i] = studentList[i];
                }
                for (let i = 0; i < specialItems.length; i++) {
                    filteredDatabase[studentList.length + i] = specialItems[i];
                }
            } else {
                filteredDatabase = [];
            }
            
            if (filteredDatabase.length === 0) {
                nameDisplay.innerText = `无数据 (${currentGroup})`;
                btnMain.disabled = true;
                return false;
            }
            
            btnMain.disabled = false;
            
            // Fisher-Yates 洗牌算法 (原地洗牌)
            shuffledList = [...filteredDatabase];
            const n = shuffledList.length;
            for (let i = n - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                // 使用临时变量交换元素
                const temp = shuffledList[i];
                shuffledList[i] = shuffledList[j];
                shuffledList[j] = temp;
            }
            
            shuffleIndex = 0;
            
            // 缓存结果（不包括shuffleIndex，因为它会变化）
            filterCache.set(cacheKey, {
                filteredDatabase: filteredDatabase,
                shuffledList: shuffledList
            });
            
            return true;
        }

        function getNextShuffledItem() {
            if (shuffleIndex >= shuffledList.length) {
                if (!filterAndShuffleDatabase()) {
                    return null;
                }
                console.log("列表已抽完，重新洗牌。");
            }
            const item = shuffledList[shuffleIndex];
            shuffleIndex++; 
            return item;
        }
        
        function prepareNextDraw() {
            nextSelectedUser = getNextShuffledItem();
            if (nextSelectedUser) {
                const shouldUseAvatar = !nextSelectedUser.isSpecial || nextSelectedUser.hasAvatar === true;
                if (shouldUseAvatar && nextSelectedUser.avatarUrl) {
                    const img = new Image();
                    img.src = nextSelectedUser.avatarUrl;
                }
            }
        }
        
        
        function startRolling() {
            if (isRolling) return; 

            // 【新增】如果是简易模式，直接强制走直接抽取逻辑
            if (isSimpleMode) {
                handleInstantDraw();
                return;
            }

            // 如果是直接抽取模式
            if (isInstantMode) {
                if(isTilted()) {
                    avatarBox.classList.remove('is-tilted', 'tilt-left-anim', 'tilt-right-anim', 'tilt-drop-anim');
                }
                triggerShrinkHide();
                btnMain.disabled = true;
                setTimeout(() => { handleInstantDraw(); }, 500);
                return;
            }
            
            clearAvatarAnimClasses();
            avatarBox.classList.remove('is-tilted');

            triggerShrinkHide();
            btnMain.disabled = true;

            setTimeout(() => {
                if (!nextSelectedUser && !filterAndShuffleDatabase()) {
                    btnMain.disabled = false;
                    return; 
                }
                if (!nextSelectedUser) {
                    prepareNextDraw();
                    if(!nextSelectedUser) return;
                }
                doStartRollLogic();
            }, 500);
        }
        
        function handleInstantDraw() {
            btnMain.disabled = true;
            
            // 准备数据
            if (!nextSelectedUser && !filterAndShuffleDatabase()) {
                btnMain.disabled = false;
                return;
            }
            if (!nextSelectedUser) prepareNextDraw();
            selectedUser = nextSelectedUser;
            
            // 直接显示结果
            renderResult(selectedUser);
            
            prepareNextDraw();
        }
        
        function doStartRollLogic() {
            isRolling = true;
            btnMain.disabled = true; 
            btnMain.innerText = "抽取"; 
            
            triggerShrinkHide();
            
            // 重置状态
            nameDisplay.classList.remove('slide-out-up', 'slide-in-up');
            isRealNameShowing = false; 
            const _alpha = getGlassAlpha();
            nameDisplay.style.backgroundColor = `rgba(250,250,250,${_alpha})`;
            nameDisplay.style.borderColor = "rgba(255,255,255,0.6)";

            // 使用 requestAnimationFrame 实现更高效的滚动动画
            let lastTime = 0;
            const rollInterval = 50; // 目标间隔 50ms
            let accumulatedTime = 0;
            
            function rollAnimationFrame(timestamp) {
                if (!isRolling) return;
                
                if (lastTime === 0) lastTime = timestamp;
                const deltaTime = timestamp - lastTime;
                lastTime = timestamp;
                accumulatedTime += deltaTime;
                
                // 每 50ms 更新一次显示，保持原有速度
                if (accumulatedTime >= rollInterval) {
                    const randomIndex = Math.floor(Math.random() * filteredDatabase.length);
                    nameDisplay.innerText = filteredDatabase[randomIndex].nickname;
                    accumulatedTime -= rollInterval;
                }
                
                if (isRolling) {
                    requestAnimationFrame(rollAnimationFrame);
                }
            }
            
            // 启动动画循环
            requestAnimationFrame(rollAnimationFrame);
            
            setTimeout(() => {
                if (isRolling) { 
                    btnMain.disabled = false;
                }
            }, 300); 
        }

        // 强制停止滚动（用于切换模式/过滤器时防止冲突）
        function forceStopRolling() {
            if (isRolling) {
                clearInterval(timer);
                isRolling = false;
                btnMain.disabled = false;
                // 根据当前模式重置按钮文字
                if (isInstantMode || isSimpleMode) {
                    btnMain.innerText = "点击抽取";
                } else {
                    btnMain.innerText = "开始滚动";
                }
                // 重置所有视觉状态
                avatarBox.classList.remove('show', 'is-tilted');
                clearAvatarAnimClasses();
            }
        }

        function stopRolling() {
            if (!isRolling) return; 
            
            isRolling = false;
            btnMain.disabled = true; 
            btnMain.innerText = "开始滚动";
            clearInterval(timer);

            selectedUser = nextSelectedUser;
            renderResult(selectedUser);
            prepareNextDraw(); 
        }

        function renderResult(user) {
            if (!user) return;

            // 【新增】简易模式特殊渲染逻辑
            if (isSimpleMode) {
                // 强制显示真名
                nameDisplay.innerText = user.realname;
                // 强制使用朴素背景
                const _alpha_sm = getGlassAlpha();
                nameDisplay.style.backgroundColor = `rgba(250,250,250,${_alpha_sm})`;
                nameDisplay.style.borderColor = "rgba(255,255,255,0.6)";
                
                // 不处理头像动画，直接恢复按钮
                btnMain.disabled = false;
                return;
            }

            nameDisplay.innerText = user.nickname;
            
            const isSpecialItem = user.isSpecial;
            const hasAvatar = user.hasAvatar === true; 
            const rarity = user.rarity || 'rare'; 
            const role = user.className === 'teacher-item' ? 'teacher' : 'skill';

            avatarBox.className = 'avatar-container glass-hover-target';
            avatarBox.style.animation = '';
            clearAvatarAnimClasses();
            
            if (isSpecialItem && !hasAvatar) {
                avatarBox.classList.add('hide-img', user.className || 'skill-item');
                avatarBox.classList.add('no-hover-effect');
                avatarBox.classList.add('skill-aura');
                nonPersonNameDisplay.innerText = user.nickname;
                nonPersonNameDisplay.style.display = 'flex'; 
                avatarBox.classList.add('show');
                avatarBox.classList.remove('avatar-loading', 'avatar-ready', 'avatar-fallback');
                avatarImg.style.display = 'none';
                
                avatarBox.classList.remove('student-border', 'glow', 'teacher-aura');
                avatarBox.style.removeProperty('--c1');
                avatarBox.style.removeProperty('--c2');
                avatarBox.style.removeProperty('--glow');
            } else {
                nonPersonNameDisplay.style.display = 'none';
                avatarBox.classList.remove('hide-img', 'skill-item', 'teacher-item', 'no-hover-effect', 'skill-aura');
                loadAvatarWithFallback(user.avatarUrl, user.nickname || user.realname);
                
                if (!isSpecialItem) {
                    avatarBox.classList.add('student-border', 'glow');
                    avatarBox.classList.remove('teacher-aura');
                    setStudentColors();
                } else {
                    avatarBox.classList.remove('student-border', 'glow');
                    avatarBox.classList.add('teacher-aura');
                }
            }

            let animClass = 'card-animate'; 
            if (isSpecialItem) {
                // 老师与技能按稀有度映射到独立动画类。
                if (role === 'teacher') {
                    if (rarity === 'legend') animClass = 'anim-teacher-legend';
                    else if (rarity === 'epic') animClass = 'anim-teacher-epic';
                    else animClass = 'anim-teacher-rare';
                } else {
                    if (rarity === 'legend') animClass = 'anim-skill-legend';
                    else if (rarity === 'epic') animClass = 'anim-skill-epic';
                    else animClass = 'anim-skill-rare';
                }
            }
            if (isSpecialItem) {
                if (rarity === 'legend') avatarBox.classList.add('rarity-legend');
                else if (rarity === 'epic') avatarBox.classList.add('rarity-epic');
                else avatarBox.classList.add('rarity-rare');
                playSpecialSfx(role, rarity);
            }
            
            avatarBox.classList.add('show');
            void avatarBox.offsetWidth;
            avatarBox.classList.add(animClass);

            const animationDurationMap = {
                // 与 CSS 动画时长保持一致，确保按钮恢复时机准确。
                'card-animate': 1050,
                'anim-teacher-legend': 1520,
                'anim-teacher-epic': 1260,
                'anim-teacher-rare': 840,
                'anim-skill-legend': 1480,
                'anim-skill-epic': 1220,
                'anim-skill-rare': 820
            };
            const animationDuration = animationDurationMap[animClass] || 1050;
            
            setTimeout(() => {
                avatarBox.classList.add('show'); 
                btnMain.disabled = false;
                if (isInstantMode) {
                    btnMain.innerText = "点击抽取";
                } else {
                    btnMain.innerText = "开始滚动";
                }
                
                // 【修复】只有非特殊物品显示原名按钮
                if (!isSpecialItem) {
                    if (btnReveal) btnReveal.classList.add('reveal-show');
                }
                
            }, animationDuration);
        }

        // --- 修复代码开始：JS 歪头控制逻辑 ---

        // 1. 判断当前头像是否处于歪掉的状态
        function isTilted() {
            return avatarBox.classList.contains('tilt-left-anim') ||
                   avatarBox.classList.contains('tilt-right-anim') ||
                   avatarBox.classList.contains('tilt-drop-anim');
        }

        // 2. 应用随机歪头动画
        function applyRandomTilt() {
            // 移除可能存在的恢复动画
            avatarBox.classList.remove('tilt-recover-anim');
            // 添加标记，用于 CSS 中禁用 hover 效果
            avatarBox.classList.add('is-tilted');
            // 确保清除任何临时的 `no-anim` 抑制，以允许歪头动画正常播放
            avatarBox.classList.remove('no-anim');

            // 移除任何已存在的歪头类，以便重新添加时能重新触发动画
            avatarBox.classList.remove('tilt-left-anim', 'tilt-right-anim', 'tilt-drop-anim');
            // 仅移除会与歪头冲突的临时动画类，保留特殊等级的 anim-* 类以保留光效与边框
            clearAvatarAnimClasses();
            // 强制重绘以确保 CSS 动画可靠重启
            void avatarBox.offsetWidth;

            const r = Math.random();
            if (r < 0.33) {
                avatarBox.classList.add('tilt-left-anim');
            } else if (r < 0.66) {
                avatarBox.classList.add('tilt-right-anim');
            } else {
                avatarBox.classList.add('tilt-drop-anim');
            }
        }

        // 3. 恢复正常位置 (带动画)
        function restoreTilt() {
            if (!isTilted()) return;
            
            // 冻结当前可视状态：读取计算后的 transform 并在内联样式中应用
            const cs = window.getComputedStyle(avatarBox);
            const currentTransform = cs.transform || 'none';

            // 移除歪头动画类以停止动画，但通过内联设置计算出的 transform 来保留当前可见外观
            avatarBox.classList.remove('tilt-left-anim', 'tilt-right-anim', 'tilt-drop-anim');
            // 仅移除会影响恢复流程的临时动画类，保留 anim-legend/epic/rare 以保持边框和光效
            clearAvatarAnimClasses();
            if (currentTransform && currentTransform !== 'none') {
                avatarBox.style.transform = currentTransform;
            }

            // 恢复期间保持 hover 禁用，避免用户交互改变外观
            avatarBox.classList.add('is-tilted');

            // 恢复过程中，平滑地将姓名切回为网名显示
            nameDisplay.classList.remove('slide-in-up', 'slide-out-up');
            void nameDisplay.offsetWidth;
            nameDisplay.classList.add('slide-out-up');
            setTimeout(() => {
                isRealNameShowing = false;
                nameDisplay.innerText = selectedUser ? selectedUser.nickname : nameDisplay.innerText;
                nameDisplay.classList.remove('slide-out-up');
                nameDisplay.classList.add('slide-in-up');
            }, 160);

            // 强制样式刷新以立即应用内联 transform
            void avatarBox.offsetWidth;

            // 触发平滑恢复动画回到初始（无）变换
            avatarBox.classList.remove('tilt-recover-anim');
            void avatarBox.offsetWidth;
            avatarBox.classList.add('tilt-recover-anim');

            let cleaned = false;
            function cleanUp() {
                if (cleaned) return;
                cleaned = true;
                avatarBox.classList.remove('tilt-recover-anim');
                avatarBox.style.transform = '';
                avatarBox.classList.remove('is-tilted');
                // 不要触碰 card-animate/anim-legend 等类，保留入场状态
                avatarBox.removeEventListener('animationend', onEnd);
            }

            function onEnd(e) {
                if (e.animationName === 'tilt-back-smooth') {
                    cleanUp();
                }
            }
            avatarBox.addEventListener('animationend', onEnd);

            // 备用方案：如果未触发 animationend，则在比动画时长略长的时间后强制清理
            setTimeout(() => {
                cleanUp();
            }, 600);
        }

        // 4. 修改点击头像的逻辑 (toggleRealName)
        function toggleRealName() {
            if (!selectedUser || isSimpleMode) return; // 【修改】简易模式禁用切换
            
            // 【修复逻辑】：如果已经在歪头状态，点击则复位，不再切换名字
            if (isTilted()) {
                restoreTilt();
                return; 
            }

            // 如果没有歪头，执行：切换名字 + 随机歪头
            applyRandomTilt(); 

            // 下面是原有的切换名字动画逻辑
            nameDisplay.classList.remove('slide-in-up', 'slide-out-up');
            void nameDisplay.offsetWidth; 
            nameDisplay.classList.add('slide-out-up');

            setTimeout(() => {
                isRealNameShowing = !isRealNameShowing;
                
                if (isRealNameShowing) {
                    nameDisplay.innerText = selectedUser.realname;
                    nameDisplay.style.backgroundColor = `rgba(250,250,250,${getGlassAlpha()})`;
                } else {
                    nameDisplay.innerText = selectedUser.nickname;
                    nameDisplay.style.backgroundColor = `rgba(250,250,250,${getGlassAlpha()})`;
                }
                
                nameDisplay.classList.remove('slide-out-up');
                nameDisplay.classList.add('slide-in-up');
            }, 200);
        }

        // --- 修复代码结束 ---

        function updateFilterButtonText() {
            let text = currentGroup;
            if (activeBonuses.length > 0) {
                text += ` + ${activeBonuses.join('/')}`;
            }
            filterText.innerText = text;
            if (fpCurrentFilter) fpCurrentFilter.innerText = `当前：${text}`;
        }

        function showToast() {
            if (!toastMsg) return;
            toastMsg.classList.add('show');
            setTimeout(() => {
                hideToast();
            }, 2000);
        }
        
        function hideToast() {
            if (!toastMsg) return;
            toastMsg.classList.remove('show');
        }

        // 辅助：从可见状态可靠执行收缩隐藏动画（用于开始新一轮抽取时平滑隐藏）
        function triggerShrinkHide() {
            // 确保动画可以运行，移除任何与抽取相关的活动动画类
            avatarBox.classList.remove('no-anim');
            // 收缩前清空动画状态，避免新一轮入场动画和旧类叠加
            clearAvatarAnimClasses();
            // 同时清除任何内联的 animation/transition 以避免冲突
            avatarBox.style.animation = '';
            // 强制设置与 CSS 匹配的过渡，避免被此前的 inline/none 状态阻断
            avatarBox.style.transition = 'transform 0.45s cubic-bezier(0.22, 1, 0.36, 1), opacity 0.45s ease';

            // 确保计算的状态为可见，以便从可见 -> 收缩 的过渡能正确播放
            avatarBox.classList.add('show');
            // 强制样式刷新
            void avatarBox.offsetWidth;
            // 添加触发收缩并淡出的类
            avatarBox.classList.add('shrink-hide');
            // 动画结束后移除标记，恢复清洁状态
            setTimeout(() => {
                avatarBox.classList.remove('show');
                avatarBox.classList.remove('shrink-hide');
                // 清理临时内联样式，恢复默认样式表控制
                avatarBox.style.transition = '';
                avatarBox.style.animation = '';
            }, 520);
        }

        // --- 4. 事件监听器 (优化版，使用事件委托) ---
        
        // 一次性事件绑定函数
        function setupEventListeners() {
            // 主按钮点击
            btnMain.addEventListener('click', () => {
                unlockDrawAudioContext();
                if (isInstantMode) {
                    startRolling(); 
                } else {
                    if (isRolling) stopRolling();
                    else startRolling();
                }
            });

            // 空格键控制
            document.addEventListener('keydown', (e) => {
                if (e.code === 'Space') {
                    e.preventDefault(); 
                    if (btnMain.disabled) return; 
                    btnMain.click();
                }
            });

            // 点击头像切换名字
            avatarBox.addEventListener('click', (e) => {
                e.stopPropagation(); 
                toggleRealName(); 
            });

            // 点击空白处复位
            document.addEventListener('click', (e) => {
                const target = e.target;
                
                // 关闭过滤器菜单（如果打开且点击的是外部）
                if (!btnFilter.contains(target) && !filterMenu.contains(target)) {
                    if (filterMenu.classList.contains('open')) {
                        filterMenu.classList.remove('open');
                        btnFilter.classList.remove('active');
                    }
                }
                
                // 复位歪头动画（如果点击头像外部）
                if (!avatarBox.contains(target) && isTilted()) {
                    restoreTilt();
                }

                hideToast(); // 点击任意处隐藏 Toast
            });

            // 过滤器按钮
            btnFilter.addEventListener('click', (e) => {
                e.stopPropagation(); 
                forceStopRolling(); // 打开菜单时强制停止滚动
                filterMenu.classList.toggle('open');
                btnFilter.classList.toggle('active');
            });
            
            // 防止过滤器菜单点击传播
            filterMenu.addEventListener('click', (e) => {
                e.stopPropagation();
            });

            // 使用事件委托处理过滤器选项点击
            filterMenu.addEventListener('click', (e) => {
                const target = e.target;
                if (!target.classList.contains('filter-option')) return;
                
                const option = target;
                const optionType = option.dataset.type;
                const optionValue = option.dataset.value;
                
                // 处理基础选项（选科）
                if (optionType === 'group') {
                    const newGroup = optionValue;
                    if (currentGroup !== newGroup) {
                        // 更新选中状态
                        baseOptions.forEach(o => o.classList.remove('selected'));
                        option.classList.add('selected');
                        currentGroup = newGroup;
                        handleFilterChange();
                    }
                }
                // 处理加成选项（技能/老师）
                else if (optionType === 'bonus') {
                    option.classList.toggle('selected');
                    const bonusValue = optionValue;
                    
                    if (option.classList.contains('selected')) {
                        if (!activeBonuses.includes(bonusValue)) activeBonuses.push(bonusValue);
                    } else {
                        activeBonuses = activeBonuses.filter(b => b !== bonusValue);
                    }
                    handleFilterChange();
                }
                // 直接抽取模式按钮
                else if (option === btnInstantMode) {
                    handleInstantModeClick();
                }
                // 简易模式按钮
                else if (option === btnSimpleMode) {
                    handleSimpleModeClick();
                }
                
                // 关闭菜单
                filterMenu.classList.remove('open');
                btnFilter.classList.remove('active');
            });

            // 直接抽取模式处理函数
            function handleInstantModeClick() {
                forceStopRolling(); // 防止冲突
                
                // 互斥逻辑：如果开了简易模式，关掉它
                if (isSimpleMode) {
                    isSimpleMode = false;
                    if (btnSimpleMode) btnSimpleMode.classList.remove('selected');
                    if (topSection) topSection.classList.remove('hidden-mode'); // 恢复头像框
                }

                isInstantMode = !isInstantMode;
                btnInstantMode.classList.toggle('selected');
                
                if (isInstantMode) {
                    btnMain.innerText = "点击抽取";
                } else {
                    btnMain.innerText = "开始滚动";
                }
            }

            // 简易模式处理函数
            function handleSimpleModeClick() {
                forceStopRolling(); // 防止冲突
                
                isSimpleMode = !isSimpleMode;
                btnSimpleMode.classList.toggle('selected');
                
                if (isSimpleMode) {
                    // 启用简易模式：关闭直接抽取按钮样式(互斥表现)，启用功能逻辑
                    if (isInstantMode) {
                        isInstantMode = false;
                        btnInstantMode.classList.remove('selected');
                    }
                    
                    btnMain.innerText = "点击抽取";
                    if (topSection) topSection.classList.add('hidden-mode'); // 隐藏头像区域
                    if (btnReveal) btnReveal.classList.remove('reveal-show'); // 隐藏切换按钮
                    
                    showToast(); // 显示提示
                } else {
                    // 关闭简易模式，恢复默认
                    btnMain.innerText = "开始滚动";
                    if (topSection) topSection.classList.remove('hidden-mode');
                }
            }

            // 功能面板相关事件
            if (fpLaunch) {
                fpLaunch.addEventListener('click', () => setFeaturePanelOpen(!isFeaturePanelOpen()));
            }
            if (fpMask) {
                fpMask.addEventListener('click', () => setFeaturePanelOpen(false));
            }
            if (fpPreloadRetry) {
                fpPreloadRetry.addEventListener('click', () => {
                    preloadAllAvatars();
                });
            }
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') setFeaturePanelOpen(false);
            });
        }

        function handleFilterChange() {
            forceStopRolling(); // 切换选项时强制停止
            // 修复逻辑：切换选科时，先移除入场动画类并触发收缩隐藏动画，避免闪现
            triggerShrinkHide();
            // 清除歪头状态（同步清理）
            if (isTilted()) {
                avatarBox.classList.remove('tilt-left-anim', 'tilt-right-anim', 'tilt-drop-anim', 'tilt-recover-anim', 'is-tilted');
            }

            // 等待收缩动画完成后再更新列表（略长于动画时长以保证过渡完成）
            setTimeout(() => {
                updateFilterButtonText();
                filterAndShuffleDatabase();
                prepareNextDraw();
                nameDisplay.innerText = startPhrases[Math.floor(Math.random() * startPhrases.length)];
                selectedUser = null;
            }, 560);
        }

        // 初始化
        document.addEventListener('DOMContentLoaded', () => {
            if (filterContainer) filterContainer.classList.add('compact-hidden');
            if (filterMenu && fpControlsSlot) {
                fpControlsSlot.appendChild(filterMenu);
                filterMenu.classList.add('in-panel', 'open');
            }
            filterAndShuffleDatabase();
            prepareNextDraw();
            updateFilterButtonText();
            nameDisplay.innerText = startPhrases[Math.floor(Math.random() * startPhrases.length)];
            setPreloadStatus('头像预加载：准备中...', 'warn');
            preloadAllAvatars();
            
            // 设置事件监听器
            setupEventListeners();
        });

        // --- 背景光斑与交互光晕控制 ---
        (function setupBackgroundAndGlow() {
            // add glass-hover-target class to common elements
            const selector = 'button.action-btn, .filter-menu, .filter-option, .avatar-container, #name-display, .footer, #btn-reveal, .fp-launch, .fp-panel, .fp-action, .fp-block, .fp-status';
            const els = document.querySelectorAll(selector);
            els.forEach(e => e.classList.add('glass-hover-target'));

            // mousemove updates --mx/--my for element under cursor
            document.addEventListener('mousemove', (ev) => {
                const el = ev.target.closest('.glass-hover-target');
                if (!el) return;
                const r = el.getBoundingClientRect();
                const px = ((ev.clientX - r.left) / r.width) * 100;
                const py = ((ev.clientY - r.top) / r.height) * 100;
                el.style.setProperty('--mx', Math.max(0, Math.min(100, px)) + '%');
                el.style.setProperty('--my', Math.max(0, Math.min(100, py)) + '%');
            });

            // Background dots random smooth movement
            const dots = document.querySelectorAll('.bg-dot');
            if (!dots || dots.length === 0) return;

            function randomTransform() {
                dots.forEach((d, i) => {
                    const tx = (Math.random() * 60 - 30); // vw offset
                    const ty = (Math.random() * 40 - 20); // vh offset
                    const s = 0.9 + Math.random() * 0.2;
                    const r = (Math.random() * 6 - 3);
                    d.style.transform = `translate3d(${tx}vw, ${ty}vh, 0) scale(${s}) rotate(${r}deg)`;
                });
            }

            // seed initial transforms
            randomTransform();
            // periodically nudge to new random positions (staggered)
            setInterval(() => {
                randomTransform();
            }, 7000 + Math.floor(Math.random() * 6000));
        })();

    </script>
    <script src="easter-egg.js"></script>
</body>
</html>
