<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åˆ«ç´§å¼ </title>
    <link rel="icon" href="https://pic1.imgdb.cn/item/693d67f925ec9c13612be403.jpg" type="image/jpeg">
    
    <style>
        /* --- å…¨å±€æ ·å¼ --- */
        body {
            margin: 0;
            padding: 0;
            background-color: #ffffff;
            color: #000000;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Helvetica Neue", Helvetica, Arial, sans-serif;
            height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-between; 
            overflow: hidden;
            perspective: 1000px;
        }

        .main-content {
            flex-grow: 1; 
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 100%;
            position: relative;
        }

        /* --- è¿‡æ»¤å™¨æ ·å¼ --- */
        .filter-container {
            position: relative;
            z-index: 1000;
            margin-bottom: 20px;
            display: flex; 
        }

        #btn-filter {
            background-color: #fff;
            color: #000;
            border: 1px solid #e0e0e0;
            padding: 10px 24px;
            min-width: 120px;
            font-size: 15px;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        #btn-filter:hover {
            background-color: #f9f9f9;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transform: translateY(-1px);
        }

        #btn-filter.active {
            background-color: #000;
            color: #fff;
            border-color: #000;
        }

        .filter-menu {
            position: absolute;
            top: calc(100% + 10px); 
            left: 50%;
            transform: translateX(-50%) translateY(-10px);
            background-color: #fff;
            border: none;
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            padding: 6px;
            min-width: 140px;
            opacity: 0;
            visibility: hidden;
            transition: all 0.25s cubic-bezier(0.2, 0.8, 0.2, 1);
        }

        .filter-menu.open {
            opacity: 1;
            visibility: visible;
            transform: translateX(-50%) translateY(0);
        }

        .filter-option {
            padding: 10px 16px;
            cursor: pointer;
            font-size: 14px;
            color: #333;
            border-radius: 10px;
            text-align: center;
            transition: background-color 0.2s;
            margin-bottom: 2px;
        }

        .filter-option:last-child { margin-bottom: 0; }
        .filter-option:hover { background-color: #f5f5f5; }

        .filter-option.base-option.selected {
            background-color: #000;
            color: #fff;
            font-weight: 600;
        }
        
        .filter-option.bonus-option { color: #333; font-weight: normal; }
        .filter-option.bonus-option:hover { background-color: #f5f5f5; }
        
        .filter-option.bonus-skill.selected {
            background-color: #ff9800; 
            color: #fff;
            font-weight: 600;
        }

        .filter-option.bonus-teacher.selected {
            background-color: #2196f3; 
            color: #fff;
            font-weight: 600;
        }

        .filter-separator {
            height: 1px;
            background-color: #eee;
            margin: 6px 0;
        }

        .filter-option.instant-option {
            color: #d32f2f; 
            font-weight: 600;
        }
        .filter-option.instant-option:hover { background-color: #ffebee; }
        .filter-option.instant-option.selected {
            background-color: #d32f2f;
            color: #fff;
        }

        /* --- å¤´åƒåŒºåŸŸ --- */
        .top-section {
            height: 220px;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 20px;
        }

        .avatar-container {
            width: 200px;
            height: 200px;
            border-radius: 40px;
            overflow: hidden;
            border: 4px solid #000;
            
            /* --- æ ¸å¿ƒä¿®å¤ï¼šå¸å…¥å¼æ¶ˆå¤±åŠ¨ç”»çš„åŸºç¡€çŠ¶æ€ --- */
            opacity: 0; 
            transform: scale(0) rotate(-45deg); /* æ¶ˆå¤±æ—¶ç¼©æˆ0å¹¶ç•¥å¾®æ—‹è½¬ */
            /* ä½¿ç”¨ elastic è´å¡å°”æ›²çº¿å®ç° Q å¼¹çš„å‡ºç°/æ¶ˆå¤±æ•ˆæœ */
            transition: all 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55); 
            
            cursor: pointer;
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
            position: relative; 
            background-color: #fff; 
            user-select: none;
            -webkit-user-select: none;
        }
        
        

        /* --- å­¦ç”Ÿä¸“å±è¾¹æ¡† (CSSå˜é‡æ§åˆ¶é¢œè‰²) --- */
        .avatar-container.student-border {
            border: none; /* ç§»é™¤é»˜è®¤å®çº¿è¾¹æ¡† */
            box-shadow: 0 14px 30px rgba(0,0,0,0.08); /* åŸºç¡€é˜´å½±ï¼Œå’Œå…‰æ•ˆå åŠ  */
        }
        .avatar-container.student-border::after {
            content: '';
            position: absolute;
            inset: 0;
            border-radius: inherit;
            pointer-events: none;
            z-index: 2;
            /* ä½¿ç”¨ padding ä¸ mask åˆ¶ä½œç©ºå¿ƒçš„æ¸å˜è¾¹æ¡†ï¼Œå…¼å®¹åœ†è§’ */
            padding: 4px; /* è¾¹æ¡†åšåº¦ */
            background: linear-gradient(135deg, var(--c1, #42a5f5), var(--c2, #7e57c2));
            -webkit-mask:
                linear-gradient(#fff,#fff) content-box,
                linear-gradient(#000,#000);
            -webkit-mask-composite: xor;
            mask-composite: exclude;
        }
        /* è½»å¾®çš„è‰²å½©èƒŒæ™¯å…‰æ•ˆï¼Œä½¿ç”¨å˜é‡ç”ŸæˆåŠé€æ˜æŠ•å½± */
        .avatar-container.student-border.glow {
            box-shadow: 0 18px 40px var(--glow, rgba(0,0,0,0.06));
        }

        /* æ­£å¸¸æ˜¾ç¤ºçŠ¶æ€ */
        .avatar-container.show {
            opacity: 1;
            transform: scale(1) rotate(0deg);
        }

        /* å·²ç§»é™¤ Hover æ•ˆæœï¼šä¿æŒå¤´åƒåœ¨æ‚¬åœæ—¶ç¨³å®š */
        .avatar-container:not(.is-tilted):not(.no-hover-effect):hover {
            transform: none;
            transition: none;
            box-shadow: none;
        }
        
        .avatar-container.hide-img .avatar-img {
            display: none;
        }

        /* --- æŠ€èƒ½/è€å¸ˆæ–‡å­—ä¼˜åŒ– --- */
        .non-person-name {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center; 
            font-size: 32px; 
            font-weight: 800;
            color: #fff;
            text-shadow: 0 2px 10px rgba(0,0,0,0.3);
            line-height: 1.3;
            padding: 20px; 
            box-sizing: border-box; 
            word-break: break-word; 
        }
        
        .skill-item .non-person-name { background-color: #ff9800; }
        .teacher-item .non-person-name { background-color: #2196f3; }
        
        /* --- åŠ¨ç”»ç‰¹æ•ˆ (é‡åˆ¶ç‰ˆ) --- */
        
        /* 1. æ™®é€šç¿»è½¬åŠ¨ç”» */
        .avatar-container.card-animate {
            transition: none;
            opacity: 1 !important;
            animation: card-flip 1.8s cubic-bezier(0.68, -0.55, 0.265, 1.55) forwards;
        }
        @keyframes card-flip {
            0% { transform: scale(0.5) rotateY(0deg) rotateZ(-10deg); opacity: 0; }
            40% { transform: scale(1.1) rotateY(360deg) rotateZ(5deg); opacity: 1; }
            70% { transform: scale(1.05) rotateY(720deg) rotateZ(-2deg); }
            100% { transform: scale(1) rotateY(720deg) rotateZ(0deg); opacity: 1; }
        }

        /* 2. Legend åŠ¨ç”»: å²è¯—çº§é‡‘å…‰ç‚¸è£‚ (Qå¼¹ + éœ‡æ’¼) */
        .anim-legend {
            transition: none;
            opacity: 1 !important;
            animation: legend-entry 1.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
            border-color: #ffd700 !important;
            border-width: 6px !important;
        }
        @keyframes legend-entry {
            0% { transform: scale(0) rotate(720deg); opacity: 0; filter: brightness(5); }
            50% { transform: scale(1.3) rotate(-10deg); opacity: 1; filter: brightness(2); box-shadow: 0 0 50px #ffd700, 0 0 100px #ff8c00; }
            60% { transform: scale(0.9) rotate(5deg); box-shadow: 0 0 30px #ffd700; }
            70% { transform: scale(1.1) rotate(-3deg); filter: brightness(1.2); }
            80% { transform: scale(0.95) rotate(2deg); }
            100% { transform: scale(1) rotate(0deg); filter: brightness(1); box-shadow: 0 0 40px rgba(255, 215, 0, 0.6); }
        }

        /* 3. Epic åŠ¨ç”»: ç´«è‰²è™šç©ºèºæ—‹ (ç¥ç§˜ + ä¸æ»‘) */
        .anim-epic {
            transition: none;
            opacity: 1 !important;
            animation: epic-entry 1.4s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
            border-color: #9c27b0 !important;
        }
        @keyframes epic-entry {
            0% { transform: scale(0) translateY(200px); opacity: 0; }
            40% { transform: scale(1.2) translateY(-20px); opacity: 1; box-shadow: 0 0 40px #9c27b0, 0 0 80px #e040fb; }
            60% { transform: scale(0.9) translateY(10px); }
            100% { transform: scale(1) translateY(0); box-shadow: 0 0 25px #9c27b0; }
        }

        /* 4. Rare åŠ¨ç”»: è“è‰²ç§‘æŠ€è„‰å†² (æ¸…çˆ½ + å¿«é€Ÿ) */
        .anim-rare {
            transition: none;
            opacity: 1 !important;
            animation: rare-entry 1.2s cubic-bezier(0.68, -0.55, 0.265, 1.55) forwards;
            border-color: #03a9f4 !important;
        }
        @keyframes rare-entry {
            0% { transform: scale(0.5); opacity: 0; }
            50% { transform: scale(1.15); opacity: 1; box-shadow: 0 0 30px #03a9f4; }
            75% { transform: scale(0.95); }
            100% { transform: scale(1); opacity: 1; box-shadow: 0 0 15px #03a9f4; }
        }

        /* --- æ­ªæ–œ/æ‰é’‰åŠ¨ç”»ï¼ˆç‚¹å‡»å¤´åƒè§¦å‘ï¼‰ --- */
        /* --- ä¿®å¤ä»£ç å¼€å§‹ï¼šå¤´åƒæ­ªå¤´åŠ¨ç”» (QQå¼¹å¼¹ & æ‰è½) --- */

        /* çŠ¶æ€æ ‡è®°ï¼šå½“æœ‰è¿™ä¸ªç±»æ—¶ï¼Œç¦ç”¨é»˜è®¤çš„ CSS transitionï¼Œå®Œå…¨ç”± animation æ¥ç®¡ï¼Œé˜²æ­¢å†²çª */
        .is-tilted {
            transition: none !important;
        }

        /* åŠ¨ä½œ 1: å·¦æ­ª (Qå¼¹æ•ˆæœ - ä½¿ç”¨è´å¡å°”æ›²çº¿æ¨¡æ‹Ÿå¼¹ç°§) */
        .tilt-left-anim {
            animation: tilt-bounce-left 0.6s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
        }
        @keyframes tilt-bounce-left {
            0% { transform: rotate(0); }
            40% { transform: rotate(-25deg); } /* ç¨å¾®æ­ªè¿‡å¤´ä¸€ç‚¹ */
            100% { transform: rotate(-15deg) translateY(10px); } /* å›å¼¹åˆ°æœ€ç»ˆä½ç½® */
        }

        /* åŠ¨ä½œ 2: å³æ­ª (Qå¼¹æ•ˆæœ) */
        .tilt-right-anim {
            animation: tilt-bounce-right 0.6s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
        }
        @keyframes tilt-bounce-right {
            0% { transform: rotate(0); }
            40% { transform: rotate(25deg); }
            100% { transform: rotate(15deg) translateY(10px); }
        }

        /* åŠ¨ä½œ 3: éœ‡åŠ¨ + æ‰è½ (ç‰©ç†é‡åŠ›æ„Ÿ) */
        .tilt-drop-anim {
            animation: tilt-shock-drop 0.8s ease-out forwards;
        }
        @keyframes tilt-shock-drop {
            0% { transform: translate(0, 0) rotate(0); }
            10% { transform: translate(-5px, 0) rotate(-2deg); } /* éœ‡åŠ¨å‰æ‘‡ */
            20% { transform: translate(5px, 0) rotate(2deg); }
            30% { transform: translate(0, -15px) scale(1.05); } /* å‘ä¸ŠæŠ›èµ· */
            60% { transform: translate(0, 40px) rotate(10deg); } /* é‡åŠ›ä¸‹è½ */
            80% { transform: translate(0, 35px) rotate(8deg); } /* è½åœ°åå¼¹ */
            100% { transform: translate(0, 40px) rotate(10deg); } /* é™æ­¢ */
        }

        /* æ¢å¤åŠ¨ç”» (ä¸æ»‘å›æ­£) */
        .tilt-recover-anim {
            animation: tilt-back-smooth 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }
        @keyframes tilt-back-smooth {
            to { transform: rotate(0) translate(0, 0) scale(1); }
        }

        /* --- ä¿®å¤ä»£ç ç»“æŸ --- */
        /* ä¸´æ—¶å…³é—­åŠ¨ç”»/è¿‡æ¸¡ï¼Œé¿å…åœ¨æ¢å¤æ—¶é‡æ”¾æŠ½å¡åŠ¨ç”» */
        .avatar-container.no-anim {
            animation: none !important;
            transition: none !important;
        }

        /* æ”¶ç¼©å¹¶æ¸å‡ºï¼ˆå¸å…¥ï¼‰â€”â€”ç”¨äºå¼€å§‹æ–°ä¸€è½®æŠ½å–æ—¶å¹³æ»‘éšè—ä¸Šä¸€ä¸ªå¤´åƒ */
        .avatar-container.shrink-hide {
            transition: transform 0.45s cubic-bezier(0.22, 1, 0.36, 1), opacity 0.45s ease;
            transform: scale(0.12) rotate(-45deg) !important;
            opacity: 0 !important;
        }

        .avatar-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        /* --- ä¸­é—´ï¼šåå­—æ˜¾ç¤º --- */
        .middle-section {
            margin-bottom: 40px;
            text-align: center;
            height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #name-display {
            font-size: 48px;
            font-weight: 800;
            letter-spacing: 1px;
            padding: 10px 40px;
            border-radius: 24px;
            background-color: #f7f7f7;
            border: 2px solid #f0f0f0;
            min-width: 320px;
            overflow: hidden;
            position: relative;
            color: #1a1a1a;
        }

        @keyframes slideOutUp {
            0% { transform: translateY(0); opacity: 1; }
            100% { transform: translateY(-100%); opacity: 0; }
        }
        @keyframes slideInUp {
            0% { transform: translateY(100%); opacity: 0; }
            100% { transform: translateY(0); opacity: 1; }
        }
        .slide-out-up { animation: slideOutUp 0.2s ease-in forwards; }
        .slide-in-up { animation: slideInUp 0.3s ease-out forwards; }

        /* --- åº•éƒ¨æŒ‰é’®åŒºåŸŸ --- */
        .bottom-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 16px;
        }

        button.action-btn {
            background-color: #000;
            color: #fff;
            border: none;
            padding: 16px 48px; 
            font-size: 18px;
            font-weight: 700;
            border-radius: 100px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            outline: none;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }

        button.action-btn:hover {
            background-color: #333;
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.3);
        }

        button.action-btn:active { transform: translateY(0); }
        button.action-btn:disabled {
            background-color: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* æ˜¾ç¤ºåŸåæŒ‰é’® */
        #btn-reveal {
            background-color: #fff;
            color: #000;
            border: 2px solid #000;
            opacity: 0;
            visibility: hidden;
            transform: translateY(15px);
            transition: all 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            padding: 14px 40px;
            border-radius: 100px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }

        #btn-reveal:hover { background-color: #f7f7f7; }
        .reveal-show {
            opacity: 1 !important;
            visibility: visible !important;
            transform: translateY(0) !important;
        }
        .reveal-hidden {
            opacity: 0 !important;
            visibility: hidden !important;
            pointer-events: none;
        }
        
        /* --- Footer --- */
        .footer {
            width: 100%;
            padding: 12px 0;
            background-color: #fafafa;
            border-top: none;
            text-align: center;
            font-size: 13px;
            color: #888;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 12px;
        }
        .footer-separator { color: #ddd; font-size: 14px; }
        .footer-github a {
            color: #888;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            transition: color 0.3s;
        }
        .footer-github a:hover { color: #000; }
        .github-icon { width: 18px; height: 18px; fill: currentColor; display: block; }

    </style>
</head>
<body>

    <div class="main-content">
        <div class="filter-container">
            <div id="btn-filter" title="ç‚¹å‡»é€‰æ‹©æŠ½å–èŒƒå›´">
                <span id="filter-text">æ‰€æœ‰äºº</span>
                <span style="font-size: 10px; opacity: 0.5;">â–¼</span>
            </div>
            <div class="filter-menu" id="filter-menu">
                <div class="filter-option base-option selected" data-type="group" data-value="æ‰€æœ‰äºº">æ‰€æœ‰äºº</div>
                <div class="filter-option base-option" data-type="group" data-value="ç”Ÿç‰©">ç”Ÿç‰©</div>
                <div class="filter-option base-option" data-type="group" data-value="æ”¿æ²»">æ”¿æ²»</div>
                
                <div class="filter-separator"></div>
                
                <div class="filter-option bonus-option bonus-skill" data-type="bonus" data-value="æŠ€èƒ½">æŠ€èƒ½</div>
                <div class="filter-option bonus-option bonus-teacher" data-type="bonus" data-value="è€å¸ˆ">è€å¸ˆ</div>

                <div class="filter-separator"></div>
                <div class="filter-option instant-option" id="btn-instant-mode">âš¡ ç›´æ¥æŠ½å–</div>
            </div>
        </div>
        
        <div class="top-section">
            <div class="avatar-container" id="avatar-box" title="ç‚¹å‡»åˆ‡æ¢æ˜¾ç¤ºçœŸå/ç½‘å">
                <div class="non-person-name" id="non-person-name-display" style="display: none;"></div>
                <img src="" alt="Avatar" class="avatar-img" id="avatar-img">
            </div>
        </div>

        <div class="middle-section">
            <div id="name-display">åˆ«ç´§å¼ </div> 
        </div>

        <div class="bottom-section">
            <button id="btn-main" class="action-btn">å¼€å§‹æ»šåŠ¨</button>
        </div>
    </div>
    
    <div class="footer">
        <span>Copyright Â© Takion Kroslin 2026</span>
        <span class="footer-separator">|</span>
        <span class="footer-github">
            <a href="https://github.com/TakionKroslin/Lucky-Draw" target="_blank" title="è®¿é—® GitHub ä»“åº“">
                <svg class="github-icon" viewBox="0 0 16 16" version="1.1" aria-hidden="true">
                    <path fill-rule="evenodd" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2h.02c0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"></path>
                </svg>
            </a>
        </span>
    </div>

    <script>
        /*
         * æ–‡ä»¶æ€»ä½“è¯´æ˜ï¼š
         * - æœ¬è„šæœ¬è´Ÿè´£â€œå¹¸è¿æŠ½å–â€é¡µé¢çš„æ‰€æœ‰å‰ç«¯é€»è¾‘ï¼ŒåŒ…æ‹¬æ•°æ®ã€æ ·å¼æ§åˆ¶ã€æŠ½ç­¾æµç¨‹ã€åŠ¨ç”»è§¦å‘å’Œäº‹ä»¶ç»‘å®šã€‚
         * - è¯·æ³¨æ„ï¼šæœ¬æ¬¡ä»…æ·»åŠ æ³¨é‡Šï¼Œä¸å¯¹ä»»ä½•å¯æ‰§è¡Œä»£ç åšä¿®æ”¹ï¼Œç¡®ä¿è¡Œä¸ºä¸åŸæ¥å®Œå…¨ä¸€è‡´ã€‚
         *
         * ä¸»è¦æ¨¡å—åˆ’åˆ†ï¼š
         * 1) æ•°æ®é…ç½®åŒºåŸŸï¼ˆå‚ä¸æŠ½å–çš„å­¦ç”Ÿ/æŠ€èƒ½/è€å¸ˆç­‰é™æ€æ•°æ®ï¼‰
         * 2) å˜é‡å®šä¹‰ï¼ˆä» DOM è·å–å¼•ç”¨ï¼Œå®šä¹‰è¿è¡Œæ—¶çŠ¶æ€å˜é‡ï¼‰
         * 3) æ ¸å¿ƒåŠŸèƒ½å‡½æ•°ï¼ˆè¿‡æ»¤ã€æ´—ç‰Œã€æ»šåŠ¨ã€æ¸²æŸ“ã€åŠ¨ç”»æ§åˆ¶ç­‰ï¼‰
         * 4) äº‹ä»¶ç»‘å®šä¸é¡µé¢åˆå§‹åŒ–ï¼ˆæŒ‰é’®ã€é”®ç›˜ã€è¿‡æ»¤å™¨ç­‰äº¤äº’ç»‘å®šï¼‰
         */

        // --- 1. æ•°æ®é…ç½®åŒºåŸŸ ---
        const database = [
            { nickname: "é’è¡Œå½’", realname: "è‰¾ç‚œæ°", avatarUrl: "https://pic1.imgdb.cn/item/6932846ad1e741a32bf1b9da.jpg", subject: "æ”¿æ²» "},
            { nickname: "Tiamo", realname: "è‰¾æ–‡åš", avatarUrl: "https://pic1.imgdb.cn/item/6932846ad1e741a32bf1b9dc.jpg", subject: "ç”Ÿç‰©"},
            { nickname: "blue IHrNm", realname: "æ›¹ç‘¾ç‘œ", avatarUrl: "https://pic1.imgdb.cn/item/6932846ad1e741a32bf1b9db.jpg", subject: "æ”¿æ²»"},
            { nickname: "é™³é£", realname: "é™ˆæ—éœ„", avatarUrl: "https://pic1.imgdb.cn/item/6932846ad1e741a32bf1b9dd.jpg", subject: "ç”Ÿç‰©"},
            { nickname: "ç”°ç”°å°å½±å­", realname: "é™ˆèå½±", avatarUrl: "https://pic1.imgdb.cn/item/6932846ad1e741a32bf1b9d9.jpg", subject: "æ”¿æ²»"},
            { nickname: "CzX", realname: "é™ˆåœ¨èŠ¯", avatarUrl: "https://pic1.imgdb.cn/item/69328473d1e741a32bf1b9eb.jpg", subject: "ç”Ÿç‰©"},
            { nickname: "ğŸ¤", realname: "ç¨‹æ©æ³½", avatarUrl: "https://pic1.imgdb.cn/item/69328473d1e741a32bf1b9ec.jpg", subject: "ç”Ÿç‰©"},
            { nickname: "Il sole.", realname: "é‚“æ·¼", avatarUrl: "https://pic1.imgdb.cn/item/69328473d1e741a32bf1b9ed.jpg", subject: "ç”Ÿç‰©"},
            { nickname: "pit pony", realname: "é‚“è§æ™“", avatarUrl: "https://pic1.imgdb.cn/item/69328473d1e741a32bf1b9ee.jpg", subject: "ç”Ÿç‰©"},
            { nickname: "ç™½ç‹—é»‘", realname: "å†¯éº’éœ", avatarUrl: "https://pic1.imgdb.cn/item/69328435d1e741a32bf1b991.jpg", subject: "æ”¿æ²»"},
            { nickname: "é«˜å†·äººå£«æ²¡æœ‰å¾®ä¿¡", realname: "é«˜æ¶µäºˆ", avatarUrl: "https://api.dicebear.com/7.x/identicon/svg?seed=Felix", subject: "ç”Ÿç‰©"},
            { nickname: "æ³±æ³±æ¸…æ½­", realname: "é«˜ä¸€æ·³", avatarUrl: "https://pic1.imgdb.cn/item/69328477d1e741a32bf1b9f6.jpg", subject: "ç”Ÿç‰©"},
            { nickname: "èåœä¸æ¯”å°”", realname: "è¾œå­™é›¨è¾°", avatarUrl: "https://pic1.imgdb.cn/item/69328477d1e741a32bf1b9f9.jpg", subject: "æ”¿æ²»"},
            { nickname: "æ¬§çš‡çŸ¥åº•", realname: "ä½•å¥•å˜‰", avatarUrl: "https://pic1.imgdb.cn/item/69328436d1e741a32bf1b993.jpg", subject: "ç”Ÿç‰©"},
            { nickname: "åƒ", realname: "éŸ©é“­æ°", avatarUrl: "https://pic1.imgdb.cn/item/69328477d1e741a32bf1b9f7.jpg", subject: "ç”Ÿç‰©"},
            { nickname: "æ­¥æ³•é¹…", realname: "è¡¡æ˜Ÿç™", avatarUrl: "https://pic1.imgdb.cn/item/69328477d1e741a32bf1b9f5.jpg", subject: "ç”Ÿç‰©"},
            { nickname: "PhuDgue", realname: "èƒ¡é“¸", avatarUrl: "https://pic1.imgdb.cn/item/6932847ed1e741a32bf1ba05.jpg", subject: "ç”Ÿç‰©"},
            { nickname: "é»„å°å¦¹", realname: "é»„å½¦æ´", avatarUrl: "https://pic1.imgdb.cn/item/6932847ed1e741a32bf1ba02.jpg", subject: "ç”Ÿç‰©"},
            { nickname: "æ— æ™.", realname: "æå®‰ç„¶", avatarUrl: "https://pic1.imgdb.cn/item/694fe8e5161224305eb30b3e.jpg", subject: "ç”Ÿç‰©"},
            { nickname: "Touma Kazusa", realname: "ææŸ¯é”¦", avatarUrl: "https://pic1.imgdb.cn/item/6932847ed1e741a32bf1ba03.jpg", subject: "ç”Ÿç‰©"},
            { nickname: "Camilla", realname: "ææ—è”š", avatarUrl: "https://pic1.imgdb.cn/item/6932847ed1e741a32bf1ba04.jpg", subject: "ç”Ÿç‰©"},
            { nickname: "Eschatology", realname: "å»–å®¶å˜‰", avatarUrl: "https://pic1.imgdb.cn/item/69328489d1e741a32bf1ba10.jpg", subject: "ç”Ÿç‰©"},
            { nickname: "æœ‰æ‚ ", realname: "å»–è½©æµ©", avatarUrl: "https://pic1.imgdb.cn/item/69328489d1e741a32bf1ba12.jpg", subject: "æ”¿æ²»"},
            { nickname: "åˆ˜è½©", realname: "åˆ˜è½©", avatarUrl: "https://pic1.imgdb.cn/item/69328435d1e741a32bf1b98d.jpg", subject: "æ”¿æ²»"},
            { nickname: "è½©ğŸƒğŸ€", realname: "å•å­è½©", avatarUrl: "https://pic1.imgdb.cn/item/69328435d1e741a32bf1b992.jpg", subject: "ç”Ÿç‰©"},
            { nickname: "æ½æ˜Ÿæ²³", realname: "é©¬æ˜Ÿç¿", avatarUrl: "https://pic1.imgdb.cn/item/69328489d1e741a32bf1ba11.jpg", subject: "ç”Ÿç‰©"},
            { nickname: "å°å¤©æ‰æå®", realname: "å½­æ¸ä¸­", avatarUrl: "https://pic1.imgdb.cn/item/6932848fd1e741a32bf1ba1a.jpg", subject: "æ”¿æ²»"},
            { nickname: "æˆ‘åˆä¸æ˜¯è‹¦åŠ›", realname: "å”è±è”š", avatarUrl: "https://pic1.imgdb.cn/item/693286fdd1e741a32bf1bd63.jpg", subject: "ç”Ÿç‰©"},
            { nickname: "å°ç‹åœ¨æ­¤åˆ»", realname: "ç‹çˆ±é˜³", avatarUrl: "https://pic1.imgdb.cn/item/6932848fd1e741a32bf1ba1b.jpg", subject: "æ”¿æ²»"},
            { nickname: "æ¶µ", realname: "ç‹ä¹™æ¶µ", avatarUrl: "https://pic1.imgdb.cn/item/6932848fd1e741a32bf1ba19.jpg", subject: "ç”Ÿç‰©"},
            { nickname: "ä¸€åŒ—æå…‰", realname: "ç‹æ‡¿", avatarUrl: "https://pic1.imgdb.cn/item/6932848fd1e741a32bf1ba1c.jpg", subject: "ç”Ÿç‰©"},
            { nickname: "q7l12", realname: "ç‹é¢–è±", avatarUrl: "https://pic1.imgdb.cn/item/6932848fd1e741a32bf1ba1d.jpg", subject: "ç”Ÿç‰©"},
            { nickname: "Hello", realname: "ç‹èµæ°", avatarUrl: "https://pic1.imgdb.cn/item/69328494d1e741a32bf1ba23.jpg", subject: "ç”Ÿç‰©"},
            { nickname: "Takion Kroslin", realname: "éŸ¦æ™¯çš“", avatarUrl: "https://pic1.imgdb.cn/item/69328494d1e741a32bf1ba21.jpg", subject: "ç”Ÿç‰©"},
            { nickname: "Anonymous", realname: "é­ç†™èŠ®", avatarUrl: "https://pic1.imgdb.cn/item/69328494d1e741a32bf1ba25.jpg", subject: "ç”Ÿç‰©"},
            { nickname: "æ–‡ä¸‰", realname: "æ–‡æ€ç¿", avatarUrl: "https://pic1.imgdb.cn/item/69328494d1e741a32bf1ba22.jpg", subject: "ç”Ÿç‰©"},
            { nickname: "WCSDM", realname: "å´å‘ç‰", avatarUrl: "https://pic1.imgdb.cn/item/69328435d1e741a32bf1b98f.jpg", subject: "ç”Ÿç‰©"},
            { nickname: "è¥¿ç“œåˆ¨å†°", realname: "é²œå“å½¤", avatarUrl: "https://pic1.imgdb.cn/item/69328499d1e741a32bf1ba29.jpg", subject: "æ”¿æ²»"},
            { nickname: "æƒŸæ¥šæœ‰æ‰", realname: "å¾æ¥šçƒ¦", avatarUrl: "https://pic1.imgdb.cn/item/69328499d1e741a32bf1ba2b.jpg", subject: "ç”Ÿç‰©"},
            { nickname: "ç»­å™åº", realname: "å¾å­æ’", avatarUrl: "https://pic1.imgdb.cn/item/69328499d1e741a32bf1ba2c.jpg", subject: "æ”¿æ²»"},
            { nickname: "æ—‹è½¬â„ƒçš„æ—¶å…‰", realname: "æ¨æˆå®‡", avatarUrl: "https://pic1.imgdb.cn/item/69328499d1e741a32bf1ba2a.jpg", subject: "ç”Ÿç‰©"},
            { nickname: "Nernst", realname: "æ¨è‹¥é›·", avatarUrl: "https://pic1.imgdb.cn/item/69328499d1e741a32bf1ba2d.jpg", subject: "ç”Ÿç‰©"},
            { nickname: "é¼ äº†", realname: "æ¨å®£æµ©", avatarUrl: "https://pic1.imgdb.cn/item/6932849cd1e741a32bf1ba31.jpg", subject: "æ”¿æ²»"},
            { nickname: "é›é¸£", realname: "æ¨æ‡¿", avatarUrl: "https://pic1.imgdb.cn/item/6932849cd1e741a32bf1ba34.jpg", subject: "ç”Ÿç‰©"},
            { nickname: "Ray", realname: "å¼ æ·™ç¿", avatarUrl: "https://pic1.imgdb.cn/item/6932849cd1e741a32bf1ba32.jpg", subject: "ç”Ÿç‰©"},
            { nickname: "ä¸è¡€åè™¾é—°åœŸçš„çŒ¹", realname: "å¼ æ¢“è½©", avatarUrl: "https://pic1.imgdb.cn/item/6932849cd1e741a32bf1ba35.jpg", subject: "ç”Ÿç‰©"},
            { nickname: "AQ", realname: "èµµæ½œ", avatarUrl: "https://pic1.imgdb.cn/item/6932849cd1e741a32bf1ba33.jpg", subject: "æ”¿æ²»"},
            { nickname: "(ï¼ï¼œ)", realname: "èµµç§‹ç‰", avatarUrl: "https://pic1.imgdb.cn/item/693284a1d1e741a32bf1ba3a.jpg", subject: "ç”Ÿç‰©"},
            { nickname: "Zfang", realname: "éƒ‘æ”¾", avatarUrl: "https://pic1.imgdb.cn/item/693284a1d1e741a32bf1ba3c.jpg", subject: "ç”Ÿç‰©"},
            { nickname: "Emmanuel", realname: "å‘¨æŸ¯è¿", avatarUrl: "https://pic1.imgdb.cn/item/69328435d1e741a32bf1b98e.jpg", subject: "ç”Ÿç‰©"},
            { nickname: "y", realname: "é‚¹å¤©æ°", avatarUrl: "https://pic1.imgdb.cn/item/693284a1d1e741a32bf1ba3b.jpg", subject: "ç”Ÿç‰©"},
            { nickname: "LZZN", realname: "åˆ˜çŸ¥æ˜“", avatarUrl: "https://pic1.imgdb.cn/item/693d6d7ffe7cfeca3822ee6f.jpg", subject: "ç”Ÿç‰©"},

        ];
        
        const SKILLS = [
            { type: "skill", nickname: "ä¸‡ç®­é½å‘", realname: "ä¸‡ç®­é½å‘", avatarUrl: "", hasAvatar: false, isSpecial: true, rarity: 'legend', className: 'skill-item' },
            { type: "skill", nickname: "é“ç´¢è¿ç¯", realname: "é“ç´¢è¿ç¯", avatarUrl: "", hasAvatar: false, isSpecial: true, rarity: 'epic', className: 'skill-item' },
            { type: "skill", nickname: "å€Ÿåˆ€æ€äºº", realname: "å€Ÿåˆ€æ€äºº", avatarUrl: "", hasAvatar: false, isSpecial: true, rarity: 'epic', className: 'skill-item' },
            { type: "skill", nickname: "æ¡ƒå›­ç»“ä¹‰", realname: "æ¡ƒå›­ç»“ä¹‰", avatarUrl: "", hasAvatar: false, isSpecial: true, rarity: 'rare', className: 'skill-item' },
            { type: "skill", nickname: "ç«çˆ†è¾£æ¤’", realname: "ç«çˆ†è¾£æ¤’", avatarUrl: "", hasAvatar: false, isSpecial: true, rarity: 'rare', className: 'skill-item' },
            { type: "skill", nickname: "ä¸‹ä¸ªåŒå€", realname: "ä¸‹ä¸ªåŒå€", avatarUrl: "", hasAvatar: false, isSpecial: true, rarity: 'legend', className: 'skill-item' },
        ];
        
        const TEACHERS = [
            { type: "teacher", nickname: "90åé‡‘æµª", realname: "é‡‘æµª", avatarUrl: "https://pic1.imgdb.cn/item/6946ad3c29a616e528622640.png", hasAvatar: true, isSpecial: true, rarity: 'legend', className: 'teacher-item' },
            { type: "teacher", nickname: "é£æ¸…æ‰¬", realname: "åˆ˜å·", avatarUrl: "https://pic1.imgdb.cn/item/694fea95161224305eb30b63.jpg", hasAvatar: true, isSpecial: true, rarity: 'epic', className: 'teacher-item' },
            { type: "teacher", nickname: "åˆ˜è¶…", realname: "åˆ˜è¶…", avatarUrl: "", hasAvatar: false, isSpecial: true, rarity: 'epic', className: 'teacher-item' },
            { type: "teacher", nickname: "ç‹ç›¼", realname: "ç‹ç›¼", avatarUrl: "", hasAvatar: false, isSpecial: true, rarity: 'rare', className: 'teacher-item' },
            { type: "teacher", nickname: "è¦ƒå‹¤", realname: "è¦ƒå‹¤", avatarUrl: "", hasAvatar: false, isSpecial: true, rarity: 'rare', className: 'teacher-item' },
            { type: "teacher", nickname: "éŸ¦å»ºå†›", realname: "éŸ¦å»ºå†›", avatarUrl: "", hasAvatar: false, isSpecial: true, rarity: 'rare', className: 'teacher-item' },
            { type: "teacher", nickname: "ç‹ä¿Šä¸œ", realname: "ç‹ä¿Šä¸œ", avatarUrl: "", hasAvatar: false, isSpecial: true, rarity: 'rare', className: 'teacher-item' },
        ];

        const startPhrases = [
            "è®©æˆ‘çœ‹çœ‹è°åœ¨ç´§å¼ ", "æ˜¯è°çš„å°é¹¿åœ¨ä¹±æ’", "æ·±å‘¼å¸ï¼Œå¤´æ™•æ˜¯æ­£å¸¸çš„",
            "åˆ«èº²äº†ï¼Œæˆ‘éƒ½çœ‹åˆ°ä½ äº†", "æ­¤æ—¶ä¸€åå¹¸è¿è§‚ä¼—æ±—æµæµƒèƒŒ", "å‘½è¿çš„é½¿è½®å¼€å§‹è½¬åŠ¨",
            "åªæ˜¯æŠ½ä¸ªæŸ¥ï¼Œåˆ«æ…Œ", "çœ¼ç¥åˆ«é£˜ï¼Œçœ‹ç€æˆ‘", "å‡†å¤‡å¥½ä½ çš„è¡¨æ¼”äº†å—", "è®©æˆ‘åº·åº·æ˜¯è°è¿™ä¹ˆå¹¸è¿"
        ];
        
        // --- 2. å˜é‡å®šä¹‰ ---
        // è¯´æ˜ï¼šæ­¤å¤„ä¸ºè¿è¡Œæ—¶ä½¿ç”¨çš„ DOM å¼•ç”¨ä¸çŠ¶æ€å˜é‡ã€‚
        // - DOM å¼•ç”¨ï¼ˆä¾‹å¦‚ nameDisplayã€avatarBox ç­‰ï¼‰ç”¨äºåœ¨å‡½æ•°ä¸­è¯»å†™ç•Œé¢å…ƒç´ ã€‚
        // - çŠ¶æ€å˜é‡ï¼ˆä¾‹å¦‚ isRollingã€isRealNameShowing ç­‰ï¼‰è®°å½•å½“å‰æŠ½ç­¾æµç¨‹ä¸åŠ¨ç”»çŠ¶æ€ï¼Œ
        //   å¯é¿å…åœ¨åŠ¨ç”»æœªå®Œæˆæ—¶é‡å¤è§¦å‘å†²çªçš„è¡Œä¸ºã€‚
        const nameDisplay = document.getElementById('name-display');
        const btnMain = document.getElementById('btn-main');
        const avatarBox = document.getElementById('avatar-box');
        const avatarImg = document.getElementById('avatar-img');
        const nonPersonNameDisplay = document.getElementById('non-person-name-display');
        const btnFilter = document.getElementById('btn-filter');
        const filterText = document.getElementById('filter-text');
        const filterMenu = document.getElementById('filter-menu');
        const btnInstantMode = document.getElementById('btn-instant-mode');
        
        const baseOptions = document.querySelectorAll('.filter-option.base-option');
        const bonusOptions = document.querySelectorAll('.filter-option.bonus-option');

        let isRolling = false;
        let timer = null;
        let selectedUser = null; 
        let isRealNameShowing = false; 
        
        let currentGroup = 'æ‰€æœ‰äºº'; 
        let activeBonuses = [];      
        let isInstantMode = false;

        let filteredDatabase = []; 
        let shuffleIndex = 0; 
        let shuffledList = []; 
        
        let nextSelectedUser = null;

        // --- 3. æ ¸å¿ƒåŠŸèƒ½å‡½æ•° ---
        // è¯´æ˜ï¼šè¿™é‡ŒåŒ…å«ç¨‹åºçš„ä¸»è¦é€»è¾‘å‡½æ•°ï¼ŒæŒ‰åŠŸèƒ½å¯ä»¥åˆ†ä¸ºï¼š
        // - è¾…åŠ©/å·¥å…·å‡½æ•°ï¼ˆå¦‚é¢œè‰²ç”Ÿæˆã€è·å–ä¸‹ä¸€ä¸ªé¡¹ç›®ç­‰ï¼‰
        // - æŠ½ç­¾æ§åˆ¶æµï¼ˆå¼€å§‹/åœæ­¢/å¤„ç†å³æ—¶æŠ½å–/å‡†å¤‡ä¸‹ä¸€è½®ç­‰ï¼‰
        // - æ¸²æŸ“ä¸åŠ¨ç”»è§¦å‘ï¼ˆæ›´æ–°å¤´åƒã€æ’­æ”¾å…¥åœº/æ­ªå¤´/æ¢å¤åŠ¨ç”»ã€åˆ‡æ¢å§“åæ˜¾ç¤ºç­‰ï¼‰
        // - äº‹ä»¶å“åº”ï¼ˆç‚¹å‡»ã€é”®ç›˜ã€è¿‡æ»¤å™¨äº¤äº’ç­‰ç»‘å®šåœ¨æ–‡ä»¶æœ«å°¾ï¼‰

        // è¾…åŠ©å‡½æ•°ï¼šä¸ºå­¦ç”Ÿå¤´åƒç”Ÿæˆéšæœºæ¸å˜è‰²
        function setStudentColors() {
            // å®šä¹‰å‡ ç»„å¥½çœ‹çš„æ¸å˜é…è‰²
            const gradients = [
                ['#42a5f5', '#7e57c2'], // è“ç´«
                ['#ff7043', '#ffca28'], // æ©™é»„
                ['#26a69a', '#66bb6a'], // é’ç»¿
                ['#ec407a', '#ab47bc'], // ç²‰ç´«
                ['#5c6bc0', '#29b6f6']  // é›è“
            ];
            const rand = gradients[Math.floor(Math.random() * gradients.length)];
            avatarBox.style.setProperty('--c1', rand[0]);
            avatarBox.style.setProperty('--c2', rand[1]);
            avatarBox.style.setProperty('--glow', rand[0] + '33'); // 20%é€æ˜åº¦
        }

        function filterAndShuffleDatabase() {
            let studentList;
            if (currentGroup === 'æ‰€æœ‰äºº') {
                studentList = [...database];
            } else {
                studentList = database.filter(user => user.subject === currentGroup);
            }

            let specialItems = [];
            if (activeBonuses.includes('æŠ€èƒ½')) {
                specialItems = specialItems.concat(SKILLS);
            }
            if (activeBonuses.includes('è€å¸ˆ')) {
                specialItems = specialItems.concat(TEACHERS);
            }
            
            if (studentList.length === 0 && specialItems.length > 0) {
                 filteredDatabase = specialItems;
            } else if (studentList.length > 0) {
                filteredDatabase = studentList.concat(specialItems);
            } else {
                filteredDatabase = [];
            }
            
            if (filteredDatabase.length === 0) {
                nameDisplay.innerText = `æ— æ•°æ® (${currentGroup})`;
                btnMain.disabled = true;
                return false;
            }
            
            btnMain.disabled = false;
            
            shuffledList = [...filteredDatabase]; 
            for (let i = shuffledList.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1)); 
                [shuffledList[i], shuffledList[j]] = [shuffledList[j], shuffledList[i]];
            }
            
            shuffleIndex = 0;
            return true;
        }

        function getNextShuffledItem() {
            if (shuffleIndex >= shuffledList.length) {
                if (!filterAndShuffleDatabase()) {
                    return null;
                }
                console.log("åˆ—è¡¨å·²æŠ½å®Œï¼Œé‡æ–°æ´—ç‰Œã€‚");
            }
            const item = shuffledList[shuffleIndex];
            shuffleIndex++; 
            return item;
        }
        
        function prepareNextDraw() {
            nextSelectedUser = getNextShuffledItem();
            if (nextSelectedUser) {
                const shouldUseAvatar = !nextSelectedUser.isSpecial || nextSelectedUser.hasAvatar === true;
                if (shouldUseAvatar && nextSelectedUser.avatarUrl) {
                    const img = new Image();
                    img.src = nextSelectedUser.avatarUrl;
                }
            }
        }
        
        
        function startRolling() {
            if (isRolling) return; 
            // å¦‚æœæ˜¯ç›´æ¥æŠ½å–æ¨¡å¼
            if (isInstantMode) {
                // å¦‚æœå½“å‰å¤„äºæ­ªå¤´çŠ¶æ€ï¼Œå…ˆæ¸…é™¤ï¼Œä½†ä¸åšåŠ¨ç”»ï¼Œç›´æ¥æ¶ˆå¤±
                if (isTilted()) {
                    avatarBox.classList.remove('tilt-left-anim', 'tilt-right-anim', 'tilt-drop-anim', 'tilt-recover-anim', 'is-tilted');
                }

                // æ‰§è¡Œæ”¶ç¼©å¸å…¥éšè—ä¸Šä¸€ä¸ªå¤´åƒ
                triggerShrinkHide();
                btnMain.disabled = true;

                setTimeout(() => {
                    handleInstantDraw();
                }, 500); // ç­‰å¾…å¸å…¥åŠ¨ç”»å®Œæˆ
                return;
            }

            // æ™®é€šæ»šåŠ¨æ¨¡å¼
            // æ¯æ¬¡å¼€å§‹å‰ï¼Œæ¸…ç†æ‰€æœ‰ç‰¹æ®ŠçŠ¶æ€å’ŒåŠ¨ç”»
            avatarBox.classList.remove('anim-legend', 'anim-epic', 'anim-rare', 'card-animate', 
                                       'tilt-left-anim', 'tilt-right-anim', 'tilt-drop-anim', 'tilt-recover-anim', 'is-tilted');
            // æ¸…ç†ä»»ä½•ä¹‹å‰é€šè¿‡ JS è®¾ç½®çš„è‡ªå®šä¹‰æ ·å¼ï¼ˆè¾¹æ¡†/å…‰æ•ˆï¼‰
            // ç„¶åè§¦å‘æ”¶ç¼©å¸å…¥éšè—ä¸Šä¸€ä¸ªå¤´åƒ
            triggerShrinkHide();
            btnMain.disabled = true;

            // ç­‰å¾…æ¶ˆå¤±åŠ¨ç”»(300-500ms)åå¼€å§‹æ»šåŠ¨åå­—
            setTimeout(() => {
                if (!nextSelectedUser && !filterAndShuffleDatabase()) {
                    btnMain.disabled = false;
                    return; 
                }
                if (!nextSelectedUser) {
                    prepareNextDraw();
                    if(!nextSelectedUser) return;
                }
                doStartRollLogic();
            }, 300);
        }
        
        function handleInstantDraw() {
            btnMain.disabled = true;
            
            // å‡†å¤‡æ•°æ®
            if (!nextSelectedUser && !filterAndShuffleDatabase()) {
                btnMain.disabled = false;
                return;
            }
            if (!nextSelectedUser) prepareNextDraw();
            selectedUser = nextSelectedUser;
            
            // ç›´æ¥æ˜¾ç¤ºç»“æœ
            renderResult(selectedUser);
            
            prepareNextDraw();
        }
        
        function doStartRollLogic() {
            isRolling = true;
            btnMain.disabled = true; 
            btnMain.innerText = "æŠ½å–"; 
            
            avatarBox.classList.remove('show'); 
            
            // é‡ç½®çŠ¶æ€
            nameDisplay.classList.remove('slide-out-up', 'slide-in-up');
            isRealNameShowing = false; 
            nameDisplay.style.backgroundColor = "#f7f7f7";
            nameDisplay.style.borderColor = "#f0f0f0";

            timer = setInterval(() => {
                const randomIndex = Math.floor(Math.random() * filteredDatabase.length);
                nameDisplay.innerText = filteredDatabase[randomIndex].nickname;
            }, 50); 
            
            setTimeout(() => {
                if (isRolling) { 
                    btnMain.disabled = false;
                }
            }, 300); 
        }

        function stopRolling() {
            if (!isRolling) return; 
            
            isRolling = false;
            btnMain.disabled = true; 
            btnMain.innerText = "å¼€å§‹æ»šåŠ¨";
            clearInterval(timer);

            selectedUser = nextSelectedUser;
            renderResult(selectedUser);
            prepareNextDraw(); 
        }

        function renderResult(user) {
            if (!user) return;

            nameDisplay.innerText = user.nickname;

            const isSpecialItem = user.isSpecial;
            const hasAvatar = user.hasAvatar === true; 
            const rarity = user.rarity || 'rare'; 

            // é‡ç½®åŸºç¡€ç±»
            avatarBox.className = 'avatar-container'; 
            
            // 1. è®¾ç½®å†…å®¹æ¨¡å¼ (å›¾ç‰‡ vs æ–‡å­—)
            if (isSpecialItem && !hasAvatar) {
                // ç‰¹æ®Šç‰©å“æ— å¤´åƒ -> çº¯æ–‡å­—
                avatarBox.classList.add('hide-img', user.className || 'skill-item');
                // ç‰¹æ®Šç‰©å“æ— å¤´åƒæ—¶ä¹Ÿä¸ç”¨Hoveræ”¾å¤§
                avatarBox.classList.add('no-hover-effect');
                nonPersonNameDisplay.innerText = user.nickname;
                nonPersonNameDisplay.style.display = 'flex'; 
                avatarImg.style.display = 'none';
                
                // ç§»é™¤å­¦ç”Ÿè¾¹æ¡†ï¼Œé˜²æ­¢é¢œè‰²æ®‹ç•™
                avatarBox.classList.remove('student-border', 'glow');
                avatarBox.style.removeProperty('--c1');
                avatarBox.style.removeProperty('--c2');
                avatarBox.style.removeProperty('--glow');
            } else {
                // å­¦ç”Ÿ æˆ– æœ‰å¤´åƒçš„è€å¸ˆ -> å›¾ç‰‡
                avatarImg.src = user.avatarUrl;
                avatarImg.style.display = 'block'; 
                nonPersonNameDisplay.style.display = 'none';
                avatarBox.classList.remove('hide-img', 'skill-item', 'teacher-item', 'no-hover-effect');
                
                // å¦‚æœæ˜¯å­¦ç”Ÿ(éç‰¹æ®Š)ï¼Œåº”ç”¨å­¦ç”Ÿä¸“å±è¾¹æ¡†å’Œéšæœºé¢œè‰²
                if (!isSpecialItem) {
                    avatarBox.classList.add('student-border', 'glow');
                    setStudentColors();
                } else {
                    // æœ‰å¤´åƒçš„ç‰¹æ®Šè§’è‰²(è€å¸ˆ)ï¼Œæ¸…é™¤å­¦ç”Ÿè¾¹æ¡†
                    avatarBox.classList.remove('student-border', 'glow');
                }
            }

            // 2. åº”ç”¨å…¥åœºåŠ¨ç”»ç±»
            let animClass = 'card-animate'; // é»˜è®¤å­¦ç”Ÿ: ç»å…¸ç¿»è½¬
            if (isSpecialItem) {
                if (rarity === 'legend') animClass = 'anim-legend';
                else if (rarity === 'epic') animClass = 'anim-epic';
                else animClass = 'anim-rare';
            }
            
            void avatarBox.offsetWidth; // å¼ºåˆ¶é‡ç»˜
            avatarBox.classList.add(animClass);

            // åŠ¨ç”»æ—¶é•¿æ§åˆ¶
            const animationDuration = isSpecialItem ? 1300 : 1800;
            
            setTimeout(() => {
                avatarBox.classList.add('show'); 
                btnMain.disabled = false;
                if (isInstantMode) {
                    btnMain.innerText = "ç‚¹å‡»æŠ½å–";
                } else {
                    btnMain.innerText = "å¼€å§‹æ»šåŠ¨";
                }
            }, animationDuration);
        }

        // --- ä¿®å¤ä»£ç å¼€å§‹ï¼šJS æ­ªå¤´æ§åˆ¶é€»è¾‘ ---

        // 1. åˆ¤æ–­å½“å‰å¤´åƒæ˜¯å¦å¤„äºæ­ªæ‰çš„çŠ¶æ€
        function isTilted() {
            return avatarBox.classList.contains('tilt-left-anim') ||
                   avatarBox.classList.contains('tilt-right-anim') ||
                   avatarBox.classList.contains('tilt-drop-anim');
        }

        // 2. åº”ç”¨éšæœºæ­ªå¤´åŠ¨ç”»
        function applyRandomTilt() {
            // ç§»é™¤å¯èƒ½å­˜åœ¨çš„æ¢å¤åŠ¨ç”»
            avatarBox.classList.remove('tilt-recover-anim');
            // æ·»åŠ æ ‡è®°ï¼Œç”¨äº CSS ä¸­ç¦ç”¨ hover æ•ˆæœ
            avatarBox.classList.add('is-tilted');
            // ç¡®ä¿æ¸…é™¤ä»»ä½•ä¸´æ—¶çš„ `no-anim` æŠ‘åˆ¶ï¼Œä»¥å…è®¸æ­ªå¤´åŠ¨ç”»æ­£å¸¸æ’­æ”¾
            avatarBox.classList.remove('no-anim');

            // ç§»é™¤ä»»ä½•å·²å­˜åœ¨çš„æ­ªå¤´ç±»ï¼Œä»¥ä¾¿é‡æ–°æ·»åŠ æ—¶èƒ½é‡æ–°è§¦å‘åŠ¨ç”»
            avatarBox.classList.remove('tilt-left-anim', 'tilt-right-anim', 'tilt-drop-anim');
            // åŒæ—¶ç§»é™¤å…¥åœº/æŠ½å–åŠ¨ç”»ç±»ï¼Œé¿å…é˜»å¡æ­ªå¤´åŠ¨ç”»
            ['card-animate', 'anim-legend', 'anim-epic', 'anim-rare', 'special-draw-effect'].forEach(c => avatarBox.classList.remove(c));
            // å¼ºåˆ¶é‡ç»˜ä»¥ç¡®ä¿ CSS åŠ¨ç”»å¯é é‡å¯
            void avatarBox.offsetWidth;

            const r = Math.random();
            if (r < 0.33) {
                avatarBox.classList.add('tilt-left-anim');
            } else if (r < 0.66) {
                avatarBox.classList.add('tilt-right-anim');
            } else {
                avatarBox.classList.add('tilt-drop-anim');
            }
        }

        // 3. æ¢å¤æ­£å¸¸ä½ç½® (å¸¦åŠ¨ç”»)
        function restoreTilt() {
            if (!isTilted()) return;
            
            // å†»ç»“å½“å‰å¯è§†çŠ¶æ€ï¼šè¯»å–è®¡ç®—åçš„ transform å¹¶åœ¨å†…è”æ ·å¼ä¸­åº”ç”¨
            const cs = window.getComputedStyle(avatarBox);
            const currentTransform = cs.transform || 'none';

            // ç§»é™¤æ­ªå¤´åŠ¨ç”»ç±»ä»¥åœæ­¢åŠ¨ç”»ï¼Œä½†é€šè¿‡å†…è”è®¾ç½®è®¡ç®—å‡ºçš„ transform æ¥ä¿ç•™å½“å‰å¯è§å¤–è§‚
            avatarBox.classList.remove('tilt-left-anim', 'tilt-right-anim', 'tilt-drop-anim');
            // ä¸´æ—¶ç§»é™¤å…¥åœº/æŠ½å–åŠ¨ç”»ç±»ä»¥é¿å…ä¸æ¢å¤åŠ¨ç”»å†²çªã€‚
            // æ³¨æ„ï¼šä¸è¦æ·»åŠ  `.no-anim`ï¼Œå› ä¸ºå®ƒåŒ…å« `animation: none !important`ï¼Œä¼šç¦ç”¨æ¢å¤åŠ¨ç”»ã€‚
            ['card-animate', 'anim-legend', 'anim-epic', 'anim-rare', 'special-draw-effect'].forEach(c => avatarBox.classList.remove(c));
            if (currentTransform && currentTransform !== 'none') {
                avatarBox.style.transform = currentTransform;
            }

            // æ¢å¤æœŸé—´ä¿æŒ hover ç¦ç”¨ï¼Œé¿å…ç”¨æˆ·äº¤äº’æ”¹å˜å¤–è§‚
            avatarBox.classList.add('is-tilted');

            // æ¢å¤è¿‡ç¨‹ä¸­ï¼Œå¹³æ»‘åœ°å°†å§“ååˆ‡å›ä¸ºç½‘åæ˜¾ç¤º
            nameDisplay.classList.remove('slide-in-up', 'slide-out-up');
            void nameDisplay.offsetWidth;
            nameDisplay.classList.add('slide-out-up');
            setTimeout(() => {
                isRealNameShowing = false;
                nameDisplay.innerText = selectedUser ? selectedUser.nickname : nameDisplay.innerText;
                nameDisplay.classList.remove('slide-out-up');
                nameDisplay.classList.add('slide-in-up');
            }, 160);

            // å¼ºåˆ¶æ ·å¼åˆ·æ–°ä»¥ç«‹å³åº”ç”¨å†…è” transform
            void avatarBox.offsetWidth;

            // è§¦å‘å¹³æ»‘æ¢å¤åŠ¨ç”»å›åˆ°åˆå§‹ï¼ˆæ— ï¼‰å˜æ¢
            avatarBox.classList.remove('tilt-recover-anim');
            void avatarBox.offsetWidth;
            avatarBox.classList.add('tilt-recover-anim');

            let cleaned = false;
            function cleanUp() {
                if (cleaned) return;
                cleaned = true;
                avatarBox.classList.remove('tilt-recover-anim');
                avatarBox.style.transform = '';
                avatarBox.classList.remove('is-tilted');
                // ä¸è¦è§¦ç¢° card-animate/anim-legend ç­‰ç±»ï¼Œä¿ç•™å…¥åœºçŠ¶æ€
                avatarBox.removeEventListener('animationend', onEnd);
            }

            function onEnd(e) {
                if (e.animationName === 'tilt-back-smooth') {
                    cleanUp();
                }
            }
            avatarBox.addEventListener('animationend', onEnd);

            // å¤‡ç”¨æ–¹æ¡ˆï¼šå¦‚æœæœªè§¦å‘ animationendï¼Œåˆ™åœ¨æ¯”åŠ¨ç”»æ—¶é•¿ç•¥é•¿çš„æ—¶é—´åå¼ºåˆ¶æ¸…ç†
            setTimeout(() => {
                cleanUp();
            }, 600);
        }

        // 4. ä¿®æ”¹ç‚¹å‡»å¤´åƒçš„é€»è¾‘ (toggleRealName)
        function toggleRealName() {
            if (!selectedUser) return;
            
            // ã€ä¿®å¤é€»è¾‘ã€‘ï¼šå¦‚æœå·²ç»åœ¨æ­ªå¤´çŠ¶æ€ï¼Œç‚¹å‡»åˆ™å¤ä½ï¼Œä¸å†åˆ‡æ¢åå­—
            if (isTilted()) {
                restoreTilt();
                return; 
            }

            // å¦‚æœæ²¡æœ‰æ­ªå¤´ï¼Œæ‰§è¡Œï¼šåˆ‡æ¢åå­— + éšæœºæ­ªå¤´
            applyRandomTilt(); 

            // ä¸‹é¢æ˜¯åŸæœ‰çš„åˆ‡æ¢åå­—åŠ¨ç”»é€»è¾‘
            nameDisplay.classList.remove('slide-in-up', 'slide-out-up');
            void nameDisplay.offsetWidth; 
            nameDisplay.classList.add('slide-out-up');

            setTimeout(() => {
                isRealNameShowing = !isRealNameShowing;
                
                if (isRealNameShowing) {
                    nameDisplay.innerText = selectedUser.realname;
                    nameDisplay.style.backgroundColor = "#f7f7f7"; 
                } else {
                    nameDisplay.innerText = selectedUser.nickname;
                    nameDisplay.style.backgroundColor = "#f7f7f7";
                }
                
                nameDisplay.classList.remove('slide-out-up');
                nameDisplay.classList.add('slide-in-up');
            }, 200);
        }

        // --- ä¿®å¤ä»£ç ç»“æŸ ---

        function updateFilterButtonText() {
            let text = currentGroup;
            if (activeBonuses.length > 0) {
                text += ` + ${activeBonuses.join('/')}`;
            }
            filterText.innerText = text;
        }

        // è¾…åŠ©ï¼šä»å¯è§çŠ¶æ€å¯é æ‰§è¡Œæ”¶ç¼©éšè—åŠ¨ç”»ï¼ˆç”¨äºå¼€å§‹æ–°ä¸€è½®æŠ½å–æ—¶å¹³æ»‘éšè—ï¼‰
        function triggerShrinkHide() {
            // ç¡®ä¿åŠ¨ç”»å¯ä»¥è¿è¡Œï¼Œç§»é™¤ä»»ä½•ä¸æŠ½å–ç›¸å…³çš„æ´»åŠ¨åŠ¨ç”»ç±»
            avatarBox.classList.remove('no-anim');
            ['card-animate', 'anim-legend', 'anim-epic', 'anim-rare', 'special-draw-effect'].forEach(c => avatarBox.classList.remove(c));
            // åŒæ—¶æ¸…é™¤ä»»ä½•å†…è”çš„ animation/transition ä»¥é¿å…å†²çª
            avatarBox.style.animation = '';
            avatarBox.style.transition = '';

            // ç¡®ä¿è®¡ç®—çš„çŠ¶æ€ä¸ºå¯è§ï¼Œä»¥ä¾¿ä»å¯è§ -> æ”¶ç¼© çš„è¿‡æ¸¡èƒ½æ­£ç¡®æ’­æ”¾
            avatarBox.classList.add('show');
            // å¼ºåˆ¶æ ·å¼åˆ·æ–°
            void avatarBox.offsetWidth;
            // æ·»åŠ è§¦å‘æ”¶ç¼©å¹¶æ·¡å‡ºçš„ç±»
            avatarBox.classList.add('shrink-hide');
            // åŠ¨ç”»ç»“æŸåç§»é™¤æ ‡è®°ï¼Œæ¢å¤æ¸…æ´çŠ¶æ€
            setTimeout(() => {
                avatarBox.classList.remove('show');
                avatarBox.classList.remove('shrink-hide');
            }, 520);
        }

        // --- 4. äº‹ä»¶ç›‘å¬å™¨ ---

        btnMain.addEventListener('click', () => {
            if (isInstantMode) {
                startRolling(); 
            } else {
                if (isRolling) stopRolling();
                else startRolling();
            }
        });

        // 2. ç©ºæ ¼é”®æ§åˆ¶
        document.addEventListener('keydown', (e) => {
            if (e.code === 'Space') {
                e.preventDefault(); 
                if (btnMain.disabled) return; 
                btnMain.click();
            }
        });

        // ç‚¹å‡»å¤´åƒåˆ‡æ¢åå­—
        avatarBox.addEventListener('click', (e) => {
            e.stopPropagation(); 
            toggleRealName(); 
        });

        // ä¿®å¤ï¼šç‚¹å‡»ç©ºç™½å¤„å¤ä½
        document.addEventListener('click', (e) => {
            if (!btnFilter.contains(e.target) && !filterMenu.contains(e.target)) {
                 if(filterMenu.classList.contains('open')) {
                    filterMenu.classList.remove('open');
                    btnFilter.classList.remove('active');
                 }
            }
            
            if (!avatarBox.contains(e.target) && isTilted()) {
                restoreTilt();
            }
        });

        btnFilter.addEventListener('click', (e) => {
            e.stopPropagation(); 
            filterMenu.classList.toggle('open');
            btnFilter.classList.toggle('active');
        });
        
        filterMenu.addEventListener('click', (e) => {
             e.stopPropagation();
        });

        function handleFilterChange() {
            // ä¿®å¤é€»è¾‘ï¼šåˆ‡æ¢é€‰ç§‘æ—¶ï¼Œå…ˆæ‰§è¡Œå¸å…¥æ¶ˆå¤±åŠ¨ç”»
            avatarBox.classList.remove('show');
            // æ¸…é™¤æ­ªå¤´çŠ¶æ€
            if (isTilted()) {
                avatarBox.classList.remove('tilt-left-anim', 'tilt-right-anim', 'tilt-drop-anim', 'tilt-recover-anim', 'is-tilted');
            }
            
            setTimeout(() => {
                updateFilterButtonText();
                filterAndShuffleDatabase();
                prepareNextDraw();
                nameDisplay.innerText = startPhrases[Math.floor(Math.random() * startPhrases.length)];
                selectedUser = null;
            }, 500); 
        }

        baseOptions.forEach(option => {
            option.addEventListener('click', () => {
                const newGroup = option.dataset.value;
                if (currentGroup !== newGroup) {
                    baseOptions.forEach(o => o.classList.remove('selected'));
                    option.classList.add('selected');
                    currentGroup = newGroup;
                    handleFilterChange();
                }
                filterMenu.classList.remove('open');
                btnFilter.classList.remove('active');
            });
        });

        bonusOptions.forEach(option => {
            option.addEventListener('click', () => {
                option.classList.toggle('selected');
                const bonusValue = option.dataset.value;
                
                if (option.classList.contains('selected')) {
                    if (!activeBonuses.includes(bonusValue)) activeBonuses.push(bonusValue);
                } else {
                    activeBonuses = activeBonuses.filter(b => b !== bonusValue);
                }
                handleFilterChange();
            });
        });

        // 3. ç›´æ¥æŠ½å–æ¨¡å¼åˆ‡æ¢
        btnInstantMode.addEventListener('click', () => {
            isInstantMode = !isInstantMode;
            btnInstantMode.classList.toggle('selected');
            
            if (isInstantMode) {
                btnMain.innerText = "ç‚¹å‡»æŠ½å–";
            } else {
                btnMain.innerText = "å¼€å§‹æ»šåŠ¨";
            }
            
            filterMenu.classList.remove('open');
            btnFilter.classList.remove('active');
        });

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            filterAndShuffleDatabase();
            prepareNextDraw();
            updateFilterButtonText();
            nameDisplay.innerText = startPhrases[Math.floor(Math.random() * startPhrases.length)];
        });

    </script>
</body>
</html>