<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åˆ«ç´§å¼ </title>
    <link rel="icon" href="https://pic1.imgdb.cn/item/693d67f925ec9c13612be403.jpg" type="image/jpeg">
    
    <style>
        /* --- å…¨å±€æ ·å¼ --- */
        body {
            margin: 0;
            padding: 0;
            background-color: #ffffff;
            color: #000000;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Helvetica Neue", Helvetica, Arial, sans-serif;
            height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-between; 
            overflow: hidden;
            perspective: 1000px;
        }

        .main-content {
            flex-grow: 1; 
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 100%;
            position: relative;
        }

        /* --- è¿‡æ»¤å™¨æ ·å¼ --- */
        .filter-container {
            position: relative;
            z-index: 1000;
            margin-bottom: 20px;
            display: flex; 
        }

        #btn-filter {
            background-color: #fff;
            color: #000;
            border: 1px solid #e0e0e0;
            padding: 10px 24px;
            min-width: 120px;
            font-size: 15px;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        #btn-filter:hover {
            background-color: #f9f9f9;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transform: translateY(-1px);
        }

        #btn-filter.active {
            background-color: #000;
            color: #fff;
            border-color: #000;
        }

        .filter-menu {
            position: absolute;
            top: calc(100% + 10px); 
            left: 50%;
            transform: translateX(-50%) translateY(-10px);
            background-color: #fff;
            border: none;
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            padding: 6px;
            min-width: 140px;
            opacity: 0;
            visibility: hidden;
            transition: all 0.25s cubic-bezier(0.2, 0.8, 0.2, 1);
        }

        .filter-menu.open {
            opacity: 1;
            visibility: visible;
            transform: translateX(-50%) translateY(0);
        }

        .filter-option {
            padding: 10px 16px;
            cursor: pointer;
            font-size: 14px;
            color: #333;
            border-radius: 10px;
            text-align: center;
            transition: background-color 0.2s;
            margin-bottom: 2px;
        }

        .filter-option:last-child { margin-bottom: 0; }
        .filter-option:hover { background-color: #f5f5f5; }

        .filter-option.base-option.selected {
            background-color: #000;
            color: #fff;
            font-weight: 600;
        }
        
        .filter-option.bonus-option { color: #333; font-weight: normal; }
        .filter-option.bonus-option:hover { background-color: #f5f5f5; }
        
        .filter-option.bonus-skill.selected {
            background-color: #ff9800; 
            color: #fff;
            font-weight: 600;
        }

        .filter-option.bonus-teacher.selected {
            background-color: #2196f3; 
            color: #fff;
            font-weight: 600;
        }

        .filter-separator {
            height: 1px;
            background-color: #eee;
            margin: 6px 0;
        }

        /* --- å¤´åƒåŒºåŸŸ --- */
        .top-section {
            height: 220px;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 20px;
        }

        .avatar-container {
            width: 200px;
            height: 200px;
            border-radius: 40px;
            overflow: hidden;
            border: 4px solid #000;
            
            /* --- æ ¸å¿ƒä¿®å¤ï¼šå¸å…¥å¼æ¶ˆå¤±åŠ¨ç”»çš„åŸºç¡€çŠ¶æ€ --- */
            opacity: 0; 
            transform: scale(0) rotate(-45deg); /* æ¶ˆå¤±æ—¶ç¼©æˆ0å¹¶ç•¥å¾®æ—‹è½¬ */
            /* ä½¿ç”¨ elastic è´å¡å°”æ›²çº¿å®ç° Q å¼¹çš„å‡ºç°/æ¶ˆå¤±æ•ˆæœ */
            transition: all 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55); 
            
            cursor: pointer;
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
            position: relative; 
            background-color: #fff; 
            user-select: none;
            -webkit-user-select: none;
        }
        
        /* å­¦ç”Ÿä¸“ç”¨ï¼šåœ†è§’æ¸å˜è¾¹æ¡† + æœ´ç´ èƒŒæ™¯å…‰æ•ˆï¼ˆä½¿ç”¨ä¼ªå…ƒç´ å®ç°ç¯å½¢è¾¹æ¡†ï¼Œä¿æŒåœ†è§’è´´åˆï¼‰ */
        .avatar-container.student-border {
            border: none; /* ç§»é™¤é»˜è®¤å®çº¿è¾¹æ¡† */
            box-shadow: 0 14px 30px rgba(0,0,0,0.08); /* åŸºç¡€é˜´å½±ï¼Œå’Œå…‰æ•ˆå åŠ  */
        }
        .avatar-container.student-border::after {
            content: '';
            position: absolute;
            inset: 0;
            border-radius: inherit;
            pointer-events: none;
            z-index: 2;
            /* ä½¿ç”¨ padding ä¸ mask åˆ¶ä½œç©ºå¿ƒçš„æ¸å˜è¾¹æ¡†ï¼Œå…¼å®¹åœ†è§’ */
            padding: 4px; /* è¾¹æ¡†åšåº¦ */
            background: linear-gradient(135deg, var(--c1, #42a5f5), var(--c2, #7e57c2));
            -webkit-mask:
                linear-gradient(#fff,#fff) content-box,
                linear-gradient(#000,#000);
            -webkit-mask-composite: xor;
            mask-composite: exclude;
        }
        /* è½»å¾®çš„è‰²å½©èƒŒæ™¯å…‰æ•ˆï¼Œä½¿ç”¨å˜é‡ç”ŸæˆåŠé€æ˜æŠ•å½± */
        .avatar-container.student-border.glow {
            box-shadow: 0 18px 40px var(--glow, rgba(0,0,0,0.06));
        }

        /* æ­£å¸¸æ˜¾ç¤ºçŠ¶æ€ */
        .avatar-container.show {
            opacity: 1;
            transform: scale(1) rotate(0deg);
        }

        .avatar-container:hover:not(.no-hover-effect) {
            transform: rotate(15deg) scale(1.1);
            transition: transform 0.4s ease-in-out;
            box-shadow: 0 15px 30px rgba(0,0,0,0.2);
        }
        
        .avatar-container.hide-img .avatar-img {
            display: none;
        }

        /* --- æŠ€èƒ½/è€å¸ˆæ–‡å­—ä¼˜åŒ– --- */
        .non-person-name {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center; 
            font-size: 32px; 
            font-weight: 800;
            color: #fff;
            text-shadow: 0 2px 10px rgba(0,0,0,0.3);
            line-height: 1.3;
            padding: 20px; 
            box-sizing: border-box; 
            word-break: break-word; 
        }
        
        /* èƒŒæ™¯è‰²ç”±åŠ¨ç”»å†³å®šï¼Œè¿™é‡Œåªåšå…œåº• */
        .skill-item .non-person-name { background-color: #ff9800; }
        .teacher-item .non-person-name { background-color: #2196f3; }
        
        /* --- åŠ¨ç”»ç‰¹æ•ˆ (é‡åˆ¶ç‰ˆ) --- */
        
        /* 1. æ™®é€šç¿»è½¬åŠ¨ç”» */
        .avatar-container.card-animate {
            transition: none;
            opacity: 1 !important;
            animation: card-flip 1.8s cubic-bezier(0.68, -0.55, 0.265, 1.55) forwards;
        }
        @keyframes card-flip {
            0% { transform: scale(0.5) rotateY(0deg) rotateZ(-10deg); opacity: 0; }
            40% { transform: scale(1.1) rotateY(360deg) rotateZ(5deg); opacity: 1; }
            70% { transform: scale(1.05) rotateY(720deg) rotateZ(-2deg); }
            100% { transform: scale(1) rotateY(720deg) rotateZ(0deg); opacity: 1; }
        }

        /* 2. Legend åŠ¨ç”»: å²è¯—çº§é‡‘å…‰ç‚¸è£‚ (Qå¼¹ + éœ‡æ’¼) */
        .anim-legend {
            transition: none;
            opacity: 1 !important;
            animation: legend-entry 1.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
            border-color: #ffd700 !important;
            border-width: 6px !important;
        }
        @keyframes legend-entry {
            0% { transform: scale(0) rotate(720deg); opacity: 0; filter: brightness(5); }
            50% { transform: scale(1.3) rotate(-10deg); opacity: 1; filter: brightness(2); box-shadow: 0 0 50px #ffd700, 0 0 100px #ff8c00; }
            60% { transform: scale(0.9) rotate(5deg); box-shadow: 0 0 30px #ffd700; }
            70% { transform: scale(1.1) rotate(-3deg); filter: brightness(1.2); }
            80% { transform: scale(0.95) rotate(2deg); }
            100% { transform: scale(1) rotate(0deg); filter: brightness(1); box-shadow: 0 0 40px rgba(255, 215, 0, 0.6); }
        }

        /* 3. Epic åŠ¨ç”»: ç´«è‰²è™šç©ºèºæ—‹ (ç¥ç§˜ + ä¸æ»‘) */
        .anim-epic {
            transition: none;
            opacity: 1 !important;
            animation: epic-entry 1.4s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
            border-color: #9c27b0 !important;
        }
        @keyframes epic-entry {
            0% { transform: scale(0) translateY(200px); opacity: 0; }
            40% { transform: scale(1.2) translateY(-20px); opacity: 1; box-shadow: 0 0 40px #9c27b0, 0 0 80px #e040fb; }
            60% { transform: scale(0.9) translateY(10px); }
            100% { transform: scale(1) translateY(0); box-shadow: 0 0 25px #9c27b0; }
        }

        /* 4. Rare åŠ¨ç”»: è“è‰²ç§‘æŠ€è„‰å†² (æ¸…çˆ½ + å¿«é€Ÿ) */
        .anim-rare {
            transition: none;
            opacity: 1 !important;
            animation: rare-entry 1.2s cubic-bezier(0.68, -0.55, 0.265, 1.55) forwards;
            border-color: #03a9f4 !important;
        }
        @keyframes rare-entry {
            0% { transform: scale(0.5); opacity: 0; }
            50% { transform: scale(1.15); opacity: 1; box-shadow: 0 0 30px #03a9f4; }
            75% { transform: scale(0.95); }
            100% { transform: scale(1); opacity: 1; box-shadow: 0 0 15px #03a9f4; }
        }

        /* --- æ­ªæ–œ/æ‰é’‰åŠ¨ç”»ï¼ˆç‚¹å‡»å¤´åƒè§¦å‘ï¼‰ --- */
        .avatar-container.tilt-1 {
            transform-origin: top left;
            animation: tilt-1 700ms cubic-bezier(0.22, 1, 0.36, 1) forwards;
        }
        @keyframes tilt-1 {
            0% { transform: rotate(0deg) translate(0,0); }
            60% { transform: rotate(-14deg) translate(-14px, 12px); }
            100% { transform: rotate(-10deg) translate(-10px, 10px); }
        }

        .avatar-container.tilt-2 {
            transform-origin: top right;
            animation: tilt-2 720ms cubic-bezier(0.22, 1, 0.36, 1) forwards;
        }
        @keyframes tilt-2 {
            0% { transform: rotate(0deg) translate(0,0); }
            60% { transform: rotate(12deg) translate(12px, 10px); }
            100% { transform: rotate(8deg) translate(8px, 8px); }
        }

        .avatar-container.tilt-3 {
            transform-origin: center top;
            animation: tilt-3 800ms cubic-bezier(0.22, 1, 0.36, 1) forwards;
        }
        @keyframes tilt-3 {
            0% { transform: rotate(0deg) translate(0,0); }
            50% { transform: rotate(-18deg) translate(-18px, 18px) scale(0.995); }
            100% { transform: rotate(-12deg) translate(-12px, 14px) scale(0.995); }
        }

        /* æ¢å¤åŠ¨ç”»ï¼šä»å½“å‰çŠ¶æ€å¹³æ»‘å›åˆ°é»˜è®¤ */
        .avatar-container.tilt-recover {
            animation: tilt-recover 420ms cubic-bezier(0.22, 1, 0.36, 1) forwards;
        }
        @keyframes tilt-recover {
            to { transform: none; }
        }
        /* ä¸´æ—¶å…³é—­åŠ¨ç”»/è¿‡æ¸¡ï¼Œé¿å…åœ¨æ¢å¤æ—¶é‡æ”¾æŠ½å¡åŠ¨ç”» */
        .avatar-container.no-anim {
            animation: none !important;
            transition: none !important;
        }

        /* æ”¶ç¼©å¹¶æ¸å‡ºï¼ˆå¸å…¥ï¼‰â€”â€”ç”¨äºå¼€å§‹æ–°ä¸€è½®æŠ½å–æ—¶å¹³æ»‘éšè—ä¸Šä¸€ä¸ªå¤´åƒ */
        .avatar-container.shrink-hide {
            transition: transform 0.45s cubic-bezier(0.22, 1, 0.36, 1), opacity 0.45s ease;
            transform: scale(0.12) rotate(-45deg) !important;
            opacity: 0 !important;
        }

        .avatar-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        /* --- ä¸­é—´ï¼šåå­—æ˜¾ç¤º --- */
        .middle-section {
            margin-bottom: 40px;
            text-align: center;
            height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #name-display {
            font-size: 48px;
            font-weight: 800;
            letter-spacing: 1px;
            padding: 10px 40px;
            border-radius: 24px;
            background-color: #f7f7f7;
            border: 2px solid #f0f0f0;
            min-width: 320px;
            overflow: hidden;
            position: relative;
            color: #1a1a1a;
        }

        @keyframes slideOutUp {
            0% { transform: translateY(0); opacity: 1; }
            100% { transform: translateY(-100%); opacity: 0; }
        }
        @keyframes slideInUp {
            0% { transform: translateY(100%); opacity: 0; }
            100% { transform: translateY(0); opacity: 1; }
        }
        .slide-out-up { animation: slideOutUp 0.2s ease-in forwards; }
        .slide-in-up { animation: slideInUp 0.3s ease-out forwards; }

        /* --- åº•éƒ¨æŒ‰é’®åŒºåŸŸ --- */
        .bottom-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 16px;
        }

        button.action-btn {
            background-color: #000;
            color: #fff;
            border: none;
            padding: 16px 48px; 
            font-size: 18px;
            font-weight: 700;
            border-radius: 100px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            outline: none;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }

        button.action-btn:hover {
            background-color: #333;
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.3);
        }

        button.action-btn:active { transform: translateY(0); }
        button.action-btn:disabled {
            background-color: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        /* --- Footer --- */
        .footer {
            width: 100%;
            padding: 12px 0;
            background-color: #fafafa;
            border-top: none;
            text-align: center;
            font-size: 13px;
            color: #888;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 12px;
        }
        .footer-separator { color: #ddd; font-size: 14px; }
        .footer-github a {
            color: #888;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            transition: color 0.3s;
        }
        .footer-github a:hover { color: #000; }
        .github-icon { width: 18px; height: 18px; fill: currentColor; display: block; }

    </style>
</head>
<body>

    <div class="main-content">
        <div class="filter-container">
            <div id="btn-filter" title="ç‚¹å‡»é€‰æ‹©æŠ½å–èŒƒå›´">
                <span id="filter-text">æ‰€æœ‰äºº</span>
                <span style="font-size: 10px; opacity: 0.5;">â–¼</span>
            </div>
            <div class="filter-menu" id="filter-menu">
                <div class="filter-option base-option selected" data-type="group" data-value="æ‰€æœ‰äºº">æ‰€æœ‰äºº</div>
                <div class="filter-option base-option" data-type="group" data-value="ç”Ÿç‰©">ç”Ÿç‰©</div>
                <div class="filter-option base-option" data-type="group" data-value="æ”¿æ²»">æ”¿æ²»</div>
                
                <div class="filter-separator"></div>
                
                <div class="filter-option bonus-option bonus-skill" data-type="bonus" data-value="æŠ€èƒ½">æŠ€èƒ½</div>
                <div class="filter-option bonus-option bonus-teacher" data-type="bonus" data-value="è€å¸ˆ">è€å¸ˆ</div>
            </div>
        </div>
        
        <div class="top-section">
            <div class="avatar-container" id="avatar-box" title="ç‚¹å‡»åˆ‡æ¢æ˜¾ç¤ºçœŸå/ç½‘å">
                <div class="non-person-name" id="non-person-name-display" style="display: none;"></div>
                <img src="" alt="Avatar" class="avatar-img" id="avatar-img">
            </div>
        </div>

        <div class="middle-section">
            <div id="name-display">åˆ«ç´§å¼ </div> 
        </div>

        <div class="bottom-section">
            <button id="btn-main" class="action-btn">å¼€å§‹æ»šåŠ¨</button>
        </div>
    </div>
    
    <div class="footer">
        <span>Copyright Â© Tachibana Kousuke 2025</span>
        <span class="footer-separator">|</span>
        <span class="footer-github">
            <a href="https://github.com/TachibanaKousuke/Lucky-Draw" target="_blank" title="è®¿é—® GitHub ä»“åº“">
                <svg class="github-icon" viewBox="0 0 16 16" version="1.1" aria-hidden="true">
                    <path fill-rule="evenodd" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2h.02c0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"></path>
                </svg>
            </a>
        </span>
    </div>

    <script>
        // --- 1. æ•°æ®é…ç½®åŒºåŸŸ ---
        const database = [
            { nickname: "é’è¡Œå½’", realname: "è‰¾ç‚œæ°", avatarUrl: "https://pic1.imgdb.cn/item/6932846ad1e741a32bf1b9da.jpg", subject: "æ”¿æ²»" },
            { nickname: "Tiamo", realname: "è‰¾æ–‡åš", avatarUrl: "https://pic1.imgdb.cn/item/6932846ad1e741a32bf1b9dc.jpg", subject: "ç”Ÿç‰©" },
            { nickname: "blue IHrNm", realname: "æ›¹ç‘¾ç‘œ", avatarUrl: "https://pic1.imgdb.cn/item/6932846ad1e741a32bf1b9db.jpg", subject: "æ”¿æ²»" },
            { nickname: "é™³é£", realname: "é™ˆæ—éœ„", avatarUrl: "https://pic1.imgdb.cn/item/6932846ad1e741a32bf1b9dd.jpg", subject: "ç”Ÿç‰©" },
            { nickname: "ç”°ç”°å°å½±å­", realname: "é™ˆèå½±", avatarUrl: "https://pic1.imgdb.cn/item/6932846ad1e741a32bf1b9d9.jpg", subject: "æ”¿æ²»" },
            { nickname: "CzX", realname: "é™ˆåœ¨èŠ¯", avatarUrl: "https://pic1.imgdb.cn/item/69328473d1e741a32bf1b9eb.jpg", subject: "ç”Ÿç‰©" },
            { nickname: "ğŸ¤", realname: "ç¨‹æ©æ³½", avatarUrl: "https://pic1.imgdb.cn/item/69328473d1e741a32bf1b9ec.jpg", subject: "ç”Ÿç‰©" },
            { nickname: "Il sole.", realname: "é‚“æ·¼", avatarUrl: "https://pic1.imgdb.cn/item/69328473d1e741a32bf1b9ed.jpg", subject: "ç”Ÿç‰©" },
            { nickname: "pit pony", realname: "é‚“è§æ™“", avatarUrl: "https://pic1.imgdb.cn/item/69328473d1e741a32bf1b9ee.jpg", subject: "ç”Ÿç‰©" },
            { nickname: "ç™½ç‹—é»‘", realname: "å†¯éº’éœ", avatarUrl: "https://pic1.imgdb.cn/item/69328435d1e741a32bf1b991.jpg", subject: "æ”¿æ²»" },
            { nickname: "é«˜å†·äººå£«æ²¡æœ‰å¾®ä¿¡", realname: "é«˜æ¶µäºˆ", avatarUrl: "https://api.dicebear.com/7.x/identicon/svg?seed=Felix", subject: "ç”Ÿç‰©" },
            { nickname: "æ³±æ³±æ¸…æ½­", realname: "é«˜ä¸€æ·³", avatarUrl: "https://pic1.imgdb.cn/item/69328477d1e741a32bf1b9f6.jpg", subject: "ç”Ÿç‰©" },
            { nickname: "èåœä¸æ¯”å°”", realname: "è¾œå­™é›¨è¾°", avatarUrl: "https://pic1.imgdb.cn/item/69328477d1e741a32bf1b9f9.jpg", subject: "æ”¿æ²»" },
            { nickname: "æ¬§çš‡çŸ¥åº•", realname: "ä½•å¥•å˜‰", avatarUrl: "https://pic1.imgdb.cn/item/69328436d1e741a32bf1b993.jpg", subject: "ç”Ÿç‰©" },
            { nickname: "åƒ", realname: "éŸ©é“­æ°", avatarUrl: "https://pic1.imgdb.cn/item/69328477d1e741a32bf1b9f7.jpg", subject: "ç”Ÿç‰©" },
            { nickname: "æ­¥æ³•é¹…", realname: "è¡¡æ˜Ÿç™", avatarUrl: "https://pic1.imgdb.cn/item/69328477d1e741a32bf1b9f5.jpg", subject: "ç”Ÿç‰©" },
            { nickname: "PhuDgue", realname: "èƒ¡é“¸", avatarUrl: "https://pic1.imgdb.cn/item/6932847ed1e741a32bf1ba05.jpg", subject: "ç”Ÿç‰©" },
            { nickname: "é»„å°å¦¹", realname: "é»„å½¦æ´", avatarUrl: "https://pic1.imgdb.cn/item/6932847ed1e741a32bf1ba02.jpg", subject: "ç”Ÿç‰©" },
            { nickname: "æ— æ™.", realname: "æå®‰ç„¶", avatarUrl: "https://pic1.imgdb.cn/item/6932847ed1e741a32bf1ba01.jpg", subject: "ç”Ÿç‰©" },
            { nickname: "Touma Kazusa", realname: "ææŸ¯é”¦", avatarUrl: "https://pic1.imgdb.cn/item/6932847ed1e741a32bf1ba03.jpg", subject: "ç”Ÿç‰©" },
            { nickname: "Camilla", realname: "ææ—è”š", avatarUrl: "https://pic1.imgdb.cn/item/6932847ed1e741a32bf1ba04.jpg", subject: "ç”Ÿç‰©" },
            { nickname: "Eschatology", realname: "å»–å®¶å˜‰", avatarUrl: "https://pic1.imgdb.cn/item/69328489d1e741a32bf1ba10.jpg", subject: "ç”Ÿç‰©" },
            { nickname: "æœ‰æ‚ ", realname: "å»–è½©æµ©", avatarUrl: "https://pic1.imgdb.cn/item/69328489d1e741a32bf1ba12.jpg", subject: "æ”¿æ²»" },
            { nickname: "åˆ˜è½©", realname: "åˆ˜è½©", avatarUrl: "https://pic1.imgdb.cn/item/69328435d1e741a32bf1b98d.jpg", subject: "æ”¿æ²»" },
            { nickname: "è½©ğŸƒğŸ€", realname: "å•å­è½©", avatarUrl: "https://pic1.imgdb.cn/item/69328435d1e741a32bf1b992.jpg", subject: "ç”Ÿç‰©" },
            { nickname: "æ½æ˜Ÿæ²³", realname: "é©¬æ˜Ÿç¿", avatarUrl: "https://pic1.imgdb.cn/item/69328489d1e741a32bf1ba11.jpg", subject: "ç”Ÿç‰©" },
            { nickname: "å°å¤©æ‰æå®", realname: "å½­æ¸ä¸­", avatarUrl: "https://pic1.imgdb.cn/item/6932848fd1e741a32bf1ba1a.jpg", subject: "æ”¿æ²»" },
            { nickname: "æˆ‘åˆä¸æ˜¯è‹¦åŠ›", realname: "å”è±è”š", avatarUrl: "https://pic1.imgdb.cn/item/693286fdd1e741a32bf1bd63.jpg", subject: "ç”Ÿç‰©" },
            { nickname: "å°ç‹åœ¨æ­¤åˆ»", realname: "ç‹çˆ±é˜³", avatarUrl: "https://pic1.imgdb.cn/item/6932848fd1e741a32bf1ba1b.jpg", subject: "æ”¿æ²»" },
            { nickname: "æ¶µ", realname: "ç‹ä¹™æ¶µ", avatarUrl: "https://pic1.imgdb.cn/item/6932848fd1e741a32bf1ba19.jpg", subject: "ç”Ÿç‰©" },
            { nickname: "ä¸€åŒ—æå…‰", realname: "ç‹æ‡¿", avatarUrl: "https://pic1.imgdb.cn/item/6932848fd1e741a32bf1ba1c.jpg", subject: "ç”Ÿç‰©" },
            { nickname: "q7l12", realname: "ç‹é¢–è±", avatarUrl: "https://pic1.imgdb.cn/item/6932848fd1e741a32bf1ba1d.jpg", subject: "ç”Ÿç‰©" },
            { nickname: "Hello", realname: "ç‹èµæ°", avatarUrl: "https://pic1.imgdb.cn/item/69328494d1e741a32bf1ba23.jpg", subject: "ç”Ÿç‰©" },
            { nickname: "Tachibana Kousuke", realname: "éŸ¦æ™¯çš“", avatarUrl: "https://pic1.imgdb.cn/item/69328494d1e741a32bf1ba21.jpg", subject: "ç”Ÿç‰©" },
            { nickname: "Anonymous", realname: "é­ç†™èŠ®", avatarUrl: "https://pic1.imgdb.cn/item/69328494d1e741a32bf1ba25.jpg", subject: "ç”Ÿç‰©" },
            { nickname: "æ–‡ä¸‰", realname: "æ–‡æ€ç¿", avatarUrl: "https://pic1.imgdb.cn/item/69328494d1e741a32bf1ba22.jpg", subject: "ç”Ÿç‰©" },
            { nickname: "WCSDM", realname: "å´å‘ç‰", avatarUrl: "https://pic1.imgdb.cn/item/69328435d1e741a32bf1b98f.jpg", subject: "ç”Ÿç‰©" },
            { nickname: "è¥¿ç“œåˆ¨å†°", realname: "é²œå“å½¤", avatarUrl: "https://pic1.imgdb.cn/item/69328499d1e741a32bf1ba29.jpg", subject: "æ”¿æ²»" },
            { nickname: "æƒŸæ¥šæœ‰æ‰", realname: "å¾æ¥šçƒ¦", avatarUrl: "https://pic1.imgdb.cn/item/69328499d1e741a32bf1ba2b.jpg", subject: "ç”Ÿç‰©" },
            { nickname: "ç»­å™åº", realname: "å¾å­æ’", avatarUrl: "https://pic1.imgdb.cn/item/69328499d1e741a32bf1ba2c.jpg", subject: "æ”¿æ²»" },
            { nickname: "æ—‹è½¬â„ƒçš„æ—¶å…‰", realname: "æ¨æˆå®‡", avatarUrl: "https://pic1.imgdb.cn/item/69328499d1e741a32bf1ba2a.jpg", subject: "ç”Ÿç‰©" },
            { nickname: "Nernst", realname: "æ¨è‹¥é›·", avatarUrl: "https://pic1.imgdb.cn/item/69328499d1e741a32bf1ba2d.jpg", subject: "ç”Ÿç‰©" },
            { nickname: "é¼ äº†", realname: "æ¨å®£æµ©", avatarUrl: "https://pic1.imgdb.cn/item/6932849cd1e741a32bf1ba31.jpg", subject: "æ”¿æ²»" },
            { nickname: "é›é¸£", realname: "æ¨æ‡¿", avatarUrl: "https://pic1.imgdb.cn/item/6932849cd1e741a32bf1ba34.jpg", subject: "ç”Ÿç‰©" },
            { nickname: "Ray", realname: "å¼ æ·™ç¿", avatarUrl: "https://pic1.imgdb.cn/item/6932849cd1e741a32bf1ba32.jpg", subject: "ç”Ÿç‰©" },
            { nickname: "ä¸è¡€åè™¾é—°åœŸçš„çŒ¹", realname: "å¼ æ¢“è½©", avatarUrl: "https://pic1.imgdb.cn/item/6932849cd1e741a32bf1ba35.jpg", subject: "ç”Ÿç‰©" },
            { nickname: "AQ", realname: "èµµæ½œ", avatarUrl: "https://pic1.imgdb.cn/item/6932849cd1e741a32bf1ba33.jpg", subject: "æ”¿æ²»" },
            { nickname: "(ï¼ï¼œ)", realname: "èµµç§‹ç‰", avatarUrl: "https://pic1.imgdb.cn/item/693284a1d1e741a32bf1ba3a.jpg", subject: "ç”Ÿç‰©" },
            { nickname: "Zfang", realname: "éƒ‘æ”¾", avatarUrl: "https://pic1.imgdb.cn/item/693284a1d1e741a32bf1ba3c.jpg", subject: "ç”Ÿç‰©" },
            { nickname: "Emmanuel", realname: "å‘¨æŸ¯è¿", avatarUrl: "https://pic1.imgdb.cn/item/69328435d1e741a32bf1b98e.jpg", subject: "ç”Ÿç‰©" },
            { nickname: "y", realname: "é‚¹å¤©æ°", avatarUrl: "https://pic1.imgdb.cn/item/693284a1d1e741a32bf1ba3b.jpg", subject: "ç”Ÿç‰©" },
            { nickname: "LZZN", realname: "åˆ˜çŸ¥æ˜“", avatarUrl: "https://pic1.imgdb.cn/item/693d6d7ffe7cfeca3822ee6f.jpg", subject: "ç”Ÿç‰©" },
        ];
        
        const SKILLS = [
            { type: "skill", nickname: "ä¸‡ç®­é½å‘", realname: "ä¸‡ç®­é½å‘", avatarUrl: "", isSpecial: true, rarity: 'legend', className: 'skill-item' },
            { type: "skill", nickname: "é“ç´¢è¿ç¯", realname: "é“ç´¢è¿ç¯", avatarUrl: "", isSpecial: true, rarity: 'epic', className: 'skill-item' },
            { type: "skill", nickname: "å€Ÿåˆ€æ€äºº", realname: "å€Ÿåˆ€æ€äºº", avatarUrl: "", isSpecial: true, rarity: 'epic', className: 'skill-item' },
            { type: "skill", nickname: "æ¡ƒå›­ç»“ä¹‰", realname: "æ¡ƒå›­ç»“ä¹‰", avatarUrl: "", isSpecial: true, rarity: 'rare', className: 'skill-item' },
            { type: "skill", nickname: "ç«çˆ†è¾£æ¤’", realname: "ç«çˆ†è¾£æ¤’", avatarUrl: "", isSpecial: true, rarity: 'rare', className: 'skill-item' },
            { type: "skill", nickname: "ä¸‹ä¸ªåŒå€", realname: "ä¸‹ä¸ªåŒå€", avatarUrl: "", isSpecial: true, rarity: 'legend', className: 'skill-item' },
        ];
        
        const TEACHERS = [
            { type: "teacher", nickname: "é‡‘æµª", realname: "é‡‘æµª", avatarUrl: "", isSpecial: true, rarity: 'legend', className: 'teacher-item' },
            { type: "teacher", nickname: "åˆ˜å·", realname: "åˆ˜å·", avatarUrl: "", isSpecial: true, rarity: 'legend', className: 'teacher-item' },
            { type: "teacher", nickname: "åˆ˜è¶…", realname: "åˆ˜è¶…", avatarUrl: "", isSpecial: true, rarity: 'legend', className: 'teacher-item' },
            { type: "teacher", nickname: "ç‹ç›¼", realname: "ç‹ç›¼", avatarUrl: "", isSpecial: true, rarity: 'epic', className: 'teacher-item' },
            { type: "teacher", nickname: "è¦ƒå‹¤", realname: "è¦ƒå‹¤", avatarUrl: "", isSpecial: true, rarity: 'epic', className: 'teacher-item' },
            { type: "teacher", nickname: "éŸ¦å»ºå†›", realname: "éŸ¦å»ºå†›", avatarUrl: "", isSpecial: true, rarity: 'rare', className: 'teacher-item' },
            { type: "teacher", nickname: "ç‹ä¿Šä¸œ", realname: "ç‹ä¿Šä¸œ", avatarUrl: "", isSpecial: true, rarity: 'rare', className: 'teacher-item' },
        ];

        // å­¦ç”Ÿè¾¹æ¡†å¤‡é€‰é¢œè‰²å¯¹ï¼ˆæ¸å˜èµ·æ­¢è‰²ï¼‰ï¼Œå®¡ç¾ä¼˜å…ˆï¼Œå– 10 ç»„
        const STUDENT_BORDER_PAIRS = [
            ['#ff8a65', '#ff7043'],
            ['#42a5f5', '#7e57c2'],
            ['#26a69a', '#66bb6a'],
            ['#ffb74d', '#ff8a65'],
            ['#29b6f6', '#26c6da'],
            ['#ab47bc', '#8e24aa'],
            ['#7e57c2', '#5c6bc0'],
            ['#ef5350', '#ec407a'],
            ['#66bb6a', '#9ccc65'],
            ['#ffd54f', '#ffb74d']
        ];

        function hexToRgba(hex, alpha) {
            if (!hex) return `rgba(0,0,0,${alpha})`;
            const h = hex.replace('#', '');
            const bigint = parseInt(h, 16);
            const r = (bigint >> 16) & 255;
            const g = (bigint >> 8) & 255;
            const b = bigint & 255;
            return `rgba(${r}, ${g}, ${b}, ${alpha})`;
        }

        // åº”ç”¨å­¦ç”Ÿåœ†è§’æ¸å˜è¾¹æ¡†ï¼ˆä½¿ç”¨ CSS å˜é‡ä¸ .student-border ä¼ªå…ƒç´ ï¼‰
        function applyStudentBorder(el) {
            const pair = STUDENT_BORDER_PAIRS[Math.floor(Math.random() * STUDENT_BORDER_PAIRS.length)];
            const c1 = pair[0];
            const c2 = pair[1];
            el.style.setProperty('--c1', c1);
            el.style.setProperty('--c2', c2);
            // æœ´ç´  glow ä½¿ç”¨æ¸å˜ç»ˆè‰²çš„åŠé€æ˜ä½œä¸ºæŠ•å½±é¢œè‰²
            const glow = hexToRgba(c2, 0.16);
            el.style.setProperty('--glow', glow);
            el.classList.add('student-border', 'glow');
        }

        function clearStudentBorder(el) {
            el.classList.remove('student-border', 'glow');
            el.style.removeProperty('--c1');
            el.style.removeProperty('--c2');
            el.style.removeProperty('--glow');
            // æ¢å¤é»˜è®¤è¾¹æ¡†ç”± CSS ç®¡æ§ï¼ˆ.avatar-container æœ‰é»˜è®¤ border æ ·å¼ï¼‰
        }

        const startPhrases = [
            "è®©æˆ‘çœ‹çœ‹è°åœ¨ç´§å¼ ", "æ˜¯è°çš„å°é¹¿åœ¨ä¹±æ’", "æ·±å‘¼å¸ï¼Œå¤´æ™•æ˜¯æ­£å¸¸çš„",
            "åˆ«èº²äº†ï¼Œæˆ‘éƒ½çœ‹åˆ°ä½ äº†", "æ­¤æ—¶ä¸€åå¹¸è¿è§‚ä¼—æ±—æµæµƒèƒŒ", "å‘½è¿çš„é½¿è½®å¼€å§‹è½¬åŠ¨",
            "åªæ˜¯æŠ½ä¸ªæŸ¥ï¼Œåˆ«æ…Œ", "çœ¼ç¥åˆ«é£˜ï¼Œçœ‹ç€æˆ‘", "å‡†å¤‡å¥½ä½ çš„è¡¨æ¼”äº†å—", "è®©æˆ‘åº·åº·æ˜¯è°è¿™ä¹ˆå¹¸è¿"
        ];
        
        // --- 2. å˜é‡å®šä¹‰ ---
        const nameDisplay = document.getElementById('name-display');
        const btnMain = document.getElementById('btn-main');
        const avatarBox = document.getElementById('avatar-box');
        const avatarImg = document.getElementById('avatar-img');
        const nonPersonNameDisplay = document.getElementById('non-person-name-display');
        const btnFilter = document.getElementById('btn-filter');
        const filterText = document.getElementById('filter-text');
        const filterMenu = document.getElementById('filter-menu');
        
        const baseOptions = document.querySelectorAll('.filter-option.base-option');
        const bonusOptions = document.querySelectorAll('.filter-option.bonus-option');

        let isRolling = false;
        let timer = null;
        let selectedUser = null; 
        let isRealNameShowing = false; 
        
        let currentGroup = 'æ‰€æœ‰äºº'; 
        let activeBonuses = [];      

        let filteredDatabase = []; 
        let shuffleIndex = 0; 
        let shuffledList = []; 
        
        let nextSelectedUser = null;

        // --- 3. æ ¸å¿ƒåŠŸèƒ½å‡½æ•° ---

        function filterAndShuffleDatabase() {
            let studentList;
            if (currentGroup === 'æ‰€æœ‰äºº') {
                studentList = [...database];
            } else {
                studentList = database.filter(user => user.subject === currentGroup);
            }

            let specialItems = [];
            if (activeBonuses.includes('æŠ€èƒ½')) {
                specialItems = specialItems.concat(SKILLS);
            }
            if (activeBonuses.includes('è€å¸ˆ')) {
                specialItems = specialItems.concat(TEACHERS);
            }
            
            if (studentList.length === 0 && specialItems.length > 0) {
                 filteredDatabase = specialItems;
            } else if (studentList.length > 0) {
                filteredDatabase = studentList.concat(specialItems);
            } else {
                filteredDatabase = [];
            }
            
            if (filteredDatabase.length === 0) {
                nameDisplay.innerText = `æ— æ•°æ® (${currentGroup})`;
                btnMain.disabled = true;
                return false;
            }
            
            btnMain.disabled = false;
            
            shuffledList = [...filteredDatabase]; 
            for (let i = shuffledList.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1)); 
                [shuffledList[i], shuffledList[j]] = [shuffledList[j], shuffledList[i]];
            }
            
            shuffleIndex = 0;
            return true;
        }

        function getNextShuffledItem() {
            if (shuffleIndex >= shuffledList.length) {
                if (!filterAndShuffleDatabase()) {
                    return null;
                }
                console.log("åˆ—è¡¨å·²æŠ½å®Œï¼Œé‡æ–°æ´—ç‰Œã€‚");
            }
            const item = shuffledList[shuffleIndex];
            shuffleIndex++; 
            return item;
        }
        
        function prepareNextDraw() {
            nextSelectedUser = getNextShuffledItem();
            if (nextSelectedUser && nextSelectedUser.avatarUrl && nextSelectedUser.avatarUrl !== "") {
                const img = new Image();
                img.src = nextSelectedUser.avatarUrl;
            }
        }
        
        function startRolling() {
            if (isRolling) return; 
            
            // å¼€å§‹å‰ï¼Œæ¸…é™¤æ‰€æœ‰ç‰¹æ®ŠåŠ¨ç”»ç±»
            avatarBox.classList.remove('anim-legend', 'anim-epic', 'anim-rare', 'card-animate', 'special-draw-effect');
            // æ¸…ç†ä»»ä½•ä¹‹å‰é€šè¿‡ JS è®¾ç½®çš„è‡ªå®šä¹‰æ ·å¼ï¼ˆè¾¹æ¡†/å…‰æ•ˆï¼‰
            clearStudentBorder(avatarBox);
            // ç¡®ä¿åŠ¨ç”»å·²å¯ç”¨ï¼Œç„¶åè§¦å‘æ”¶ç¼©å¸å…¥éšè—ä¸Šä¸€ä¸ªå¤´åƒ
            triggerShrinkHide();
            btnMain.disabled = true;

            // ç­‰å¾…æ¶ˆå¤±åŠ¨ç”»(500ms)çš„ä¸€åŠå·¦å³å¼€å§‹æ•°æ®æ»šåŠ¨
            setTimeout(() => {
                if (!nextSelectedUser && !filterAndShuffleDatabase()) {
                    btnMain.disabled = false;
                    return; 
                }
                if (!nextSelectedUser) {
                    prepareNextDraw();
                    if(!nextSelectedUser) return;
                }
                doStartRollLogic();
            }, 300);
        }
        
        function doStartRollLogic() {
            isRolling = true;
            btnMain.disabled = true; 
            btnMain.innerText = "æŠ½å–";
            
            // ç¡®ä¿å®¹å™¨æ­¤æ—¶æ˜¯éšè—çš„
            avatarBox.classList.remove('show'); 
            
            // é‡ç½®çŠ¶æ€
            nameDisplay.classList.remove('slide-out-up', 'slide-in-up');
            isRealNameShowing = false; 
            nameDisplay.style.backgroundColor = "#f7f7f7";
            nameDisplay.style.borderColor = "#f0f0f0";

            timer = setInterval(() => {
                const randomIndex = Math.floor(Math.random() * filteredDatabase.length);
                nameDisplay.innerText = filteredDatabase[randomIndex].nickname;
            }, 50); 
            
            setTimeout(() => {
                if (isRolling) { 
                    btnMain.disabled = false;
                }
            }, 300); 
        }

        function stopRolling() {
            if (!isRolling) return; 
            
            isRolling = false;
            btnMain.disabled = true; 
            btnMain.innerText = "å¼€å§‹æ»šåŠ¨";
            clearInterval(timer);

            selectedUser = nextSelectedUser;
            prepareNextDraw(); 
            
            if (!selectedUser) return; 

            nameDisplay.innerText = selectedUser.nickname;

            const isSpecialItem = selectedUser.isSpecial;
            const hasAvatar = selectedUser.avatarUrl && selectedUser.avatarUrl !== "";
            const rarity = selectedUser.rarity || 'rare'; 

            // é‡ç½®åŸºç¡€ç±»
            avatarBox.className = 'avatar-container'; 
            // é»˜è®¤æ¸…ç†ä¹‹å‰çš„ JS æ ·å¼ï¼ˆç‰¹æ®Šç‰©å“ä¼šä½¿ç”¨ CSS è¦†ç›–ï¼‰
            clearStudentBorder(avatarBox);

            // å†³å®šæ˜¾ç¤ºå†…å®¹
            if (isSpecialItem && !hasAvatar) {
                // ç‰¹æ®Šç‰©å“æ— å¤´åƒ -> çº¯æ–‡å­—
                avatarBox.classList.add('hide-img', selectedUser.className || 'skill-item');
                avatarBox.classList.add('no-hover-effect');
                nonPersonNameDisplay.innerText = selectedUser.nickname;
                nonPersonNameDisplay.style.display = 'flex'; 
                avatarImg.style.display = 'none';
            } else {
                // å­¦ç”Ÿ æˆ– æœ‰å¤´åƒçš„è€å¸ˆ -> å›¾ç‰‡
                avatarImg.src = selectedUser.avatarUrl;
                avatarImg.style.display = 'block'; 
                nonPersonNameDisplay.style.display = 'none';
                avatarBox.classList.remove('hide-img', 'skill-item', 'teacher-item', 'no-hover-effect');
            }

            // åº”ç”¨åŠ¨ç”»ç±»
            let animClass = 'card-animate'; // é»˜è®¤å­¦ç”Ÿ
            if (isSpecialItem) {
                if (rarity === 'legend') animClass = 'anim-legend';
                else if (rarity === 'epic') animClass = 'anim-epic';
                else animClass = 'anim-rare';
            }
            // å­¦ç”Ÿï¼ˆéç‰¹æ®Šï¼‰éœ€éšæœºæ¸å˜è¾¹æ¡† + æœ´ç´ å…‰æ•ˆ
            if (!isSpecialItem) {
                applyStudentBorder(avatarBox);
            } else {
                // ç‰¹æ®Šç‰©å“ä½¿ç”¨ CSS æ ·å¼ï¼Œè¿™é‡Œæ¸…ç†æ‰ JS æ ·å¼ï¼Œä¿è¯ CSS !important ç”Ÿæ•ˆ
                clearStudentBorder(avatarBox);
            }

            // å¼ºåˆ¶é‡ç»˜å¹¶æ·»åŠ åŠ¨ç”»ç±»
            void avatarBox.offsetWidth;
            avatarBox.classList.add(animClass);

            // åŠ¨ç”»æ—¶é•¿æ§åˆ¶
            // Legend/Epic ç¨å¾®é•¿ä¸€ç‚¹
            const animationDuration = isSpecialItem ? 1300 : 1800;
            
            // åŠ¨ç”»ç»“æŸï¼Œä¿æŒæœ€ç»ˆçŠ¶æ€
            setTimeout(() => {
                avatarBox.classList.add('show'); 
                btnMain.disabled = false;
            }, animationDuration);
        }

        function toggleRealName() {
            if (!selectedUser) return;
            // è€å¸ˆ/æŠ€èƒ½ å…è®¸åˆ‡æ¢åå­—ï¼Œä½†é€šå¸¸ä»–ä»¬çœŸå=ç½‘åï¼Œé€»è¾‘ä¸Šå…¼å®¹
            
            nameDisplay.classList.remove('slide-in-up', 'slide-out-up');
            void nameDisplay.offsetWidth; // å¼ºåˆ¶å›æµ
            
            nameDisplay.classList.add('slide-out-up');

            setTimeout(() => {
                isRealNameShowing = !isRealNameShowing;
                
                if (isRealNameShowing) {
                    nameDisplay.innerText = selectedUser.realname;
                    // åªæœ‰çœŸåå˜è‰²
                    nameDisplay.style.backgroundColor = "#f7f7f7"; 
                    nameDisplay.style.borderColor = "#f0f0f0";
                } else {
                    nameDisplay.innerText = selectedUser.nickname;
                    nameDisplay.style.backgroundColor = "#f7f7f7";
                    nameDisplay.style.borderColor = "#f0f0f0";
                }
                
                nameDisplay.classList.remove('slide-out-up');
                nameDisplay.classList.add('slide-in-up');
            }, 200);
        }

        function updateFilterButtonText() {
            let text = currentGroup;
            if (activeBonuses.length > 0) {
                text += ` + ${activeBonuses.join('/')}`;
            }
            filterText.innerText = text;
        }

        // --- 4. äº‹ä»¶ç›‘å¬å™¨ ---

        // Helper: reliably perform shrink-hide animation starting from visible state
        function triggerShrinkHide() {
            // Ensure animations can run, and remove any active draw-related animation classes
            avatarBox.classList.remove('no-anim');
            ['card-animate', 'anim-legend', 'anim-epic', 'anim-rare', 'special-draw-effect'].forEach(c => avatarBox.classList.remove(c));
            // Also clear any inline animation/transition to avoid conflicts
            avatarBox.style.animation = '';
            avatarBox.style.transition = '';

            // Ensure computed state is visible so transition animates from visible -> shrink
            avatarBox.classList.add('show');
            // Force style flush
            void avatarBox.offsetWidth;
            // Add class that transitions to small+fade
            avatarBox.classList.add('shrink-hide');
            // Ensure after animation it is no longer marked show
            setTimeout(() => {
                avatarBox.classList.remove('show');
                avatarBox.classList.remove('shrink-hide');
            }, 520);
        }

        btnMain.addEventListener('click', () => {
            if (isRolling) stopRolling();
            else startRolling();
        });

        // ç‚¹å‡»å¤´åƒï¼šå§‹ç»ˆåˆ‡æ¢åå­—ï¼›å¦‚æœå½“å‰æ­ªæ–œåˆ™åŒæ—¶æ¢å¤ï¼Œå¦åˆ™æ–½åŠ éšæœºæ­ªæ–œ
        avatarBox.addEventListener('click', (e) => {
            e.stopPropagation();
            // å§‹ç»ˆåˆ‡æ¢åå­—
            toggleRealName();
            // è‹¥å·²æ­ªæ–œ -> æ¢å¤ï¼›å¦åˆ™æ–½åŠ éšæœºæ­ªæ–œ
            if (isTilted()) {
                restoreTilt();
            } else {
                applyRandomTilt();
            }
        });

        // è¿‡æ»¤å™¨é€»è¾‘
        btnFilter.addEventListener('click', (e) => {
            e.stopPropagation(); 
            filterMenu.classList.toggle('open');
            btnFilter.classList.toggle('active');
        });

        // å…¨å±€ç‚¹å‡»å…³é—­èœå•
        document.addEventListener('click', (e) => {
            if (!btnFilter.contains(e.target) && filterMenu.classList.contains('open')) {
                filterMenu.classList.remove('open');
                btnFilter.classList.remove('active');
            }
        });
        
        filterMenu.addEventListener('click', (e) => {
             e.stopPropagation();
        });

        // ç‚¹å‡»ç©ºç™½å¤„æ—¶è‹¥å®¹å™¨å¤„äºæ­ªæ–œçŠ¶æ€åˆ™æ¢å¤ï¼ˆå¹¶åŒæ—¶å…³é—­ filter èœå•ï¼‰
        document.addEventListener('click', (e) => {
            if (!btnFilter.contains(e.target) && filterMenu.classList.contains('open')) {
                filterMenu.classList.remove('open');
                btnFilter.classList.remove('active');
            }
            if (!avatarBox.contains(e.target) && isTilted()) {
                restoreTilt();
            }
        });

        // pointerdown ç‰ˆæœ¬ï¼šæ›´æ—©å“åº”ï¼Œä»¥é˜²æŸäº›ç¯å¢ƒä¸‹ click è¢«é˜»å¡æˆ–å»¶è¿Ÿ
        document.addEventListener('pointerdown', (e) => {
            if (!avatarBox.contains(e.target) && isTilted()) {
                restoreTilt();
            }
        });

        // é€‰é¡¹ç‚¹å‡»é€»è¾‘
        function handleFilterChange() {
            // 1. ä½¿ç”¨æ”¶ç¼©å¸å…¥åŠ¨ç”»éšè—å½“å‰å¤´åƒï¼ˆä¸ startRolling è¡Œä¸ºä¸€è‡´ï¼‰
            triggerShrinkHide();

            // 2. ç­‰å¾…æ¶ˆå¤±åŠ¨ç”»ç»“æŸåæ›´æ–°æ•°æ®
            setTimeout(() => {
                updateFilterButtonText();
                filterAndShuffleDatabase();
                prepareNextDraw();
                nameDisplay.innerText = startPhrases[Math.floor(Math.random() * startPhrases.length)];
                // æ­¤æ—¶ avatarBox ä¾ç„¶æ˜¯éšè—çš„(opacity:0)ï¼Œç­‰å¾…ä¸‹æ¬¡æŠ½å–æ˜¾ç¤º
            }, 500); // åŒ¹é… CSS transition 0.5s
        }

        baseOptions.forEach(option => {
            option.addEventListener('click', () => {
                const newGroup = option.dataset.value;
                if (currentGroup !== newGroup) {
                    baseOptions.forEach(o => o.classList.remove('selected'));
                    option.classList.add('selected');
                    currentGroup = newGroup;
                    handleFilterChange();
                }
                filterMenu.classList.remove('open');
                btnFilter.classList.remove('active');
            });
        });

        bonusOptions.forEach(option => {
            option.addEventListener('click', () => {
                option.classList.toggle('selected');
                const bonusValue = option.dataset.value;
                
                if (option.classList.contains('selected')) {
                    if (!activeBonuses.includes(bonusValue)) activeBonuses.push(bonusValue);
                } else {
                    activeBonuses = activeBonuses.filter(b => b !== bonusValue);
                }
                handleFilterChange();
            });
        });

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            filterAndShuffleDatabase();
            prepareNextDraw();
            updateFilterButtonText();
            nameDisplay.innerText = startPhrases[Math.floor(Math.random() * startPhrases.length)];
            // åˆå§‹çŠ¶æ€ï¼šå¤´åƒæ¡†éšè—ï¼Œç­‰å¾…æŠ½å–
        });

        // --- æ­ªæ–œï¼ˆæ‰é’‰ï¼‰æ§åˆ¶å‡½æ•° ---
        function isTilted() {
            return avatarBox.classList.contains('tilt-1') || avatarBox.classList.contains('tilt-2') || avatarBox.classList.contains('tilt-3');
        }

        function applyRandomTilt() {
            // å…ˆç§»é™¤æ¢å¤ç±»ï¼Œé˜²æ­¢å†²çª
            avatarBox.classList.remove('tilt-recover');
            const idx = Math.floor(Math.random() * 3) + 1;
            avatarBox.classList.remove('tilt-1', 'tilt-2', 'tilt-3');
            avatarBox.classList.add(`tilt-${idx}`);
        }

        function restoreTilt() {
            if (!isTilted()) return;
            // ç§»é™¤å¯èƒ½ä¼šå¯¼è‡´æ¢å¤æ—¶é‡æ”¾çš„æŠ½å¡åŠ¨ç”»ç±»ï¼ˆä¿è¯æ¢å¤æ—¶ä¿æŒé™æ­¢ï¼‰
            const animClasses = ['card-animate', 'anim-legend', 'anim-epic', 'anim-rare', 'special-draw-effect'];
            animClasses.forEach(c => avatarBox.classList.remove(c));

            // ç§»é™¤ tilt çŠ¶æ€å¹¶æ·»åŠ æ¢å¤åŠ¨ç”»ç±»ï¼Œå¹³æ»‘å›åˆ°åŸä½
            avatarBox.classList.remove('tilt-1', 'tilt-2', 'tilt-3');
            // è§¦å‘æ¢å¤åŠ¨ç”»
            avatarBox.classList.remove('tilt-recover');
            // å¼ºåˆ¶å›æµï¼Œç¡®ä¿åŠ¨ç”»å¯ä»¥é‡æ–°è§¦å‘
            void avatarBox.offsetWidth;
            avatarBox.classList.add('tilt-recover');

            function onEnd(e) {
                if (e.animationName === 'tilt-recover') {
                    avatarBox.classList.remove('tilt-recover');
                    avatarBox.removeEventListener('animationend', onEnd);
                }
            }
            avatarBox.addEventListener('animationend', onEnd);
        }

    </script>
</body>
</html>
